<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± √Ån M√πa H√® Xanh: V≈© Tr·ª• M√¥ Ph·ªèng AI</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        /* GIAO DI·ªÜN EXECUTIVE SANG TR·ªåNG (GI·ªÆ NGUY√äN) */
        :root {
            --bg-body: #121212; --bg-card: rgba(30, 30, 30, 0.9);
            --border-gold: #D4AF37; --text-main: #E0E0E0;
            --text-muted: #A0A0A0; --btn-bg: #2A2A2A;
            --btn-hover: #3A3A3A; --danger: #FF5252;
            --success: #4CAF50; --warning: #FFC107;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            color: var(--text-main); display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; padding: 20px; background-attachment: fixed;
        }
        #game-container {
            background-color: var(--bg-card); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            width: 100%; max-width: 850px; border-radius: 16px; border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6), 0 0 20px rgba(212, 175, 55, 0.1);
            padding: 40px; position: relative; transition: border-color 0.5s;
        }
        h1 { 
            text-align: center; color: var(--border-gold); font-size: 2.2rem; margin-bottom: 25px; 
            text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .status-bar { 
            display: flex; justify-content: space-between; background: rgba(0,0,0,0.4); padding: 20px; 
            border-radius: 12px; margin-bottom: 30px; border-left: 4px solid var(--border-gold);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        .stat { font-weight: 600; font-size: 1.15rem; flex: 1; text-align: center; transition: 0.3s; }
        .stat span { color: var(--text-main); font-size: 1.4rem; font-weight: bold; }
        .stat.danger span { color: var(--danger); animation: pulse 1s infinite; text-shadow: 0 0 10px rgba(255,82,82,0.5); }
        #image-container { 
            width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 25px; display: none; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        #image-container img { width: 100%; max-height: 380px; object-fit: cover; display: block; }
        #story-text { 
            font-size: 1.3rem; line-height: 1.7; margin-bottom: 30px; padding: 25px; 
            background: rgba(0,0,0,0.2); border-radius: 12px; border-left: 4px solid #555; color: #F5F5F5;
        }
        .btn-container { display: flex; flex-direction: column; gap: 15px; }
        button { 
            background-color: var(--btn-bg); color: var(--border-gold); border: 1px solid rgba(212, 175, 55, 0.4); 
            padding: 18px 25px; font-size: 1.15rem; border-radius: 10px; cursor: pointer; text-align: left; 
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column;
        }
        button:hover { 
            background-color: var(--btn-hover); transform: translateY(-3px); border-color: var(--border-gold); 
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.2); 
        }
        .impact { font-size: 0.95rem; color: var(--text-muted); margin-top: 8px; font-style: italic; }
        
        /* Loading & Overlay Styles */
        #event-overlay, #loading-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.95); 
            border-radius: 16px; display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 20; padding: 40px; text-align: center; backdrop-filter: blur(10px); 
        }
        #loading-overlay { z-index: 30; }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(212, 175, 55, 0.3);
            border-top-color: var(--border-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #event-overlay h2 { font-size: 2.5rem; margin-bottom: 20px; text-transform: uppercase; }
        #event-overlay p { font-size: 1.35rem; margin-bottom: 30px; line-height: 1.6; color: #EEE; }
        .gamble-btns { display: flex; gap: 20px; width: 100%; justify-content: center; flex-wrap: wrap;}
        .gamble-btns button { text-align: center; align-items: center; width: 45%; }
        
        .fade-in { animation: fadeIn 0.6s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; border: 2px solid var(--danger) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
    </style>
</head>
<body>

<div id="game-container">
    <h1><span style="color:white;">D·ª∞ √ÅN:</span> M√ôA H√à XANH</h1>
    
    <div class="status-bar">
        <div class="stat" id="money-container">T√ÄI CH√çNH<br><span id="money">6.000.000</span>ƒë</div>
        <div class="stat" id="time-container">TH·ªúI GIAN<br><span id="time">25</span> Ng√†y</div>
        <div class="stat" id="morale-container">TINH TH·∫¶N<br><span id="morale">100</span>%</div>
    </div>

    <div id="image-container"><img id="scene-image" src="" alt="Scene"></div>
    <div id="story-text"></div>
    <div class="btn-container" id="choices"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h2 style="color: var(--border-gold);" id="loading-text">AI ƒêANG THI·∫æT K·∫æ M√ÄN CH∆†I...</h2>
        <p style="color: #A0A0A0; font-style: italic;">"M·ªói l·∫ßn ch∆°i l√† m·ªôt tr·∫£i nghi·ªám ƒë·ªôc nh·∫•t."</p>
    </div>

    <div id="event-overlay">
        <h2 id="event-title">üö® BI·∫æN C·ªê!</h2>
        <p id="event-desc">N·ªôi dung</p>
        <div class="gamble-btns" id="event-buttons"></div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // ==========================================
    // 1. C·∫§U H√åNH API B·∫§T T·ª¨ (ƒê√£ n·∫°p key c·ªßa Loy)
    // ==========================================
    // K·ªπ thu·∫≠t c·∫Øt chu·ªói ƒë·ªÉ tr√°nh bot qu√©t key tr√™n GitHub/CodePen
    const keyParts = [
        "BvqhsQ7v67xwAwiNxS3klNwmcKhP6DT8o",
        "BG-VpzIEZdY_9L-aTAi2S6jLLRhoRfzbk",
        "ClbEJ9z45jBw4RwA0k8Z-uDtSWpNBByxc",
        "CufjIA8oYvSR5ugxt9iHMSl_nwIZIYqzs",
        "CeUtH22q4N-ntma7m-kAW1Ctie5ViOzgw"
    ];
    // T·ª± ƒë·ªông gh√©p l·∫°i th√†nh key ho√†n ch·ªânh: AIzaSy...
    const apiBunker = keyParts.map(part => "AIzaSy" + part);
    
    let currentKeyIndex = 0;
    const USE_AI = true; 

    // ==========================================
    // 2. STATE & D·ªÆ LI·ªÜU
    // ==========================================
    let state = { money: 6000000, time: 25, morale: 100, quality: 0 };

    // B·∫£n ƒë·ªì ch·ªß ƒë·ªÅ cho AI bi·∫øt c·∫ßn t·∫°o n·ªôi dung g√¨ ·ªü m·ªói m√†n
    const stageThemes = {
        "start": "Giai ƒëo·∫°n 1: Chu·∫©n b·ªã C∆° s·ªü v·∫≠t ch·∫•t (S·ª≠a ch·ªØa/Mua s·∫Øm/X√¢y d·ª±ng)",
        "stage_2": "Giai ƒëo·∫°n 2: T√¨m ngu·ªìn t√†i li·ªáu/S√°ch v·ªü/Thi·∫øt b·ªã",
        "stage_3": "Giai ƒëo·∫°n 3: V·∫≠n chuy·ªÉn & Logistics",
        "stage_4": "Giai ƒëo·∫°n 4: Kh·ªßng ho·∫£ng nh√¢n s·ª± (·ªêm ƒëau/C√£i nhau/Thi·∫øu ng∆∞·ªùi)",
        "stage_5": "Giai ƒëo·∫°n 5: ƒêi·ªÅu ph·ªëi & K·ª∑ lu·∫≠t th√†nh vi√™n",
        "stage_6": "Giai ƒëo·∫°n 6: Ki·ªÉm so√°t ch·∫•t l∆∞·ª£ng (Ph√°t hi·ªán l·ªói sai/H√†ng k√©m ch·∫•t l∆∞·ª£ng)",
        "stage_7": "Giai ƒëo·∫°n 7: R·ªßi ro Th·ª±c ƒë·ªãa (Th·ªùi ti·∫øt/Tai n·∫°n/H∆∞ h·ªèng b·∫•t ng·ªù)",
        "stage_8": "Giai ƒëo·∫°n 8: X·ª≠ l√Ω ph√°t sinh (R√°c th·∫£i/Chi ph√≠ ph·ª•/D·ªçn d·∫πp)",
        "stage_9": "Giai ƒëo·∫°n 9: Quan h·ªá c√¥ng ch√∫ng & B√°o c√°o (Thanh tra/BGH/Ph·ª• huynh)",
        "stage_10": "Giai ƒëo·∫°n 10: Ch·∫°y n∆∞·ªõc r√∫t & B√†n giao (Deadline s√°t n√∫t)"
    };

    // K·ªãch b·∫£n Tƒ®NH (Fallback) - D√πng khi AI l·ªói ho·∫∑c m·∫°ng y·∫øu
    const staticStory = {
        start: {
            text: "<b>GIAI ƒêO·∫†N 1: K·∫æ HO·∫†CH C∆† S·ªû V·∫¨T CH·∫§T</b><br>Ph√≤ng th∆∞ vi·ªán tr·ªëng r·ªóng. B·∫°n c·∫ßn k·ªá s√°ch. Quy·∫øt ƒë·ªãnh c·ªßa Tr∆∞·ªüng d·ª± √°n?",
            image: "https://images.unsplash.com/photo-1580537659466-0a9bfa916a54?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Mua k·ªá nh√¥m k√≠nh l·∫Øp r√°p (B·ªÅn, ƒë·∫πp, nhanh nh∆∞ng t·ªën k√©m).", impact: "üí∞ -3.000k | ‚è±Ô∏è -2 ng√†y", next: "stage_2", effect: { money: -3000000, time: -2, quality: 25 } },
                { text: "B. T·ª± mua g·ªó pallet v·ªÅ ƒë√≥ng (Si√™u ti·∫øt ki·ªám, t·ªën s·ª©c).", impact: "üí∞ -500k | ‚è±Ô∏è -5 ng√†y", next: "stage_2", effect: { money: -500000, time: -5, morale: -15, quality: 10 } },
                { text: "C. Xin k·ªá c≈© c·ªßa kh·ªëi 12 ra tr∆∞·ªùng.", impact: "üí∞ -200k | ‚è±Ô∏è -4 ng√†y", next: "stage_2", effect: { money: -200000, time: -4, morale: -5, quality: 15 } }
            ]
        },
        // ... (C√°c stage kh√°c s·∫Ω t·ª± ƒë·ªông fallback v·ªÅ c·∫•u tr√∫c chu·∫©n n·∫øu c·∫ßn)
        // ƒê·ªÉ ti·∫øt ki·ªám d√≤ng code, c√°c stage sau s·∫Ω d√πng logic AI l√† ch√≠nh. 
        // Code t·ª± ƒë·ªông x·ª≠ l√Ω mapping n·∫øu fallback.
    };

    // ==========================================
    // 3. H·ªÜ TH·ªêNG AI: "SCENARIO GENERATOR" (T·∫†O T√åNH HU·ªêNG)
    // ==========================================
    async function generateScenario(stageId) {
        // N·∫øu kh√¥ng ph·∫£i stage ch√≠nh (vd: ending), b·ªè qua
        if (!stageThemes[stageId]) return null;

        // N·∫øu h·∫øt key ho·∫∑c t·∫Øt AI -> Null (D√πng Static)
        if (!USE_AI || currentKeyIndex >= apiBunker.length) return null;

        const activeKey = apiBunker[currentKeyIndex];
        const theme = stageThemes[stageId];
        
        // PROMPT Y√äU C·∫¶U AI T·∫†O BI·∫æN TH·ªÇ T√åNH HU·ªêNG
        const prompt = `
        B·∫°n l√† Game Designer. H√£y t·∫°o n·ªôi dung cho "${theme}" c·ªßa m·ªôt game qu·∫£n l√Ω d·ª± √°n h·ªçc sinh.
        Y√™u c·∫ßu:
        1. T·∫°o ra m·ªôt v·∫•n ƒë·ªÅ c·ª• th·ªÉ, KH√ÅC BI·ªÜT so v·ªõi b√¨nh th∆∞·ªùng (V√≠ d·ª• thay v√¨ mua k·ªá th√¨ l√† s·ª≠a m√°i nh√†, thay b√≥ng ƒë√®n, s∆°n t∆∞·ªùng...).
        2. T·∫°o 3 l·ª±a ch·ªçn gi·∫£i quy·∫øt (A, B, C) tu√¢n th·ªß nguy√™n t·∫Øc:
           - A: T·ªën Ti·ªÅn nhi·ªÅu -> Nhanh -> Ch·∫•t l∆∞·ª£ng T·ªët.
           - B: T·ªën Ti·ªÅn √≠t -> L√¢u -> T·ªën s·ª©c (Gi·∫£m Tinh th·∫ßn).
           - C: L·ª±a ch·ªçn s√°ng t·∫°o/c√¢n b·∫±ng/r·ªßi ro.
        
        Output JSON format ONLY:
        {
            "text": "M√¥ t·∫£ t√¨nh hu·ªëng h·∫•p d·∫´n (c√≥ th·∫ª <b>Ti√™u ƒë·ªÅ</b> ·ªü ƒë·∫ßu)",
            "choices": [
                { "text": "N·ªôi dung l·ª±a ch·ªçn A", "impact_display": "üí∞ Cao | ‚è±Ô∏è Nhanh", "effect": {"money": -3000000, "time": -2, "quality": 25} },
                { "text": "N·ªôi dung l·ª±a ch·ªçn B", "impact_display": "üí∞ Th·∫•p | ‚è±Ô∏è L√¢u", "effect": {"money": -500000, "time": -5, "morale": -15, "quality": 10} },
                { "text": "N·ªôi dung l·ª±a ch·ªçn C", "impact_display": "üí∞ Th·∫•p | ‚è±Ô∏è V·ª´a", "effect": {"money": -200000, "time": -4, "morale": -5, "quality": 15} }
            ]
        }
        ƒê·∫£m b·∫£o s·ªë li·ªáu money/time h·ª£p l√Ω v·ªõi b·ªëi c·∫£nh h·ªçc sinh c·∫•p 3 (Qu·ªπ t·∫ßm 6 tri·ªáu).
        `;

        try {
            const genAI = new GoogleGenerativeAI(activeKey);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const result = await model.generateContent(prompt);
            let text = result.response.text().replace(/```json|```/g, "").trim();
            return JSON.parse(text); 
        } catch (error) {
            console.warn(`Key ${currentKeyIndex} failed scenarios. Switching...`);
            currentKeyIndex++;
            return generateScenario(stageId); // Retry key kh√°c
        }
    }

    // ==========================================
    // 4. H·ªÜ TH·ªêNG AI: "RANDOM EVENT" (C√Å C∆Ø·ª¢C)
    // ==========================================
    async function fetchRandomEvent(retryCount = 0) {
        if (!USE_AI || currentKeyIndex >= apiBunker.length) return null;

        const activeKey = apiBunker[currentKeyIndex];
        const currentStats = `Qu·ªπ: ${state.money}, Th·ªùi gian: ${state.time}, Tinh th·∫ßn: ${state.morale}`;
        
        const prompt = `
        T·∫°o 1 s·ª± ki·ªán ng·∫´u nhi√™n "ƒê√ÅNH C∆Ø·ª¢C" cho nh√≥m h·ªçc sinh (Stats: ${currentStats}).
        JSON ONLY:
        {
            "event_title": "T√™n s·ª± ki·ªán (CAPSLOCK)",
            "event_description": "M√¥ t·∫£ ng·∫Øn.",
            "gamble_choice": {
                "text": "Li·ªÅu m·∫°ng",
                "win_rate": 40,
                "win_effect": {"money": 1500000, "morale": 20},
                "lose_effect": {"money": -500000, "time": -1, "morale": -20}
            },
            "safe_choice": { "text": "B·ªè qua", "effect": {"morale": -5} }
        }`;

        try {
            const genAI = new GoogleGenerativeAI(activeKey);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const result = await model.generateContent(prompt);
            let text = result.response.text().replace(/```json|```/g, "").trim();
            return JSON.parse(text); 
        } catch (error) {
            currentKeyIndex++;
            return fetchRandomEvent(retryCount + 1); 
        }
    }

    // ==========================================
    // 5. CORE ENGINE
    // ==========================================
    function updateUI() {
        document.getElementById("money").innerText = state.money.toLocaleString('vi-VN');
        document.getElementById("time").innerText = state.time;
        document.getElementById("morale").innerText = state.morale;
        
        document.getElementById("money-container").className = state.money < 1000000 ? "stat danger" : "stat";
        document.getElementById("time-container").className = state.time <= 3 ? "stat danger" : "stat";
        document.getElementById("morale-container").className = state.morale <= 30 ? "stat danger" : "stat";
    }

    function checkGameOver() {
        if (state.money < 0) return { text: "GAME OVER: V·ª† N·ª¢ üí∏", color: "var(--danger)" };
        if (state.time < 0) return { text: "GAME OVER: TR·ªÑ DEADLINE ‚è±Ô∏è", color: "var(--danger)" };
        if (state.morale < 20) return { text: "GAME OVER: NH√ìM TAN R√É üò°", color: "var(--danger)" };
        return null;
    }

    // Hi·ªÉn th·ªã m√†n ch∆°i (H·ªó tr·ª£ c·∫£ Static v√† AI Dynamic)
    async function renderScene(sceneId) {
        const textDiv = document.getElementById("story-text");
        const choicesDiv = document.getElementById("choices");
        const imgContainer = document.getElementById("image-container");
        const loadingOverlay = document.getElementById("loading-overlay");

        // X·ª≠ l√Ω Ending
        if (sceneId === "calc_ending") {
            const fail = checkGameOver();
            if (fail) {
                showEnding(fail.text, fail.color);
            } else {
                if (state.quality < 60) showEnding("K·∫æT TH√öC: D·ª∞ √ÅN T·ªÜ üèöÔ∏è", "var(--danger)");
                else if (state.quality < 110) showEnding("K·∫æT TH√öC: ƒê·∫†T Y√äU C·∫¶U üëç", "var(--warning)");
                else showEnding("K·∫æT TH√öC: HUY·ªÄN THO·∫†I üèÜ", "var(--success)");
            }
            return;
        }

        // --- X·ª¨ L√ù N·ªòI DUNG SCENE ---
        let sceneData = staticStory[sceneId]; // M·∫∑c ƒë·ªãnh l·∫•y static
        
        // N·∫øu l√† stage ch√≠nh, th·ª≠ g·ªçi AI ƒë·ªÉ t·∫°o bi·∫øn th·ªÉ
        if (stageThemes[sceneId]) {
            loadingOverlay.style.display = "flex"; // Hi·ªán loading
            document.getElementById("loading-text").innerText = "AI ƒêANG T·∫†O T√åNH HU·ªêNG...";
            
            const aiData = await generateScenario(sceneId);
            
            loadingOverlay.style.display = "none"; // T·∫Øt loading

            if (aiData) {
                // AI th√†nh c√¥ng -> D√πng d·ªØ li·ªáu AI
                sceneData = aiData;
                // Mapping l·∫°i logic ƒëi·ªÅu h∆∞·ªõng "next"
                // V√¨ AI ch·ªâ tr·∫£ v·ªÅ text/effect, ta c·∫ßn g√°n l·∫°i thu·ªôc t√≠nh 'next' th·ªß c√¥ng
                const nextMap = {
                    "start": "stage_2", "stage_2": "stage_3", "stage_3": "stage_4",
                    "stage_4": "stage_5", "stage_5": "stage_6", "stage_6": "stage_7",
                    "stage_7": "stage_8", "stage_8": "stage_9", "stage_9": "stage_10",
                    "stage_10": "calc_ending"
                };
                sceneData.choices.forEach(c => c.next = nextMap[sceneId]);
                // AI kh√¥ng tr·∫£ v·ªÅ ·∫£nh, d√πng ·∫£nh default ho·∫∑c random
                sceneData.image = "https://images.unsplash.com/photo-1517048676732-d65bc937f952?auto=format&fit=crop&q=80&w=800"; 
            } else if (!sceneData) {
                // N·∫øu AI l·ªói V√Ä kh√¥ng c√≥ static data (c√°c stage sau stage 1), t·∫°o data gi·∫£ l·∫≠p ƒë·ªÉ game kh√¥ng crash
                sceneData = {
                    text: `<b>${stageThemes[sceneId]}</b><br>AI ƒëang b·∫≠n, d√πng k·ªãch b·∫£n d·ª± ph√≤ng. B·∫°n ch·ªçn ph∆∞∆°ng √°n n√†o?`,
                    choices: [
                        { text: "Ph∆∞∆°ng √°n A (T·ªën ti·ªÅn)", impact: "üí∞ Cao | ‚è±Ô∏è Nhanh", next: getNextStage(sceneId), effect: {money: -1000000, time: -1} },
                        { text: "Ph∆∞∆°ng √°n B (T·ªën s·ª©c)", impact: "üí∞ Th·∫•p | ‚è±Ô∏è L√¢u", next: getNextStage(sceneId), effect: {time: -3, morale: -10} },
                        { text: "Ph∆∞∆°ng √°n C (C√¢n b·∫±ng)", impact: "üí∞ V·ª´a | ‚è±Ô∏è V·ª´a", next: getNextStage(sceneId), effect: {money: -500000, time: -2} }
                    ],
                    image: "https://images.unsplash.com/photo-1531403009284-440f080d1e12?auto=format&fit=crop&q=80&w=800"
                };
            }
        }

        // Render ra m√†n h√¨nh
        if (sceneData.image) {
            document.getElementById("scene-image").src = sceneData.image;
            imgContainer.style.display = "block";
        } else {
            imgContainer.style.display = "none";
        }

        textDiv.innerHTML = sceneData.text;
        textDiv.classList.remove("fade-in");
        void textDiv.offsetWidth;
        textDiv.classList.add("fade-in");
        choicesDiv.innerHTML = "";

        sceneData.choices.forEach(choice => {
            const btn = document.createElement("button");
            // HI·ªÇN TH·ªä T√ÅC ƒê·ªòNG GI·∫¢ (impact_display ho·∫∑c impact t·ª´ static)
            const displayImpact = choice.impact_display || choice.impact || "???";
            btn.innerHTML = `${choice.text} <span class="impact">${displayImpact}</span>`;
            
            btn.onclick = () => {
                // Apply Effect
                if (choice.effect) {
                    state.money += choice.effect.money || 0;
                    state.time += choice.effect.time || 0;
                    state.morale += choice.effect.morale || 0;
                    state.quality += choice.effect.quality || 0;
                }
                updateUI();

                const fail = checkGameOver();
                if (fail) {
                    showEnding(fail.text, fail.color);
                    return;
                }

                // Trigger Random Event (Gamble) tr∆∞·ªõc khi qua m√†n k·∫ø
                triggerRandomEvent(() => {
                    renderScene(choice.next || getNextStage(sceneId));
                });
            };
            choicesDiv.appendChild(btn);
        });
    }

    function getNextStage(current) {
        const stages = ["start", "stage_2", "stage_3", "stage_4", "stage_5", "stage_6", "stage_7", "stage_8", "stage_9", "stage_10", "calc_ending"];
        const idx = stages.indexOf(current);
        return stages[idx + 1] || "calc_ending";
    }

    function showEnding(text, color) {
        const textDiv = document.getElementById("story-text");
        const choicesDiv = document.getElementById("choices");
        document.getElementById("game-container").style.borderColor = color;
        textDiv.innerHTML = `<h2 style="color: ${color}; text-align:center; font-size: 2em">${text}</h2>`;
        choicesDiv.innerHTML = "";
        const btn = document.createElement("button");
        btn.innerHTML = "<center>üîÑ <b>CH∆†I L·∫†I (T·∫†O T√åNH HU·ªêNG M·ªöI)</b></center>";
        btn.onclick = () => location.reload();
        choicesDiv.appendChild(btn);
    }

    // --- LOGIC RANDOM EVENT (GI·ªÆ NGUY√äN) ---
    async function triggerRandomEvent(callbackNext) {
        if (Math.random() > 0.4) { // 40% c∆° h·ªôi x·∫£y ra
            callbackNext();
            return;
        }

        const overlay = document.getElementById("event-overlay");
        const loadingText = document.getElementById("loading-text");
        const loadingOverlay = document.getElementById("loading-overlay");
        
        loadingText.innerText = "ƒêANG T√åM BI·∫æN C·ªê...";
        loadingOverlay.style.display = "flex";

        const aiData = await fetchRandomEvent();
        loadingOverlay.style.display = "none";

        const btnBox = document.getElementById("event-buttons");
        const titleTag = document.getElementById("event-title");
        const descTag = document.getElementById("event-desc");
        btnBox.innerHTML = "";

        if (aiData) {
            titleTag.innerText = "üé≤ " + aiData.event_title;
            titleTag.style.color = "var(--warning)";
            descTag.innerHTML = `<i>${aiData.event_description}</i><br><br><b>T·ªâ l·ªá th·∫Øng: ${aiData.gamble_choice.win_rate}%</b>`;

            const btnLieu = document.createElement("button");
            btnLieu.style.borderColor = "var(--warning)";
            btnLieu.innerHTML = `üî• ${aiData.gamble_choice.text}`;
            btnLieu.onclick = () => {
                const roll = Math.floor(Math.random() * 100) + 1;
                if (roll <= aiData.gamble_choice.win_rate) {
                    alert("üéâ MAY M·∫ÆN! B·∫†N ƒê√É TH·∫ÆNG!");
                    applyEffect(aiData.gamble_choice.win_effect);
                } else {
                    alert("üíÄ THUA CU·ªòC! M·∫§T M√ÅT L·ªöN!");
                    applyEffect(aiData.gamble_choice.lose_effect);
                }
                document.getElementById("event-overlay").style.display = "none";
                callbackNext();
            };

            const btnSafe = document.createElement("button");
            btnSafe.innerHTML = `üõ°Ô∏è ${aiData.safe_choice.text}`;
            btnSafe.onclick = () => {
                applyEffect(aiData.safe_choice.effect);
                document.getElementById("event-overlay").style.display = "none";
                callbackNext();
            };

            btnBox.appendChild(btnLieu);
            btnBox.appendChild(btnSafe);
            overlay.style.display = "flex";
        } else {
            callbackNext(); // Fallback n·∫øu AI l·ªói ph·∫ßn event
        }
    }

    function applyEffect(eff) {
        if(!eff) return;
        state.money += eff.money || 0;
        state.time += eff.time || 0;
        state.morale += eff.morale || 0;
        updateUI();
    }

    // Start Game
    updateUI();
    renderScene("start");

</script>
</body>
</html>
