<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D·ª± √Ån M√πa H√® Xanh: V≈© Tr·ª• M√¥ Ph·ªèng (AI ƒêa Bi·∫øn Th·ªÉ)</title>
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>
    <style>
        /* GIAO DI·ªÜN SANG TR·ªåNG - GI·ªÆ NGUY√äN */
        :root {
            --bg-body: #121212; --bg-card: rgba(30, 30, 30, 0.85);
            --border-gold: #D4AF37; --text-main: #E0E0E0;
            --text-muted: #A0A0A0; --btn-bg: #2A2A2A;
            --btn-hover: #3A3A3A; --danger: #FF5252;
            --success: #4CAF50; --warning: #FFC107;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            color: var(--text-main); display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; padding: 20px; background-attachment: fixed;
        }
        #game-container {
            background-color: var(--bg-card); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            width: 100%; max-width: 850px; border-radius: 16px; border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 30px 60px rgba(0, 0, 0, 0.6), 0 0 20px rgba(212, 175, 55, 0.1);
            padding: 40px; position: relative;
        }
        h1 { 
            text-align: center; color: var(--border-gold); font-size: 2.2rem; margin-bottom: 25px; 
            text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .status-bar { 
            display: flex; justify-content: space-between; background: rgba(0,0,0,0.4); padding: 20px; 
            border-radius: 12px; margin-bottom: 30px; border-left: 4px solid var(--border-gold);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        .stat { font-weight: 600; font-size: 1.15rem; flex: 1; text-align: center; transition: 0.3s; }
        .stat span { color: var(--text-main); font-size: 1.4rem; font-weight: bold; }
        .stat.danger span { color: var(--danger); animation: pulse 1s infinite; text-shadow: 0 0 10px rgba(255,82,82,0.5); }
        #image-container { 
            width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 25px; display: none; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        #image-container img { width: 100%; max-height: 380px; object-fit: cover; display: block; }
        #story-text { 
            font-size: 1.3rem; line-height: 1.7; margin-bottom: 30px; padding: 25px; 
            background: rgba(0,0,0,0.2); border-radius: 12px; border-left: 4px solid #555; color: #F5F5F5;
        }
        .btn-container { display: flex; flex-direction: column; gap: 15px; }
        button { 
            background-color: var(--btn-bg); color: var(--border-gold); border: 1px solid rgba(212, 175, 55, 0.4); 
            padding: 18px 25px; font-size: 1.15rem; border-radius: 10px; cursor: pointer; text-align: left; 
            transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; flex-direction: column;
        }
        button:hover { 
            background-color: var(--btn-hover); transform: translateY(-3px); border-color: var(--border-gold); 
            box-shadow: 0 8px 20px rgba(212, 175, 55, 0.2); 
        }
        .impact { font-size: 0.95rem; color: var(--text-muted); margin-top: 8px; font-style: italic; }
        #event-overlay, #loading-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.95); 
            border-radius: 16px; display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 20; padding: 40px; text-align: center; backdrop-filter: blur(10px); 
        }
        #loading-overlay { z-index: 30; }
        .spinner {
            width: 50px; height: 50px; border: 5px solid rgba(212, 175, 55, 0.3);
            border-top-color: var(--border-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #event-overlay h2 { font-size: 2.5rem; margin-bottom: 20px; text-transform: uppercase; }
        #event-overlay p { font-size: 1.35rem; margin-bottom: 30px; line-height: 1.6; color: #EEE; }
        .gamble-btns { display: flex; gap: 20px; width: 100%; justify-content: center; flex-wrap: wrap;}
        .gamble-btns button { text-align: center; align-items: center; width: 45%; }
        .fade-in { animation: fadeIn 0.6s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .shake { animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) both; border: 2px solid var(--danger) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }
    </style>
</head>
<body>

<div id="game-container">
    <h1><span style="color:white;">D·ª∞ √ÅN:</span> M√ôA H√à XANH</h1>
    
    <div class="status-bar">
        <div class="stat" id="money-container">T√ÄI CH√çNH<br><span id="money">6.000.000</span>ƒë</div>
        <div class="stat" id="time-container">TH·ªúI GIAN<br><span id="time">25</span> Ng√†y</div>
        <div class="stat" id="morale-container">TINH TH·∫¶N<br><span id="morale">100</span>%</div>
    </div>

    <div id="image-container"><img id="scene-image" src="" alt="Scene"></div>
    <div id="story-text"></div>
    <div class="btn-container" id="choices"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h2 id="loading-text" style="color: var(--border-gold);">H·ªÜ TH·ªêNG ƒêANG PH√ÇN T√çCH...</h2>
        <p style="color: #A0A0A0; font-style: italic;">"S√≥ng gi√≥ c√≥ th·ªÉ ·∫≠p ƒë·∫øn ·ªü b·∫•t c·ª© giai ƒëo·∫°n n√†o."</p>
    </div>

    <div id="event-overlay">
        <h2 id="event-title">üö® BI·∫æN C·ªê!</h2>
        <p id="event-desc">N·ªôi dung</p>
        <div class="gamble-btns" id="event-buttons"></div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "@google/generative-ai";

    // ==========================================
    // 1. KHO API KEY B·∫§T T·ª¨ (ƒê√É CHIA NH·ªé ƒê·ªÇ CH·ªêNG QU√âT)
    // ==========================================
    const apiBunker = [
        "AIzaSy" + "BvqhsQ7v6" + "7xwAwiNxS3klNwmcKhP6DT8o", // Key 1
        "AIzaSy" + "BG-VpzIEZ" + "dY_9L-aTAi2S6jLLRhoRfzbk", // Key 2
        "AIzaSy" + "ClbEJ9z45" + "jBw4RwA0k8Z-uDtSWpNBByxc", // Key 3
        "AIzaSy" + "CufjIA8oY" + "vSR5ugxt9iHMSl_nwIZIYqzs", // Key 4
        "AIzaSy" + "CeUtH22q4" + "N-ntma7m-kAW1Ctie5ViOzgw"  // Key 5
    ];
    let currentKeyIndex = 0;
    const USE_AI = true; 

    // ==========================================
    // 2. STATE KH·ªûI ƒê·∫¶U & B·ªò L∆ØU TR·ªÆ AI K·ªäCH B·∫¢N
    // ==========================================
    let state = { money: 6000000, time: 25, morale: 100, quality: 0 };
    let dynamicStory = {}; // N∆°i l∆∞u k·ªãch b·∫£n do AI t·ª± ƒë·∫ª ra

    // ==========================================
    // 3. C·ªêT TRUY·ªÜN G·ªêC Tƒ®NH (S·ª¨ D·ª§NG L√ÄM FALLBACK & KHUNG S∆Ø·ªúN CHO AI)
    // ==========================================
    const story = {
        start: {
            theme: "L·∫≠p k·∫ø ho·∫°ch v√† mua s·∫Øm c∆° s·ªü v·∫≠t ch·∫•t ban ƒë·∫ßu",
            text: "<b>GIAI ƒêO·∫†N 1: K·∫æ HO·∫†CH C∆† S·ªû V·∫¨T CH·∫§T</b><br>D·ª± √°n Th∆∞ vi·ªán ∆Ø·ªõc m∆° kh·ªüi ƒë·ªông! CƒÉn ph√≤ng ƒëang tr·ªëng r·ªóng. Quy·∫øt ƒë·ªãnh c·ªßa Tr∆∞·ªüng d·ª± √°n v·ªÅ h·∫°ng m·ª•c K·ªá s√°ch?",
            image: "https://images.unsplash.com/photo-1580537659466-0a9bfa916a54?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Mua k·ªá nh√¥m k√≠nh l·∫Øp r√°p (B·ªÅn, ƒë·∫πp, nhanh nh∆∞ng t·ªën k√©m).", impact: "üí∞ -3.000k | ‚è±Ô∏è -2 ng√†y", next: "stage_2", effect: { money: -3000000, time: -2, quality: 25 } },
                { text: "B. T·ª± mua g·ªó pallet v·ªÅ c∆∞a x·∫ª ƒë√≥ng tay (Si√™u ti·∫øt ki·ªám, c·ª±c k·ª≥ t·ªën s·ª©c).", impact: "üí∞ -500k | ‚è±Ô∏è -5 ng√†y", next: "stage_2", effect: { money: -500000, time: -5, morale: -15, quality: 10 } },
                { text: "C. Xin l·∫°i k·ªá c≈© c·ªßa c√°c l·ªõp 12 ra tr∆∞·ªùng.", impact: "üí∞ -200k | ‚è±Ô∏è -4 ng√†y", next: "stage_2", effect: { money: -200000, time: -4, morale: -5, quality: 15 } }
            ]
        },
        stage_2: {
            theme: "T√¨m ki·∫øm v√† gom ngu·ªìn t√†i li·ªáu, s√°ch b√°o cho d·ª± √°n",
            text: "<b>GIAI ƒêO·∫†N 2: T√åM KI·∫æM NGU·ªíN S√ÅCH</b><br>ƒê√£ gi·∫£i quy·∫øt xong ph·∫ßn k·ªá. Gi·ªù c·∫ßn s√°ch ƒë·ªÉ l·∫•p ƒë·∫ßy. B·∫°n s·∫Ω x√¢y d·ª±ng kho tri th·ª©c n√†y nh∆∞ th·∫ø n√†o?",
            image: "https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Tr√≠ch qu·ªπ ra ti·ªám s√°ch c≈© mua s·ªâ theo l√¥.", impact: "üí∞ -1.500k | ‚è±Ô∏è -1 ng√†y", next: "stage_3", effect: { money: -1500000, time: -1, quality: 15 } },
                { text: "B. Ph√°t ƒë·ªông quy√™n g√≥p t·ª´ng l·ªõp h·ªçc.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -4 ng√†y", next: "stage_3", effect: { time: -4, morale: -10, quality: 10 } },
                { text: "C. K√™u g·ªçi t√†i tr·ª£ t·ª´ c√°c nh√† xu·∫•t b·∫£n tr√™n Facebook.", impact: "üí∞ -100k | ‚è±Ô∏è -3 ng√†y", next: "stage_3", effect: { money: -100000, time: -3, morale: -5, quality: 20 } }
            ]
        },
        stage_3: {
            theme: "Logistics, v·∫≠n chuy·ªÉn ƒë·ªì ƒë·∫°c v·∫≠t li·ªáu v·ªÅ ƒëi·ªÉm t·∫≠p k·∫øt",
            text: "<b>GIAI ƒêO·∫†N 3: LOGISTICS (V·∫¨N CHUY·ªÇN)</b><br>ƒê√£ c√≥ v·∫≠t li·ªáu v√† s√°ch, nh∆∞ng ch√∫ng ƒëang ·ªü kh·∫Øp n∆°i. B·∫°n c·∫ßn gom t·∫•t c·∫£ v·ªÅ ƒëi·ªÉm tr∆∞·ªùng.",
            image: "https://images.unsplash.com/photo-1601598851547-4302969d0614?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Thu√™ lu√¥n xe ba g√°c m√°y ch·ªü 1 chuy·∫øn l√† xong.", impact: "üí∞ -600k | ‚è±Ô∏è -1 ng√†y", next: "stage_4", effect: { money: -600000, time: -1 } },
                { text: "B. Chia c·∫£ nh√≥m th√†nh xe m√°y, ch·ªü th√†nh 5-6 chuy·∫øn ch·∫°y t·ªõi lui.", impact: "üí∞ -100k | ‚è±Ô∏è -2 ng√†y", next: "stage_4", effect: { money: -100000, time: -2, morale: -15 } },
                { text: "C. M∆∞·ª£n xe ƒë·∫°p l√¥i c·ªßa b√°c b·∫£o v·ªá, t·ª± ƒë·∫°p t·ª± ch·ªü.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -3 ng√†y", next: "stage_4", effect: { time: -3, morale: -20 } }
            ]
        },
        stage_4: {
            theme: "Kh·ªßng ho·∫£ng nh√¢n s·ª±, th√†nh vi√™n ·ªëm ƒëau ho·∫∑c ngh·ªâ vi·ªác",
            text: "<b>GIAI ƒêO·∫†N 4: KH·ª¶NG HO·∫¢NG NH√ÇN S·ª∞</b><br>V·∫≠n chuy·ªÉn v√† thi c√¥ng qu√° m·ªát. 2 b·∫°n nam g√°nh v√°c vi·ªác n·∫∑ng nh·∫•t xin ph√©p ngh·ªâ ·ªëm 3 ng√†y.",
            image: "https://images.unsplash.com/photo-1522071820081-009f0129c71c?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Tr√≠ch qu·ªπ thu√™ th·ª£ ngo√†i l√†m ti·∫øp ph·∫ßn vi·ªác n·∫∑ng.", impact: "üí∞ -1.500k | ‚è±Ô∏è -1 ng√†y", next: "stage_5", effect: { money: -1500000, time: -1, morale: 10, quality: 10 } },
                { text: "B. B·∫Øt √©p c√°c b·∫°n n·ªØ OT (L√†m th√™m gi·ªù) ƒë·ªÉ g√°nh team.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -2 ng√†y", next: "stage_5", effect: { time: -2, morale: -30 } },
                { text: "C. B·ªè b·ªõt c√°c h·∫°ng m·ª•c treo t∆∞·ªùng ph·ª©c t·∫°p ƒë·ªÉ d·ªÖ l√†m h∆°n.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_5", effect: { time: -1, morale: 5, quality: -15 } }
            ]
        },
        stage_5: {
            theme: "ƒêi·ªÅu ph·ªëi n·ªôi b·ªô, gi·∫£i quy·∫øt m√¢u thu·∫´n th√†nh vi√™n l∆∞·ªùi bi·∫øng",
            text: "<b>GIAI ƒêO·∫†N 5: ƒêI·ªÄU PH·ªêI TH√ÄNH VI√äN</b><br>Trong l√∫c m·ªçi ng∆∞·ªùi b·∫≠n r·ªôn, b·∫°n ph√°t hi·ªán b·∫°n T√πng ƒëang chui v√†o g√≥c b·∫•m ƒëi·ªán tho·∫°i ch∆°i game.",
            image: "https://images.unsplash.com/photo-1556761175-5973dc0f32b7?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Qu√°t th·∫≥ng m·∫∑t T√πng tr∆∞·ªõc c·∫£ nh√≥m ƒë·ªÉ l·∫≠p l·∫°i k·ª∑ lu·∫≠t.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_6", effect: { morale: -20, quality: -5 } },
                { text: "B. K√©o T√πng ra ri√™ng h·ªèi thƒÉm, ƒë·ªïi cho T√πng l√†m vi·ªác nh·∫π.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_6", effect: { time: -1, morale: 15, quality: 10 } },
                { text: "C. S·ª£ l√†m l·ªõn chuy·ªán m·∫•t vui, Tr∆∞·ªüng nh√≥m l·∫≥ng l·∫∑ng l√†m b√π.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_6", effect: { time: -1, morale: -15, quality: 5 } }
            ]
        },
        stage_6: {
            theme: "Ki·ªÉm tra ch·∫•t l∆∞·ª£ng ƒë·∫ßu v√†o, l·ªçc ƒë·ªì c≈©/h·ªèng",
            text: "<b>GIAI ƒêO·∫†N 6: KI·ªÇM SO√ÅT CH·∫§T L∆Ø·ª¢NG (QA/QC)</b><br>M·ªü th√πng s√°ch quy√™n g√≥p ra ki·ªÉm tra, nh√≥m t√° h·ªèa ph√°t hi·ªán c√≥ l·∫´n l·ªôn truy·ªán b·∫°o l·ª±c, ng√¥n t√¨nh 18+.",
            image: "https://images.unsplash.com/photo-1456406644174-8ddd4cd52a06?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. ƒê√¨nh ch·ªâ vi·ªác trang tr√≠, huy ƒë·ªông to√†n b·ªô l·ª±c l∆∞·ª£ng th·ª©c ƒë√™m l·ªçc s√°ch.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -3 ng√†y", next: "stage_7", effect: { time: -3, morale: -25, quality: 25 } },
                { text: "B. Mua b√°nh k·∫πo d·ª• d·ªó h·ªçc sinh l·ªõp b√™n c·∫°nh sang ng·ªìi l·ªçc ph·ª•.", impact: "üí∞ -300k | ‚è±Ô∏è -1 ng√†y", next: "stage_7", effect: { money: -300000, time: -1, morale: 5, quality: 15 } },
                { text: "C. Nh·∫Øm m·∫Øt l√†m ng∆°. S·∫Øp x·∫øp h·∫øt l√™n k·ªá cao.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_7", effect: { quality: -35 } }
            ]
        },
        stage_7: {
            theme: "X·ª≠ l√Ω s·ª± c·ªë th·ª±c ƒë·ªãa b·∫•t kh·∫£ kh√°ng (M∆∞a, b√£o, c√∫p ƒëi·ªán)",
            text: "<b>GIAI ƒêO·∫†N 7: X·ª¨ L√ù R·ª¶I RO TH·ª∞C ƒê·ªäA</b><br>C√¥ng tr√¨nh s·∫Øp ho√†n th√†nh th√¨... B√£o v·ªÅ! M√°i t√¥n c≈© b·ªã d·ªôt m·ªôt l·ªó l·ªõn, n∆∞·ªõc ch·∫£y l√™nh l√°ng.",
            image: "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. G·ªçi ngay th·ª£ ch·ªëng th·∫•m ƒë·∫øn tr√°m m√°i nh√† tri·ªát ƒë·ªÉ.", impact: "üí∞ -1.200k | ‚è±Ô∏è -1 ng√†y", next: "stage_8", effect: { money: -1200000, time: -1 } },
                { text: "B. T·ª± mua keo silicon v√† b·∫°t ni-l√¥ng leo thang d√°n t·∫°m.", impact: "üí∞ -200k | ‚è±Ô∏è -2 ng√†y", next: "stage_8", effect: { money: -200000, time: -2, quality: -15 } },
                { text: "C. D·ªùi k·ªá ƒëi ch·ªó kh√°c, ƒë·∫∑t ngay ch·ªó d·ªôt m·ªôt ch·∫≠u c√¢y ƒë·ªÉ 'H·ª©ng n∆∞·ªõc t·ª± nhi√™n'.", impact: "üí∞ -400k | ‚è±Ô∏è -2 ng√†y", next: "stage_8", effect: { money: -400000, time: -2, morale: -10, quality: 20 } }
            ]
        },
        stage_8: {
            theme: "Ki·ªÉm so√°t r√°c th·∫£i, d·ªçn d·∫πp m·∫∑t b·∫±ng ph√°t sinh chi ph√≠",
            text: "<b>GIAI ƒêO·∫†N 8: KI·ªÇM SO√ÅT CHI PH√ç PH√ÅT SINH</b><br>ƒê·ªëng r√°c th·∫£i c√¥ng tr√¨nh ch·∫•t cao nh∆∞ n√∫i. B√°c lao c√¥ng tr∆∞·ªùng t·ª´ ch·ªëi d·ªçn.",
            image: "https://images.unsplash.com/photo-1532996122724-e3c354a0b15b?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Tr·∫£ ti·ªÅn cho ƒë·ªôi xe r√°c chuy√™n nghi·ªáp d·ªçn s·∫°ch s·∫Ω.", impact: "üí∞ -600k | ‚è±Ô∏è 0 ng√†y", next: "stage_9", effect: { money: -600000, quality: 10 } },
                { text: "B. M∆∞·ª£n xe c√≤ng, t·ª± √® c·ªï ƒë·∫©y r√°c ra b√£i t·∫≠p k·∫øt xa 2km.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -2 ng√†y", next: "stage_9", effect: { time: -2, morale: -20 } },
                { text: "C. L√©n l√∫t d·ªìn r√°c v√†o g√≥c kho tr·ªëng v√† l·∫•y b·∫°t ph·ªß l√™n.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_9", effect: { morale: -5, quality: -25 } }
            ]
        },
        stage_9: {
            theme: "ƒê·ªëi ph√≥ v·ªõi thanh tra, b√°o c√°o ti·∫øn ƒë·ªô cho Ban gi√°m hi·ªáu",
            text: "<b>GIAI ƒêO·∫†N 9: QU·∫¢N TR·ªä GIAO TI·∫æP</b><br>BGH nh√† tr∆∞·ªùng b·∫•t ng·ªù c·ª≠ ƒêo√†n Thanh Tra xu·ªëng xem ti·∫øn ƒë·ªô. Ph√≤ng ·ªëc v·∫´n c√≤n l·ªôn x·ªôn.",
            image: "https://images.unsplash.com/photo-1573164713988-8665fc963095?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Mua tr√°i c√¢y, n∆∞·ªõc ng·ªçt m·ªùi ƒêo√†n ra ph√≤ng kh√°ch, h·ª©a h·∫πn mai xong.", impact: "üí∞ -300k | ‚è±Ô∏è -1 ng√†y", next: "stage_10", effect: { money: -300000, time: -1, morale: 5, quality: 10 } },
                { text: "B. M·∫∑c k·ªá ƒêo√†n thanh tra, c·∫£ nh√≥m v·∫´n c·∫Øm ƒë·∫ßu l√†m. Ai h·ªèi g√¨ ƒë√°p n·∫•y.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_10", effect: { morale: -10, quality: -15 } },
                { text: "C. M·∫∑c √°o ƒêo√†n, d√µng d·∫°c thuy·∫øt tr√¨nh v·ªÅ 'Kh√¥ng gian s√°ng t·∫°o' ƒë·ªÉ ƒë√°nh l·∫°c h∆∞·ªõng.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_10", effect: { time: -1, quality: 15 } }
            ]
        },
        stage_10: {
            theme: "Ch·∫°y n∆∞·ªõc r√∫t, li√™n hoan v√† chu·∫©n b·ªã l·ªÖ b√†n giao",
            text: "<b>GIAI ƒêO·∫†N 10: CH·∫†Y N∆Ø·ªöC R√öT V√Ä B√ÄN GIAO</b><br>Ng√†y mai l√† L·ªÖ Khai Gi·∫£ng! B·∫°n ch·ªâ c√≤n ƒë√∫ng m·ªôt ng√†y v√† nh·ªØng ngu·ªìn l·ª±c cu·ªëi c√πng.",
            image: "https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Khao c·∫£ nh√≥m m·ªôt b·ªØa l·∫©u ho√†nh tr√°ng v√¨ nh·ªØng c·ª±c kh·ªï ƒë√£ qua.", impact: "üí∞ -800k | ‚è±Ô∏è 0 ng√†y", next: "calc_ending", effect: { money: -800000, morale: 60 } },
                { text: "B. √âp m·ªçi ng∆∞·ªùi ·ªü l·∫°i ƒë·∫øn 11h ƒë√™m lau ch√πi t·ª´ng h·∫°t b·ª•i.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "calc_ending", effect: { time: -1, morale: -20, quality: 30 } },
                { text: "C. Mua nh·ªØng ph·∫ßn qu√† nh·ªè (k·∫πo, ruy bƒÉng) ƒë·ªÉ ng√†y mai ph√°t cho h·ªçc sinh.", impact: "üí∞ -300k | ‚è±Ô∏è 0 ng√†y", next: "calc_ending", effect: { money: -300000, morale: 10, quality: 20 } }
            ]
        },

        // --- ENDINGS ---
        gameover_money: { text: "GAME OVER: V·ª† N·ª¢ T√ÄI CH√çNH üí∏", isEnd: true, color: "var(--danger)" },
        gameover_time: { text: "GAME OVER: TR·ªÑ DEADLINE ‚è±Ô∏è", isEnd: true, color: "var(--danger)" },
        gameover_morale: { text: "GAME OVER: NH√ìM TAN R√É üò°", isEnd: true, color: "var(--danger)" },
        end_bad: { text: "K·∫æT TH√öC: D·ª∞ √ÅN T·ªíI T·ªÜ üèöÔ∏è<br>ƒê√∫ng h·∫°n, ƒë√∫ng ti·ªÅn nh∆∞ng th∆∞ vi·ªán r√°ch n√°t. L·ª±a ch·ªçn l·∫•p li·∫øm ƒë√£ ph·∫£i tr·∫£ gi√°.", isEnd: true, color: "var(--danger)" },
        end_normal: { text: "K·∫æT TH√öC: ƒê·∫†T Y√äU C·∫¶U üëç<br>Ho√†n th√†nh an to√†n. ƒê·ªß ƒë·ªÉ ghi nh·∫≠n n·ªó l·ª±c c·ªßa t·∫≠p th·ªÉ.", isEnd: true, color: "var(--warning)" },
        end_perfect: { text: "K·∫æT TH√öC: HUY·ªÄN THO·∫†I M√ôA H√à XANH üèÜ<br>T√†i ch√≠nh minh b·∫°ch, ƒë√∫ng ti·∫øn ƒë·ªô, th∆∞ vi·ªán tuy·ªát ƒë·∫πp!", isEnd: true, color: "var(--border-gold)" }
    };

    const staticEvents = [
        { title: "‚õàÔ∏è M∆ØA B√ÉO!", desc: "M∆∞a l·ªõn l√†m gi√°n ƒëo·∫°n v·∫≠t li·ªáu. Nh√≥m ngh·ªâ 1 ng√†y.", type: "bad", effect: { time: -1, morale: -5 } },
        { title: "üí∏ M·∫§T V√ç TI·ªÄN!", desc: "M·ªôt th√†nh vi√™n ƒë√°nh r∆°i v√≠. Tr√≠ch qu·ªπ ƒë·ªÅn b√π.", type: "bad", effect: { money: -300000, morale: -10 } },
        { title: "üßã T√ÄI TR·ª¢!", desc: "Ph·ª• huynh mang tr√† s·ªØa ƒë·∫øn b·ªìi d∆∞·ª°ng. Anh em sung s·ª©c!", type: "good", effect: { morale: +25, quality: +5 } }
    ];

    // ==========================================
    // 4. H√ÄM C·ªêT L√ïI: G·ªåI GEMINI API (C√ì T·ª∞ ƒê·ªòNG XOAY V√íNG KEY)
    // ==========================================
    async function callGemini(promptText, retryCount = 0) {
        if (!USE_AI || apiBunker.length === 0) return null;
        if (retryCount >= apiBunker.length) {
            console.warn("To√†n b·ªô API Key ƒë·ªÅu l·ªói (Rate limit). Chuy·ªÉn sang Fallback Tƒ©nh.");
            return null;
        }

        const activeKey = apiBunker[currentKeyIndex];
        try {
            const genAI = new GoogleGenerativeAI(activeKey);
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const result = await model.generateContent(promptText);
            let text = result.response.text().replace(/```json|```/g, "").trim();
            return JSON.parse(text); 
        } catch (error) {
            console.warn(`Key s·ªë ${currentKeyIndex + 1} l·ªói:`, error.message);
            // Xoay v√≤ng qua key ti·∫øp theo
            currentKeyIndex = (currentKeyIndex + 1) % apiBunker.length;
            return callGemini(promptText, retryCount + 1); 
        }
    }

    // ==========================================
    // 5. AI ƒê·∫†O DI·ªÑN: T·∫†O S·ª∞ KI·ªÜN ƒê√ÅNH C∆Ø·ª¢C NG·∫™U NHI√äN
    // ==========================================
    async function fetchAIEvent() {
        const currentStats = `Qu·ªπ: ${state.money} VNƒê, Th·ªùi gian: ${state.time} ng√†y, Tinh th·∫ßn: ${state.morale}%`;
        const prompt = `B·∫°n l√† ƒê·∫°o di·ªÖn Game. Ch·ªâ s·ªë: ${currentStats}.
        T·∫°o 1 s·ª± ki·ªán ƒê√ÅNH C∆Ø·ª¢C sinh t·ª≠ c·ªßa h·ªçc sinh c·∫•p 3.
        TR·∫¢ V·ªÄ JSON DUY NH·∫§T:
        {
            "event_title": "T√™n s·ª± ki·ªán (IN HOA)", "event_description": "M√¥ t·∫£ h·∫•p d·∫´n",
            "gamble_choice": { "text": "Li·ªÅu m·∫°ng", "win_rate": 40, "win_effect": {"money": 1000000, "time": 0, "morale": 20}, "lose_effect": {"money": -500000, "time": -1, "morale": -20} },
            "safe_choice": { "text": "B·ªè qua an to√†n", "effect": {"morale": -5} }
        }`;
        return await callGemini(prompt);
    }

    // ==========================================
    // 6. AI BI√äN K·ªäCH: T·∫†O BI·∫æN TH·ªÇ K·ªäCH B·∫¢N CHO V√íNG CH∆†I
    // ==========================================
    async function fetchDynamicStage(stageId) {
        const base = story[stageId];
        if (!base || !base.theme) return null; // N·∫øu l√† m√†n ending th√¨ b·ªè qua

        // ƒê·ªãnh d·∫°ng c·∫•u tr√∫c cho AI tu√¢n theo ƒë·ªÉ n√∫t chuy·ªÉn Map (Next) kh√¥ng b·ªã l·ªói
        const nextId = base.choices[0].next; 
        const prompt = `
        B·∫°n l√† Bi√™n k·ªãch Game. 
        Nhi·ªám v·ª•: Vi·∫øt m·ªôt t√¨nh hu·ªëng M·ªöI TOANH d·ª±a tr√™n ch·ªß ƒë·ªÅ: "${base.theme}". 
        Kh√¥ng ƒë∆∞·ª£c l·∫∑p l·∫°i t√¨nh hu·ªëng g·ªëc ("${base.text}"). H√£y s√°ng t·∫°o m·ªôt r·∫Øc r·ªëi th·ª±c t·∫ø kh√°c c·ªßa h·ªçc sinh l√†m d·ª± √°n.
        
        T·∫°o 3 l·ª±a ch·ªçn (A: T·ªën ti·ªÅn nh√†n h·∫°, B: Ti·∫øt ki·ªám nh∆∞ng c·ª±c kh·ªï/t·ªën th·ªùi gian, C: S√°ng t·∫°o/L∆∞∆°n l·∫πo).
        Lu·∫≠t ·∫®N CH·ªà S·ªê: Kh√¥ng ghi Morale hay Quality v√†o ph·∫ßn 'impact'.

        TR·∫¢ V·ªÄ JSON DUY NH·∫§T ƒê√öNG FORMAT N√ÄY:
        {
            "text": "<b>[T√äN GIAI ƒêO·∫†N T·ª∞ ƒê·∫∂T]</b><br>[M√¥ t·∫£ r·∫Øc r·ªëi m·ªõi...]",
            "image": "https://images.unsplash.com/photo-1522071820081-009f0129c71c?auto=format&fit=crop&q=80&w=800",
            "choices": [
                { "text": "A. [M√¥ t·∫£ l·ª±a ch·ªçn A]", "impact": "üí∞ -X k | ‚è±Ô∏è -Y ng√†y", "next": "${nextId}", "effect": {"money": -2000000, "time": -1, "morale": 10, "quality": 15} },
                { "text": "B. [M√¥ t·∫£ l·ª±a ch·ªçn B]", "impact": "üí∞ -X k | ‚è±Ô∏è -Y ng√†y", "next": "${nextId}", "effect": {"money": -200000, "time": -4, "morale": -20, "quality": 5} },
                { "text": "C. [M√¥ t·∫£ l·ª±a ch·ªçn C]", "impact": "üí∞ -X k | ‚è±Ô∏è -Y ng√†y", "next": "${nextId}", "effect": {"money": -500000, "time": -2, "morale": -5, "quality": 20} }
            ]
        }`;
        return await callGemini(prompt);
    }

    // ==========================================
    // 7. ENGINE ƒêI·ªÄU PH·ªêI (CORE)
    // ==========================================
    function updateUI() {
        document.getElementById("money").innerText = state.money.toLocaleString('vi-VN');
        document.getElementById("time").innerText = state.time;
        document.getElementById("morale").innerText = state.morale;
        
        document.getElementById("money-container").className = state.money < 1000000 ? "stat danger" : "stat";
        document.getElementById("time-container").className = state.time <= 3 ? "stat danger" : "stat";
        document.getElementById("morale-container").className = state.morale <= 30 ? "stat danger" : "stat";
    }

    function checkGameOver() {
        if (state.money < 0) return "gameover_money";
        if (state.time < 0) return "gameover_time";
        if (state.morale < 20) return "gameover_morale";
        return null;
    }

    function handleEventResult(effect, nextStageId) {
        state.money += effect.money || 0;
        state.time += effect.time || 0;
        state.morale += effect.morale || 0;
        state.quality += effect.quality || 0;
        updateUI();
        
        document.getElementById("event-overlay").style.display = "none";
        
        const fail = checkGameOver();
        if(fail) renderScene(fail);
        else prepareAndRenderNextStage(nextStageId);
    }

    async function triggerRandomEvent(nextStageId) {
        if (Math.random() > 0.35) {
            prepareAndRenderNextStage(nextStageId);
            return;
        }

        const overlay = document.getElementById("event-overlay");
        const loading = document.getElementById("loading-overlay");
        const titleTag = document.getElementById("event-title");
        const descTag = document.getElementById("event-desc");
        const btnBox = document.getElementById("event-buttons");
        
        document.getElementById("loading-text").innerText = "AI ƒêANG ƒê·∫∫ RA KI·∫æP N·∫†N...";
        loading.style.display = "flex"; 

        const aiData = await fetchAIEvent();
        loading.style.display = "none"; 
        btnBox.innerHTML = ""; 

        if (aiData) {
            titleTag.innerText = "üé≤ " + aiData.event_title;
            titleTag.style.color = "var(--warning)";
            descTag.innerHTML = `<i>${aiData.event_description}</i><br><br><b>T·ªâ l·ªá th·∫Øng c√° c∆∞·ª£c: ${aiData.gamble_choice.win_rate}%</b>`;

            const btnLi·ªÅu = document.createElement("button");
            btnLi·ªÅu.style.borderColor = "var(--warning)";
            btnLi·ªÅu.innerHTML = `üî• ${aiData.gamble_choice.text}`;
            btnLi·ªÅu.onclick = () => {
                const roll = Math.floor(Math.random() * 100) + 1;
                if (roll <= aiData.gamble_choice.win_rate) {
                    alert("üéâ ƒê·∫†I TH·∫ÆNG! B·∫†N V·ª™A TR√öNG QU·∫¢ ƒê·∫¨M!");
                    handleEventResult(aiData.gamble_choice.win_effect, nextStageId);
                } else {
                    alert("üíÄ OAN NGHI·ªÜT! B·∫†N ƒê√É THUA S·∫†CH!");
                    handleEventResult(aiData.gamble_choice.lose_effect, nextStageId);
                }
            };
            const btnAnToan = document.createElement("button");
            btnAnToan.innerHTML = `üõ°Ô∏è ${aiData.safe_choice.text}`;
            btnAnToan.onclick = () => handleEventResult(aiData.safe_choice.effect, nextStageId);

            btnBox.appendChild(btnLi·ªÅu);
            btnBox.appendChild(btnAnToan);
        } else {
            const staticEv = staticEvents[Math.floor(Math.random() * staticEvents.length)];
            titleTag.innerText = staticEv.title;
            titleTag.style.color = staticEv.type === "bad" ? "var(--danger)" : "var(--success)";
            descTag.innerText = staticEv.desc;

            if(staticEv.type === "bad") {
                document.getElementById("game-container").classList.add("shake");
                setTimeout(() => document.getElementById("game-container").classList.remove("shake"), 600);
            }
            const btnOk = document.createElement("button");
            btnOk.innerHTML = "Ch·∫•p nh·∫≠n th·ª±c t·∫ø";
            btnOk.style.width = "100%";
            btnOk.onclick = () => handleEventResult(staticEv.effect, nextStageId);
            btnBox.appendChild(btnOk);
        }
        overlay.style.display = "flex"; 
    }

    // Ti·ªÅn x·ª≠ l√Ω: G·ªçi AI t·∫°o k·ªãch b·∫£n m·ªõi tr∆∞·ªõc khi render
    async function prepareAndRenderNextStage(stageId) {
        if (stageId === "calc_ending" || stageId.includes("gameover") || stageId.includes("end_")) {
            renderScene(stageId);
            return;
        }

        const loading = document.getElementById("loading-overlay");
        document.getElementById("loading-text").innerText = "AI ƒêANG T·∫†O K·ªäCH B·∫¢N ƒê·ªòC B·∫¢N...";
        loading.style.display = "flex";

        // Th·ª≠ g·ªçi AI t·∫°o bi·∫øn th·ªÉ (Variation)
        const dynamicData = await fetchDynamicStage(stageId);
        if (dynamicData) {
            dynamicStory[stageId] = dynamicData; // L∆∞u v√†o kho ƒë·ªông
        }
        
        loading.style.display = "none";
        renderScene(stageId);
    }

    function renderScene(sceneId) {
        if (sceneId === "calc_ending") {
            const fail = checkGameOver();
            if(fail) sceneId = fail;
            else {
                if (state.quality < 60) sceneId = "end_bad";
                else if (state.quality < 110) sceneId = "end_normal";
                else sceneId = "end_perfect";
            }
        }

        // ∆Øu ti√™n d√πng k·ªãch b·∫£n ƒê·ªông (AI t·∫°o), n·∫øu kh√¥ng c√≥ m·ªõi d√πng Tƒ©nh
        const scene = dynamicStory[sceneId] || story[sceneId];
        
        const textDiv = document.getElementById("story-text");
        const choicesDiv = document.getElementById("choices");
        const imgContainer = document.getElementById("image-container");
        
        if (scene.image) {
            document.getElementById("scene-image").src = scene.image;
            imgContainer.style.display = "block";
        } else {
            imgContainer.style.display = "none";
        }

        textDiv.innerHTML = scene.text;
        textDiv.classList.remove("fade-in");
        void textDiv.offsetWidth;
        textDiv.classList.add("fade-in");
        choicesDiv.innerHTML = "";

        if (scene.isEnd || story[sceneId].isEnd) { // Check c·∫£ g·ªëc l·ª° dynamicStory kh√¥ng c√≥ c·ªù isEnd
            const endText = scene.text || story[sceneId].text;
            const endColor = scene.color || story[sceneId].color;
            document.getElementById("game-container").style.borderColor = endColor;
            textDiv.innerHTML = `<h2 style="color: ${endColor}; text-align:center">${endText}</h2>`;
            const btn = document.createElement("button");
            btn.innerHTML = "<center>üîÑ <b>CH∆†I L·∫†I V·ªöI V≈® TR·ª§ KH√ÅC</b></center>";
            btn.onclick = () => location.reload();
            choicesDiv.appendChild(btn);
        } else {
            scene.choices.forEach(choice => {
                const btn = document.createElement("button");
                btn.innerHTML = `${choice.text} <span class="impact">${choice.impact}</span>`;
                btn.onclick = () => {
                    state.money += choice.effect.money || 0;
                    state.time += choice.effect.time || 0;
                    state.morale += choice.effect.morale || 0;
                    state.quality += choice.effect.quality || 0;
                    updateUI();

                    const failScene = checkGameOver();
                    if (failScene) {
                        renderScene(failScene);
                        return;
                    }

                    triggerRandomEvent(choice.next);
                };
                choicesDiv.appendChild(btn);
            });
        }
    }

    // Kh·ªüi ch·∫°y
    updateUI();
    prepareAndRenderNextStage("start");

</script>
</body>
</html>
