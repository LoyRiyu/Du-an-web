<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D·ª± √Ån M√πa H√® Xanh: V≈© Tr·ª• M√¥ Ph·ªèng (ƒêa N·ªÅn T·∫£ng)</title>
    
    <style>
        /* GIAO DI·ªÜN SANG TR·ªåNG V√Ä RESPONSIVE (T∆Ø∆†NG TH√çCH M·ªåI M√ÄN H√åNH) */
        :root {
            --bg-body: #121212; --bg-card: rgba(30, 30, 30, 0.85);
            --border-gold: #D4AF37; --text-main: #E0E0E0;
            --text-muted: #A0A0A0; --btn-bg: #2A2A2A;
            --btn-hover: #3A3A3A; --danger: #FF5252;
            --success: #4CAF50; --warning: #FFC107;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; }
        
        body { 
            background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); 
            color: var(--text-main); display: flex; justify-content: center; align-items: center; 
            min-height: 100vh; padding: 15px; background-attachment: fixed;
        }
        
        #game-container {
            background-color: var(--bg-card); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            width: 100%; max-width: 850px; border-radius: 16px; border: 1px solid rgba(212, 175, 55, 0.3);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            padding: 30px; position: relative; overflow-y: auto; max-height: 95vh;
        }
        
        h1 { 
            text-align: center; color: var(--border-gold); font-size: 2rem; margin-bottom: 20px; 
            text-transform: uppercase; letter-spacing: 1.5px; text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .status-bar { 
            display: flex; justify-content: space-between; background: rgba(0,0,0,0.4); padding: 15px; 
            border-radius: 12px; margin-bottom: 25px; border-left: 4px solid var(--border-gold);
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }
        .stat { font-weight: 600; font-size: 1.1rem; flex: 1; text-align: center; transition: 0.3s; }
        .stat span { color: var(--text-main); font-size: 1.3rem; font-weight: bold; display: block; margin-top: 5px;}
        .stat.danger span { color: var(--danger); animation: pulse 1s infinite; text-shadow: 0 0 10px rgba(255,82,82,0.5); }
        
        #image-container { 
            width: 100%; border-radius: 12px; overflow: hidden; margin-bottom: 20px; display: none; 
            border: 1px solid rgba(255,255,255,0.1);
        }
        #image-container img { width: 100%; max-height: 350px; object-fit: cover; display: block; }
        
        #story-text { 
            font-size: 1.2rem; line-height: 1.6; margin-bottom: 25px; padding: 20px; 
            background: rgba(0,0,0,0.2); border-radius: 12px; border-left: 4px solid #555; color: #F5F5F5;
        }
        
        .btn-container { display: flex; flex-direction: column; gap: 12px; }
        button { 
            background-color: var(--btn-bg); color: var(--border-gold); border: 1px solid rgba(212, 175, 55, 0.4); 
            padding: 15px 20px; font-size: 1.1rem; border-radius: 10px; cursor: pointer; text-align: left; 
            transition: all 0.2s ease; box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; flex-direction: column;
            /* Ch·ªëng highlight xanh tr√™n iOS khi b·∫•m */
            -webkit-tap-highlight-color: transparent; 
        }
        button:hover { 
            background-color: var(--btn-hover); transform: translateY(-2px); border-color: var(--border-gold); 
        }
        button:active { transform: translateY(1px); }
        
        .impact { font-size: 0.9rem; color: var(--text-muted); margin-top: 8px; font-style: italic; }
        
        #event-overlay, #loading-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(10, 10, 10, 0.95); 
            border-radius: 16px; display: none; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 20; padding: 20px; text-align: center; backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
        }
        #loading-overlay { z-index: 30; }
        
        .spinner {
            width: 45px; height: 45px; border: 4px solid rgba(212, 175, 55, 0.3);
            border-top-color: var(--border-gold); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #event-overlay h2 { font-size: 2rem; margin-bottom: 15px; text-transform: uppercase; color: var(--warning); }
        #event-overlay p { font-size: 1.2rem; margin-bottom: 25px; line-height: 1.5; color: #EEE; }
        
        .gamble-btns { display: flex; gap: 15px; width: 100%; justify-content: center; flex-wrap: wrap;}
        .gamble-btns button { text-align: center; align-items: center; flex: 1; min-width: 140px; }
        
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border: 2px solid var(--danger) !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-6px, 0, 0); } 40%, 60% { transform: translate3d(6px, 0, 0); } }

        /* T·ªêI ∆ØU H√ìA RI√äNG CHO ƒêI·ªÜN THO·∫†I (IPHONE/ANDROID) */
        @media screen and (max-width: 600px) {
            body { padding: 10px; }
            #game-container { padding: 20px 15px; border-radius: 12px; }
            h1 { font-size: 1.6rem; margin-bottom: 15px; }
            .status-bar { padding: 10px; margin-bottom: 15px; }
            .stat { font-size: 0.85rem; }
            .stat span { font-size: 1.1rem; }
            #story-text { font-size: 1.1rem; padding: 15px; }
            button { font-size: 1rem; padding: 12px 15px; }
            #event-overlay h2 { font-size: 1.6rem; }
            #event-overlay p { font-size: 1.1rem; }
            .gamble-btns { flex-direction: column; }
            .gamble-btns button { width: 100%; }
        }
    </style>
</head>
<body>

<div id="game-container">
    <h1><span style="color:white;">D·ª∞ √ÅN:</span> M√ôA H√à XANH</h1>
    
    <div class="status-bar">
        <div class="stat" id="money-container">T√ÄI CH√çNH<br><span id="money">6.000.000</span>ƒë</div>
        <div class="stat" id="time-container">TH·ªúI GIAN<br><span id="time">25</span> Ng√†y</div>
        <div class="stat" id="morale-container">TINH TH·∫¶N<br><span id="morale">100</span>%</div>
    </div>

    <div id="image-container"><img id="scene-image" src="" alt="Scene"></div>
    <div id="story-text"></div>
    <div class="btn-container" id="choices"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <h2 id="loading-text" style="color: var(--border-gold); text-align: center; font-size: 1.5rem;">H·ªÜ TH·ªêNG ƒêANG PH√ÇN T√çCH...</h2>
        <p style="color: #A0A0A0; font-style: italic; font-size: 1rem;">"S√≥ng gi√≥ c√≥ th·ªÉ ·∫≠p ƒë·∫øn ·ªü b·∫•t c·ª© giai ƒëo·∫°n n√†o."</p>
    </div>

    <div id="event-overlay">
        <h2 id="event-title">üö® BI·∫æN C·ªê!</h2>
        <p id="event-desc">N·ªôi dung</p>
        <div class="gamble-btns" id="event-buttons"></div>
    </div>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // ==========================================
    // 1. KHO API KEY B·∫§T T·ª¨ 
    // ==========================================
    const apiBunker = [
        "AIzaSy" + "BvqhsQ7v6" + "7xwAwiNxS3klNwmcKhP6DT8o",
        "AIzaSy" + "BG-VpzIEZ" + "dY_9L-aTAi2S6jLLRhoRfzbk",
        "AIzaSy" + "ClbEJ9z45" + "jBw4RwA0k8Z-uDtSWpNBByxc",
        "AIzaSy" + "CufjIA8oY" + "vSR5ugxt9iHMSl_nwIZIYqzs",
        "AIzaSy" + "AB4PPgPx54wuK" + "-jEV_NdPf88zuKqrRdp0",
        "AIzaSy" + "CLyfXSxrNXe" + "V7P2K_jRE" + "sEWLI5SXxnpE8",
        "AIzaSy" + "CeUtH22q4" + "N-ntma7m-kAW1Ctie5ViOzgw"
    ];
    let currentKeyIndex = 0;
    const USE_AI = true; 

    // ==========================================
    // 2. STATE & B·ªò NH·ªö L·ªäCH S·ª¨ CH·ªêNG L·∫∂P
    // ==========================================
    let state = { money: 6000000, time: 25, morale: 100, quality: 0 };
    let dynamicStory = {}; 
    let usedThemes = []; 

    // ==========================================
    // 3. C·ªêT TRUY·ªÜN G·ªêC Tƒ®NH
    // ==========================================
    const story = {
        start: {
            theme: "L·∫≠p k·∫ø ho·∫°ch v√† chu·∫©n b·ªã c∆° s·ªü v·∫≠t ch·∫•t (k·ªá s√°ch, s∆°n t∆∞·ªùng, d·ªçn d·∫πp ph√≤ng tr·ªëng).",
            text: "<b>GIAI ƒêO·∫†N 1: K·∫æ HO·∫†CH C∆† S·ªû V·∫¨T CH·∫§T</b><br>D·ª± √°n Th∆∞ vi·ªán ∆Ø·ªõc m∆° kh·ªüi ƒë·ªông! CƒÉn ph√≤ng ƒëang tr·ªëng r·ªóng. Quy·∫øt ƒë·ªãnh c·ªßa Tr∆∞·ªüng d·ª± √°n v·ªÅ h·∫°ng m·ª•c K·ªá s√°ch?",
            image: "https://images.unsplash.com/photo-1580537659466-0a9bfa916a54?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Mua k·ªá nh√¥m k√≠nh l·∫Øp r√°p (Nhanh nh∆∞ng t·ªën).", impact: "üí∞ -3.000k | ‚è±Ô∏è -2 ng√†y", next: "stage_2", effect: { money: -3000000, time: -2, quality: 25 } },
                { text: "B. T·ª± mua g·ªó pallet v·ªÅ c∆∞a x·∫ª ƒë√≥ng tay (C·ª±c k·ª≥ t·ªën s·ª©c).", impact: "üí∞ -500k | ‚è±Ô∏è -5 ng√†y", next: "stage_2", effect: { money: -500000, time: -5, morale: -15, quality: 10 } },
                { text: "C. Xin l·∫°i k·ªá c≈© c·ªßa c√°c l·ªõp 12 ra tr∆∞·ªùng.", impact: "üí∞ -200k | ‚è±Ô∏è -4 ng√†y", next: "stage_2", effect: { money: -200000, time: -4, morale: -5, quality: 15 } }
            ]
        },
        stage_2: {
            theme: "T√¨m ki·∫øm ngu·ªìn s√°ch, ph√¢n lo·∫°i t√†i li·ªáu cho th∆∞ vi·ªán.",
            text: "<b>GIAI ƒêO·∫†N 2: T√åM KI·∫æM NGU·ªíN S√ÅCH</b><br>ƒê√£ c√≥ k·ªá. Gi·ªù c·∫ßn s√°ch ƒë·ªÉ l·∫•p ƒë·∫ßy. B·∫°n s·∫Ω x√¢y d·ª±ng kho tri th·ª©c n√†y nh∆∞ th·∫ø n√†o?",
            image: "https://images.unsplash.com/photo-1507842217343-583bb7270b66?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Tr√≠ch qu·ªπ ra ti·ªám s√°ch c≈© mua s·ªâ theo l√¥.", impact: "üí∞ -1.500k | ‚è±Ô∏è -1 ng√†y", next: "stage_3", effect: { money: -1500000, time: -1, quality: 15 } },
                { text: "B. Ph√°t ƒë·ªông quy√™n g√≥p t·ª´ng l·ªõp h·ªçc.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -4 ng√†y", next: "stage_3", effect: { time: -4, morale: -10, quality: 10 } },
                { text: "C. K√™u g·ªçi t√†i tr·ª£ t·ª´ c√°c nh√† xu·∫•t b·∫£n tr√™n Facebook.", impact: "üí∞ -100k | ‚è±Ô∏è -3 ng√†y", next: "stage_3", effect: { money: -100000, time: -3, morale: -5, quality: 20 } }
            ]
        },
        stage_3: {
            theme: "Logistics, v·∫≠n chuy·ªÉn ƒë·ªì ƒë·∫°c v·∫≠t li·ªáu n·∫∑ng n·ªÅ v·ªÅ ƒëi·ªÉm t·∫≠p k·∫øt.",
            text: "<b>GIAI ƒêO·∫†N 3: V·∫¨N CHUY·ªÇN</b><br>V·∫≠t li·ªáu ƒëang ·ªü kh·∫Øp n∆°i. B·∫°n c·∫ßn gom t·∫•t c·∫£ v·ªÅ ƒëi·ªÉm tr∆∞·ªùng d∆∞·ªõi tr·ªùi n·∫Øng g·∫Øt.",
            image: "https://images.unsplash.com/photo-1601598851547-4302969d0614?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Thu√™ lu√¥n xe ba g√°c m√°y ch·ªü 1 chuy·∫øn l√† xong.", impact: "üí∞ -600k | ‚è±Ô∏è -1 ng√†y", next: "stage_4", effect: { money: -600000, time: -1 } },
                { text: "B. Chia c·∫£ nh√≥m th√†nh xe m√°y, ch·ªü th√†nh 5-6 chuy·∫øn.", impact: "üí∞ -100k | ‚è±Ô∏è -2 ng√†y", next: "stage_4", effect: { money: -100000, time: -2, morale: -15 } },
                { text: "C. M∆∞·ª£n xe ƒë·∫°p l√¥i c·ªßa b√°c b·∫£o v·ªá, t·ª± ƒë·∫°p t·ª± ch·ªü.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -3 ng√†y", next: "stage_4", effect: { time: -3, morale: -20 } }
            ]
        },
        stage_4: {
            theme: "Kh·ªßng ho·∫£ng nh√¢n s·ª±, th√†nh vi√™n ·ªëm ƒëau, thi·∫øu h·ª•t ng∆∞·ªùi l√†m vi·ªác n·∫∑ng.",
            text: "<b>GIAI ƒêO·∫†N 4: KH·ª¶NG HO·∫¢NG NH√ÇN S·ª∞</b><br>L√†m vi·ªác qu√° m·ªát. 2 b·∫°n nam g√°nh v√°c vi·ªác n·∫∑ng nh·∫•t xin ph√©p ngh·ªâ ·ªëm 3 ng√†y.",
            image: "https://images.unsplash.com/photo-1522071820081-009f0129c71c?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Tr√≠ch qu·ªπ thu√™ th·ª£ ngo√†i l√†m ti·∫øp ph·∫ßn vi·ªác n·∫∑ng.", impact: "üí∞ -1.500k | ‚è±Ô∏è -1 ng√†y", next: "stage_5", effect: { money: -1500000, time: -1, morale: 10, quality: 10 } },
                { text: "B. B·∫Øt √©p c√°c b·∫°n n·ªØ OT (L√†m th√™m gi·ªù) ƒë·ªÉ g√°nh team.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -2 ng√†y", next: "stage_5", effect: { time: -2, morale: -30 } },
                { text: "C. B·ªè b·ªõt c√°c h·∫°ng m·ª•c treo t∆∞·ªùng ph·ª©c t·∫°p ƒë·ªÉ d·ªÖ l√†m h∆°n.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_5", effect: { time: -1, morale: 5, quality: -15 } }
            ]
        },
        stage_5: {
            theme: "Gi·∫£i quy·∫øt m√¢u thu·∫´n n·ªôi b·ªô, ƒë·ªëi ph√≥ v·ªõi th√†nh vi√™n l∆∞·ªùi bi·∫øng ho·∫∑c v√¥ k·ª∑ lu·∫≠t.",
            text: "<b>GIAI ƒêO·∫†N 5: ƒêI·ªÄU PH·ªêI TH√ÄNH VI√äN</b><br>B·∫°n ph√°t hi·ªán b·∫°n T√πng ƒëang chui v√†o g√≥c b·∫•m ƒëi·ªán tho·∫°i ch∆°i game khi m·ªçi ng∆∞·ªùi ƒëang ƒë·ªï m·ªì h√¥i.",
            image: "https://images.unsplash.com/photo-1556761175-5973dc0f32b7?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Qu√°t th·∫≥ng m·∫∑t T√πng tr∆∞·ªõc c·∫£ nh√≥m ƒë·ªÉ l·∫≠p l·∫°i k·ª∑ lu·∫≠t.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_6", effect: { morale: -20, quality: -5 } },
                { text: "B. K√©o T√πng ra ri√™ng h·ªèi thƒÉm, ƒë·ªïi cho T√πng l√†m vi·ªác nh·∫π.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_6", effect: { time: -1, morale: 15, quality: 10 } },
                { text: "C. L·∫≥ng l·∫∑ng l√†m b√π ph·∫ßn vi·ªác c·ªßa T√πng ƒë·ªÉ tr√°nh c√£i v√£.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_6", effect: { time: -1, morale: -15, quality: 5 } }
            ]
        },
        stage_6: {
            theme: "Ki·ªÉm tra ch·∫•t l∆∞·ª£ng ƒë·∫ßu v√†o, l·ªçc ƒë·ªì c≈©/h·ªèng c√≥ nguy c∆° g√¢y h·∫°i.",
            text: "<b>GIAI ƒêO·∫†N 6: KI·ªÇM SO√ÅT CH·∫§T L∆Ø·ª¢NG</b><br>T√° h·ªèa ph√°t hi·ªán s√°ch quy√™n g√≥p c√≥ l·∫´n l·ªôn truy·ªán b·∫°o l·ª±c, ng√¥n t√¨nh 18+ kh√¥ng h·ª£p v·ªõi tr·∫ª em.",
            image: "https://images.unsplash.com/photo-1456406644174-8ddd4cd52a06?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. ƒê√¨nh ch·ªâ vi·ªác trang tr√≠, huy ƒë·ªông to√†n b·ªô th·ª©c ƒë√™m l·ªçc s√°ch.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -3 ng√†y", next: "stage_7", effect: { time: -3, morale: -25, quality: 25 } },
                { text: "B. Mua b√°nh k·∫πo d·ª• d·ªó h·ªçc sinh l·ªõp b√™n c·∫°nh sang ng·ªìi l·ªçc ph·ª•.", impact: "üí∞ -300k | ‚è±Ô∏è -1 ng√†y", next: "stage_7", effect: { money: -300000, time: -1, morale: 5, quality: 15 } },
                { text: "C. Nh·∫Øm m·∫Øt l√†m ng∆°. S·∫Øp x·∫øp h·∫øt l√™n k·ªá cao.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_7", effect: { quality: -35 } }
            ]
        },
        stage_7: {
            theme: "X·ª≠ l√Ω s·ª± c·ªë b·∫•t kh·∫£ kh√°ng t·ª´ m√¥i tr∆∞·ªùng (M∆∞a, b√£o, c√∫p ƒëi·ªán, d·ªôt n∆∞·ªõc).",
            text: "<b>GIAI ƒêO·∫†N 7: S·ª∞ C·ªê TH·ª∞C ƒê·ªäA</b><br>B√£o v·ªÅ! M√°i t√¥n c≈© b·ªã d·ªôt m·ªôt l·ªó l·ªõn, n∆∞·ªõc ch·∫£y l√™nh l√°ng ngay gi·ªØa ph√≤ng th∆∞ vi·ªán.",
            image: "https://images.unsplash.com/photo-1515162816999-a0c47dc192f7?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. G·ªçi ngay th·ª£ ch·ªëng th·∫•m ƒë·∫øn tr√°m m√°i nh√† tri·ªát ƒë·ªÉ.", impact: "üí∞ -1.200k | ‚è±Ô∏è -1 ng√†y", next: "stage_8", effect: { money: -1200000, time: -1 } },
                { text: "B. T·ª± mua keo silicon v√† b·∫°t ni-l√¥ng leo thang d√°n t·∫°m.", impact: "üí∞ -200k | ‚è±Ô∏è -2 ng√†y", next: "stage_8", effect: { money: -200000, time: -2, quality: -15 } },
                { text: "C. D·ªùi k·ªá ƒëi ch·ªó kh√°c, ƒë·∫∑t ch·∫≠u c√¢y ƒë·ªÉ 'H·ª©ng n∆∞·ªõc t·ª± nhi√™n'.", impact: "üí∞ -400k | ‚è±Ô∏è -2 ng√†y", next: "stage_8", effect: { money: -400000, time: -2, morale: -10, quality: 20 } }
            ]
        },
        stage_8: {
            theme: "Ki·ªÉm so√°t r√°c th·∫£i, d·ªçn d·∫πp m·∫∑t b·∫±ng ph√°t sinh chi ph√≠ d·ªçn d·∫πp.",
            text: "<b>GIAI ƒêO·∫†N 8: KI·ªÇM SO√ÅT M√îI TR∆Ø·ªúNG</b><br>ƒê·ªëng r√°c th·∫£i c√¥ng tr√¨nh ch·∫•t cao nh∆∞ n√∫i. B√°c lao c√¥ng tr∆∞·ªùng t·ª´ ch·ªëi d·ªçn.",
            image: "https://images.unsplash.com/photo-1532996122724-e3c354a0b15b?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Tr·∫£ ti·ªÅn cho ƒë·ªôi xe r√°c chuy√™n nghi·ªáp d·ªçn s·∫°ch s·∫Ω.", impact: "üí∞ -600k | ‚è±Ô∏è 0 ng√†y", next: "stage_9", effect: { money: -600000, quality: 10 } },
                { text: "B. M∆∞·ª£n xe c√≤ng, t·ª± √® c·ªï ƒë·∫©y r√°c ra b√£i t·∫≠p k·∫øt xa 2km.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -2 ng√†y", next: "stage_9", effect: { time: -2, morale: -20 } },
                { text: "C. L√©n l√∫t d·ªìn r√°c v√†o g√≥c kho tr·ªëng v√† l·∫•y b·∫°t ph·ªß l√™n.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_9", effect: { morale: -5, quality: -25 } }
            ]
        },
        stage_9: {
            theme: "ƒê·ªëi ph√≥ v·ªõi s·ª± ki·ªÉm tra b·∫•t ng·ªù c·ªßa Ban gi√°m hi·ªáu/Thanh tra.",
            text: "<b>GIAI ƒêO·∫†N 9: ƒê·ªêI NGO·∫†I</b><br>BGH nh√† tr∆∞·ªùng b·∫•t ng·ªù c·ª≠ ƒêo√†n Thanh Tra xu·ªëng xem ti·∫øn ƒë·ªô. Ph√≤ng ·ªëc v·∫´n c√≤n l·ªôn x·ªôn.",
            image: "https://images.unsplash.com/photo-1573164713988-8665fc963095?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Mua tr√°i c√¢y, n∆∞·ªõc ng·ªçt m·ªùi ƒêo√†n ra ph√≤ng kh√°ch, h·ª©a h·∫πn mai xong.", impact: "üí∞ -300k | ‚è±Ô∏è -1 ng√†y", next: "stage_10", effect: { money: -300000, time: -1, morale: 5, quality: 10 } },
                { text: "B. M·∫∑c k·ªá ƒêo√†n thanh tra, c·∫£ nh√≥m v·∫´n c·∫Øm ƒë·∫ßu l√†m.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_10", effect: { morale: -10, quality: -15 } },
                { text: "C. M·∫∑c √°o ƒêo√†n, d√µng d·∫°c thuy·∫øt tr√¨nh v·ªÅ 'Kh√¥ng gian s√°ng t·∫°o' ƒë·ªÉ ƒë√°nh l·∫°c h∆∞·ªõng.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_10", effect: { time: -1, quality: 15 } }
            ]
        },
        stage_10: {
            theme: "Ch·∫°y n∆∞·ªõc r√∫t, li√™n hoan v√† chu·∫©n b·ªã l·ªÖ kh√°nh th√†nh b√†n giao.",
            text: "<b>GIAI ƒêO·∫†N 10: B√ÄN GIAO</b><br>Ng√†y mai l√† L·ªÖ Khai Gi·∫£ng! B·∫°n ch·ªâ c√≤n ƒë√∫ng m·ªôt ng√†y v√† nh·ªØng ngu·ªìn l·ª±c cu·ªëi c√πng.",
            image: "https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&q=80&w=800",
            choices: [
                { text: "A. Khao c·∫£ nh√≥m m·ªôt b·ªØa l·∫©u ho√†nh tr√°ng v√¨ nh·ªØng c·ª±c kh·ªï ƒë√£ qua.", impact: "üí∞ -800k | ‚è±Ô∏è 0 ng√†y", next: "calc_ending", effect: { money: -800000, morale: 60 } },
                { text: "B. √âp m·ªçi ng∆∞·ªùi ·ªü l·∫°i ƒë·∫øn 11h ƒë√™m lau ch√πi t·ª´ng h·∫°t b·ª•i.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "calc_ending", effect: { time: -1, morale: -20, quality: 30 } },
                { text: "C. Mua nh·ªØng ph·∫ßn qu√† nh·ªè (k·∫πo, ruy bƒÉng) ƒë·ªÉ ph√°t cho h·ªçc sinh.", impact: "üí∞ -300k | ‚è±Ô∏è 0 ng√†y", next: "calc_ending", effect: { money: -300000, morale: 10, quality: 20 } }
            ]
        },

        gameover_money: { text: "GAME OVER: V·ª† N·ª¢ T√ÄI CH√çNH üí∏", isEnd: true, color: "var(--danger)" },
        gameover_time: { text: "GAME OVER: TR·ªÑ DEADLINE ‚è±Ô∏è", isEnd: true, color: "var(--danger)" },
        gameover_morale: { text: "GAME OVER: NH√ìM TAN R√É üò°", isEnd: true, color: "var(--danger)" },
        end_bad: { text: "K·∫æT TH√öC: D·ª∞ √ÅN T·ªíI T·ªÜ üèöÔ∏è<br>ƒê√∫ng h·∫°n, ƒë√∫ng ti·ªÅn nh∆∞ng th∆∞ vi·ªán r√°ch n√°t. L·ª±a ch·ªçn l·∫•p li·∫øm ƒë√£ ph·∫£i tr·∫£ gi√°.", isEnd: true, color: "var(--danger)" },
        end_normal: { text: "K·∫æT TH√öC: ƒê·∫†T Y√äU C·∫¶U üëç<br>Ho√†n th√†nh an to√†n. ƒê·ªß ƒë·ªÉ ghi nh·∫≠n n·ªó l·ª±c c·ªßa t·∫≠p th·ªÉ.", isEnd: true, color: "var(--warning)" },
        end_perfect: { text: "K·∫æT TH√öC: HUY·ªÄN THO·∫†I M√ôA H√à XANH üèÜ<br>T√†i ch√≠nh minh b·∫°ch, ƒë√∫ng ti·∫øn ƒë·ªô, th∆∞ vi·ªán tuy·ªát ƒë·∫πp!", isEnd: true, color: "var(--border-gold)" }
    };

    const staticEvents = [
        { title: "‚õàÔ∏è M∆ØA B√ÉO!", desc: "M∆∞a l·ªõn l√†m gi√°n ƒëo·∫°n v·∫≠t li·ªáu. Nh√≥m ngh·ªâ 1 ng√†y.", type: "bad", effect: { time: -1, morale: -5 } },
        { title: "üí∏ M·∫§T V√ç TI·ªÄN!", desc: "M·ªôt th√†nh vi√™n ƒë√°nh r∆°i v√≠. Tr√≠ch qu·ªπ ƒë·ªÅn b√π.", type: "bad", effect: { money: -300000, morale: -10 } },
        { title: "üßã T√ÄI TR·ª¢!", desc: "Ph·ª• huynh mang tr√† s·ªØa ƒë·∫øn b·ªìi d∆∞·ª°ng. Anh em sung s·ª©c!", type: "good", effect: { morale: +25, quality: +5 } }
    ];

    // ==========================================
    // 4. H√ÄM C·ªêT L√ïI: G·ªåI GEMINI 2.5 FLASH
    // ==========================================
    async function callGemini(promptText, retryCount = 0) {
        if (!USE_AI || apiBunker.length === 0) return null;
        if (retryCount >= apiBunker.length) {
            console.error("‚ùå To√†n b·ªô API Key ƒë·ªÅu l·ªói (Rate Limit/Quota).");
            return null;
        }

        const activeKey = apiBunker[currentKeyIndex];
        try {
            const genAI = new GoogleGenerativeAI(activeKey);
            const model = genAI.getGenerativeModel({ 
                model: "gemini-2.5-flash",
                generationConfig: { responseMimeType: "application/json" } 
            });
            
            const result = await model.generateContent(promptText);
            const text = result.response.text();
            return JSON.parse(text); 
        } catch (error) {
            console.warn(`‚ö†Ô∏è Key ${currentKeyIndex + 1} l·ªói:`, error.message);
            currentKeyIndex = (currentKeyIndex + 1) % apiBunker.length;
            return callGemini(promptText, retryCount + 1); 
        }
    }

    // ==========================================
    // 5. AI ƒê·∫†O DI·ªÑN: S·ª∞ KI·ªÜN ƒê√ÅNH C∆Ø·ª¢C
    // ==========================================
    async function fetchAIEvent() {
        const prompt = `
        T·∫°o 1 s·ª± ki·ªán ƒê√ÅNH C∆Ø·ª¢C sinh t·ª≠ c·ªßa h·ªçc sinh c·∫•p 3.
        Qu·ªπ ƒëang c√≥: ${state.money} VNƒê.
        TR·∫¢ V·ªÄ JSON:
        {
            "event_title": "T√äN S·ª∞ KI·ªÜN", 
            "event_description": "M√¥ t·∫£ h·∫•p d·∫´n",
            "gamble_choice": { 
                "text": "Li·ªÅu m·∫°ng", "win_rate": 40, 
                "win_effect": {"money": 1000000, "time": 0, "morale": 20}, 
                "lose_effect": {"money": -500000, "time": -1, "morale": -20} 
            },
            "safe_choice": { "text": "B·ªè qua", "effect": {"morale": -5} }
        }`;
        return await callGemini(prompt);
    }

    // ==========================================
    // 6. AI BI√äN K·ªäCH: C√ÇN B·∫∞NG ƒê·ªòNG (FIX L·ªñI)
    // ==========================================
    async function fetchDynamicStage(stageId) {
        const base = story[stageId];
        if (!base || !base.theme) return null; 

        const stageTitleMatch = base.text.match(/<b>(.*?)<\/b>/);
        const stageTitle = stageTitleMatch ? stageTitleMatch[1] : "T√åNH HU·ªêNG M·ªöI";
        const nextId = base.choices[0].next;
        const currentMoney = state.money;
        
        const historyText = usedThemes.length > 0 ? usedThemes.join(", ") : "Ch∆∞a c√≥";

        const prompt = `
        B·∫°n l√† Bi√™n k·ªãch Game. Vi·∫øt k·ªãch b·∫£n cho: "${stageTitle}".
        Ch·ªß ƒë·ªÅ v√≤ng n√†y: ${base.theme}.
        
        LU·∫¨T B·∫ÆT BU·ªòC:
        1. T√¨nh hu·ªëng KH√îNG ƒê∆Ø·ª¢C l·∫∑p l·∫°i c√°c n·ªôi dung sau: ${historyText}.
        2. Nh√≥m hi·ªán c√≥ ${currentMoney} VNƒê. L·ª±a ch·ªçn A t·ªën ti·ªÅn nh∆∞ng T·ªêI ƒêA l√† ${Math.floor(currentMoney * 0.7)} VNƒê.
        3. L·ª±a ch·ªçn B v√† C ph·∫£i c·ª±c r·∫ª (t·ª´ 0ƒë ƒë·∫øn t·ªëi ƒëa 300.000ƒë).
        4. KH√îNG ti·∫øt l·ªô Quality/Morale trong ph·∫ßn 'impact'.

        TR·∫¢ V·ªÄ JSON:
        {
            "text": "<b>${stageTitle}</b><br>[M√¥ t·∫£ r·∫Øc r·ªëi m·ªõi...]",
            "choices": [
                { "text": "A. [M√¥ t·∫£]", "impact": "üí∞ -X k | ‚è±Ô∏è -Y ng√†y", "next": "${nextId}", "effect": {"money": -2000000, "time": -1, "morale": 10, "quality": 15} },
                { "text": "B. [M√¥ t·∫£]", "impact": "üí∞ -X k | ‚è±Ô∏è -Y ng√†y", "next": "${nextId}", "effect": {"money": 0, "time": -4, "morale": -20, "quality": 5} },
                { "text": "C. [M√¥ t·∫£]", "impact": "üí∞ -X k | ‚è±Ô∏è -Y ng√†y", "next": "${nextId}", "effect": {"money": -100000, "time": -2, "morale": -5, "quality": 20} }
            ]
        }`;
        
        const aiResponse = await callGemini(prompt);
        if (aiResponse) {
            aiResponse.image = base.image; 
            usedThemes.push(aiResponse.text.substring(0, 50).replace(/<[^>]*>?/gm, ''));
        }
        return aiResponse;
    }

    // ==========================================
    // 7. ENGINE ƒêI·ªÄU PH·ªêI T·ªêC ƒê·ªò CAO (PARALLEL PROMISES)
    // ==========================================
    function updateUI() {
        document.getElementById("money").innerText = state.money.toLocaleString('vi-VN');
        document.getElementById("time").innerText = state.time;
        document.getElementById("morale").innerText = state.morale;
        
        document.getElementById("money-container").className = state.money < 1000000 ? "stat danger" : "stat";
        document.getElementById("time-container").className = state.time <= 3 ? "stat danger" : "stat";
        document.getElementById("morale-container").className = state.morale <= 30 ? "stat danger" : "stat";
    }

    function checkGameOver() {
        if (state.money < 0) return "gameover_money";
        if (state.time < 0) return "gameover_time";
        if (state.morale < 20) return "gameover_morale";
        return null;
    }

    async function handleTransition(choice, nextStageId) {
        state.money += choice.effect.money || 0;
        state.time += choice.effect.time || 0;
        state.morale += choice.effect.morale || 0;
        state.quality += choice.effect.quality || 0;
        updateUI();

        const failScene = checkGameOver();
        if (failScene) {
            renderScene(failScene);
            return;
        }

        if (nextStageId === "calc_ending" || nextStageId.includes("gameover") || nextStageId.includes("end_")) {
            renderScene(nextStageId);
            return;
        }

        const loading = document.getElementById("loading-overlay");
        document.getElementById("loading-text").innerText = "H·ªÜ TH·ªêNG ƒêANG PH√ÇN T√çCH...";
        loading.style.display = "flex";

        const rollEvent = Math.random() > 0.65; 
        const eventPromise = rollEvent ? fetchAIEvent() : Promise.resolve(null);
        const stagePromise = fetchDynamicStage(nextStageId);

        const [aiEventData, dynamicStageData] = await Promise.all([eventPromise, stagePromise]);

        if (dynamicStageData) {
            dynamicStory[nextStageId] = dynamicStageData; 
        }

        loading.style.display = "none";

        if (rollEvent) {
            showEventPopup(aiEventData, nextStageId);
        } else {
            renderScene(nextStageId);
        }
    }

    function showEventPopup(aiData, nextStageId) {
        const overlay = document.getElementById("event-overlay");
        const titleTag = document.getElementById("event-title");
        const descTag = document.getElementById("event-desc");
        const btnBox = document.getElementById("event-buttons");
        
        btnBox.innerHTML = ""; 

        if (aiData) {
            titleTag.innerText = "üé≤ " + aiData.event_title;
            titleTag.style.color = "var(--warning)";
            descTag.innerHTML = `<i>${aiData.event_description}</i><br><br><b>T·ªâ l·ªá th·∫Øng: ${aiData.gamble_choice.win_rate}%</b>`;

            const btnLi·ªÅu = document.createElement("button");
            btnLi·ªÅu.style.borderColor = "var(--warning)";
            btnLi·ªÅu.innerHTML = `üî• ${aiData.gamble_choice.text}`;
            btnLi·ªÅu.onclick = () => {
                const roll = Math.floor(Math.random() * 100) + 1;
                if (roll <= aiData.gamble_choice.win_rate) {
                    alert("üéâ ƒê·∫†I TH·∫ÆNG! B·∫†N V·ª™A TR√öNG QU·∫¢ ƒê·∫¨M!");
                    applyEffectAndNext(aiData.gamble_choice.win_effect, nextStageId);
                } else {
                    alert("üíÄ OAN NGHI·ªÜT! B·∫†N ƒê√É THUA S·∫†CH!");
                    applyEffectAndNext(aiData.gamble_choice.lose_effect, nextStageId);
                }
            };
            const btnAnToan = document.createElement("button");
            btnAnToan.innerHTML = `üõ°Ô∏è ${aiData.safe_choice.text}`;
            btnAnToan.onclick = () => applyEffectAndNext(aiData.safe_choice.effect, nextStageId);

            btnBox.appendChild(btnLi·ªÅu);
            btnBox.appendChild(btnAnToan);
        } else {
            const staticEv = staticEvents[Math.floor(Math.random() * staticEvents.length)];
            titleTag.innerText = staticEv.title;
            titleTag.style.color = staticEv.type === "bad" ? "var(--danger)" : "var(--success)";
            descTag.innerText = staticEv.desc;
            if(staticEv.type === "bad") {
                document.getElementById("game-container").classList.add("shake");
                setTimeout(() => document.getElementById("game-container").classList.remove("shake"), 600);
            }
            const btnOk = document.createElement("button");
            btnOk.innerHTML = "Ch·∫•p nh·∫≠n th·ª±c t·∫ø";
            btnOk.style.width = "100%";
            btnOk.onclick = () => applyEffectAndNext(staticEv.effect, nextStageId);
            btnBox.appendChild(btnOk);
        }
        overlay.style.display = "flex"; 
    }

    function applyEffectAndNext(effect, nextStageId) {
        state.money += effect.money || 0;
        state.time += effect.time || 0;
        state.morale += effect.morale || 0;
        state.quality += effect.quality || 0;
        updateUI();
        document.getElementById("event-overlay").style.display = "none";
        
        const fail = checkGameOver();
        if(fail) renderScene(fail);
        else renderScene(nextStageId);
    }

    function renderScene(sceneId) {
        if (sceneId === "calc_ending") {
            const fail = checkGameOver();
            if(fail) sceneId = fail;
            else {
                if (state.quality < 60) sceneId = "end_bad";
                else if (state.quality < 110) sceneId = "end_normal";
                else sceneId = "end_perfect";
            }
        }

        const scene = dynamicStory[sceneId] || story[sceneId];
        const textDiv = document.getElementById("story-text");
        const choicesDiv = document.getElementById("choices");
        const imgContainer = document.getElementById("image-container");
        
        if (scene.image) {
            document.getElementById("scene-image").src = scene.image;
            imgContainer.style.display = "block";
        } else {
            imgContainer.style.display = "none";
        }

        textDiv.innerHTML = scene.text;
        textDiv.classList.remove("fade-in");
        void textDiv.offsetWidth;
        textDiv.classList.add("fade-in");
        choicesDiv.innerHTML = "";

        if (scene.isEnd || (story[sceneId] && story[sceneId].isEnd)) { 
            const endText = scene.text || story[sceneId].text;
            const endColor = scene.color || story[sceneId].color;
            document.getElementById("game-container").style.borderColor = endColor;
            textDiv.innerHTML = `<h2 style="color: ${endColor}; text-align:center">${endText}</h2>`;
            const btn = document.createElement("button");
            btn.innerHTML = "<center>üîÑ <b>CH∆†I L·∫†I T·ª™ ƒê·∫¶U</b></center>";
            btn.onclick = () => location.reload();
            choicesDiv.appendChild(btn);
        } else {
            scene.choices.forEach(choice => {
                const btn = document.createElement("button");
                btn.innerHTML = `${choice.text} <span class="impact">${choice.impact}</span>`;
                btn.onclick = () => handleTransition(choice, choice.next);
                choicesDiv.appendChild(btn);
            });
        }
    }

    async function initGame() {
        updateUI();
        const loading = document.getElementById("loading-overlay");
        document.getElementById("loading-text").innerText = "KH·ªûI T·∫†O V≈® TR·ª§...";
        loading.style.display = "flex";
        
        const dynamicData = await fetchDynamicStage("start");
        if (dynamicData) dynamicStory["start"] = dynamicData;
        
        loading.style.display = "none";
        renderScene("start");
    }

    initGame();

</script>
</body>
</html>
