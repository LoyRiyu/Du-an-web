<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D·ª± √Ån M√πa H√® Xanh</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* =============================================
           DESIGN TOKENS
        ============================================= */
        :root {
            --gold:       #D4AF37;
            --gold-light: #F0D060;
            --gold-dim:   rgba(212,175,55,0.25);
            --gold-glow:  rgba(212,175,55,0.15);
            --bg-deep:    #0d1b2a;
            --bg-card:    rgba(18, 28, 42, 0.92);
            --bg-surface: rgba(255,255,255,0.04);
            --bg-hover:   rgba(255,255,255,0.07);
            --text-main:  #EDF2F7;
            --text-sub:   #94A3B8;
            --text-dim:   #64748B;
            --danger:     #F87171;
            --danger-bg:  rgba(248,113,113,0.08);
            --success:    #4ADE80;
            --success-bg: rgba(74,222,128,0.08);
            --warning:    #FBBF24;
            --warning-bg: rgba(251,191,36,0.08);
            --border:     rgba(255,255,255,0.08);
            --radius-sm:  8px;
            --radius-md:  12px;
            --radius-lg:  18px;
            --radius-xl:  24px;
            --shadow-card: 0 24px 60px rgba(0,0,0,0.6);
            --transition: all 0.22s cubic-bezier(0.4,0,0.2,1);
        }

        /* =============================================
           RESET & BASE
        ============================================= */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        html { font-size: 16px; -webkit-text-size-adjust: 100%; }

        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--bg-deep);
            background-image:
                radial-gradient(ellipse 80% 60% at 20% 10%, rgba(30,60,100,0.5) 0%, transparent 60%),
                radial-gradient(ellipse 60% 80% at 80% 90%, rgba(10,40,80,0.4) 0%, transparent 60%);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 16px;
        }

        /* =============================================
           START SCREEN
        ============================================= */
        #start-screen {
            position: fixed; inset: 0;
            background: var(--bg-deep);
            background-image:
                radial-gradient(ellipse 80% 60% at 20% 10%, rgba(30,60,100,0.6) 0%, transparent 60%),
                radial-gradient(ellipse 60% 80% at 80% 90%, rgba(10,40,80,0.5) 0%, transparent 60%);
            z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; padding: 24px;
            animation: fadeIn 0.6s ease;
        }

        .start-logo {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 6vw, 3.5rem);
            font-weight: 900;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 3px;
            line-height: 1.15;
            text-shadow: 0 0 40px rgba(212,175,55,0.4);
            margin-bottom: 6px;
        }
        .start-logo span { color: #fff; }

        .start-tagline {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            color: var(--text-sub);
            font-style: italic;
            max-width: 520px;
            line-height: 1.7;
            margin-bottom: 36px;
        }

        /* Brief stats row */
        .start-brief {
            display: flex; gap: 12px; flex-wrap: wrap;
            justify-content: center;
            margin-bottom: 40px;
        }
        .brief-chip {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: 50px;
            padding: 10px 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex; align-items: center; gap: 8px;
            backdrop-filter: blur(8px);
        }
        .brief-chip .chip-icon { font-size: 1.1rem; }

        .start-btn {
            font-family: 'Inter', sans-serif;
            padding: 18px 56px;
            font-size: clamp(1rem, 3vw, 1.25rem);
            font-weight: 700;
            background: transparent;
            color: var(--gold);
            border: 2px solid var(--gold);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 0 20px rgba(212,175,55,0.2);
            text-transform: uppercase;
            letter-spacing: 3px;
            -webkit-tap-highlight-color: transparent;
        }
        .start-btn:hover, .start-btn:focus-visible {
            background: var(--gold);
            color: #000;
            box-shadow: 0 0 50px rgba(212,175,55,0.5);
            transform: scale(1.04);
        }
        .start-btn:active { transform: scale(0.98); }

        /* =============================================
           GAME CONTAINER
        ============================================= */
        #game-container {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            width: 100%;
            max-width: 860px;
            border-radius: var(--radius-xl);
            border: 1px solid var(--gold-dim);
            box-shadow: var(--shadow-card);
            padding: clamp(20px, 4vw, 36px);
            position: relative;
            overflow-y: auto;
            max-height: 96vh;
            display: none;
            margin: auto;
        }

        /* =============================================
           HEADER
        ============================================= */
        .game-header {
            text-align: center;
            margin-bottom: 20px;
        }
        .game-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.3rem, 4vw, 1.9rem);
            font-weight: 900;
            color: var(--gold);
            text-transform: uppercase;
            letter-spacing: 2px;
            cursor: pointer;
            user-select: none;
            -webkit-user-select: none;
            display: inline-block;
            line-height: 1.2;
        }
        .game-title .white { color: #fff; }

        /* Stage progress dots */
        #stage-dots {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 7px;
            margin-top: 12px;
        }
        .s-dot {
            width: 8px; height: 8px;
            border-radius: 50%;
            background: var(--border);
            border: 1px solid rgba(255,255,255,0.1);
            transition: var(--transition);
            flex-shrink: 0;
        }
        .s-dot.done {
            background: var(--gold);
            border-color: var(--gold);
            box-shadow: 0 0 6px rgba(212,175,55,0.5);
        }
        .s-dot.active {
            background: var(--gold-light);
            border-color: var(--gold-light);
            box-shadow: 0 0 10px rgba(240,208,96,0.7);
            width: 22px;
            border-radius: 4px;
            animation: dotPulse 1.2s ease-in-out infinite;
        }
        @keyframes dotPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.55; }
        }

        /* =============================================
           STATUS BAR
        ============================================= */
        .status-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 22px;
        }

        .stat-card {
            flex: 1;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 12px 14px;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }
        .stat-card.danger {
            border-color: rgba(248,113,113,0.4);
            background: var(--danger-bg);
        }
        .stat-card.danger .stat-value { color: var(--danger); }
        .stat-card.danger .stat-bar-fill { background: var(--danger) !important; }

        .stat-label {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-dim);
            margin-bottom: 4px;
        }
        .stat-row {
            display: flex;
            align-items: baseline;
            gap: 4px;
            margin-bottom: 8px;
        }
        .stat-icon { font-size: 1rem; line-height: 1; }
        .stat-value {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            font-weight: 700;
            color: var(--text-main);
            transition: color 0.3s;
            line-height: 1;
        }
        .stat-unit {
            font-size: 0.72rem;
            color: var(--text-dim);
            font-weight: 500;
        }
        /* Progress bar */
        .stat-bar {
            height: 4px;
            background: rgba(255,255,255,0.07);
            border-radius: 2px;
            overflow: hidden;
        }
        .stat-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s cubic-bezier(0.4,0,0.2,1), background 0.3s;
        }
        #money-fill   { background: linear-gradient(90deg, #4ADE80, #22D3EE); }
        #time-fill    { background: linear-gradient(90deg, #FBBF24, #F97316); }
        #morale-fill  { background: linear-gradient(90deg, #F87171, #EC4899); }

        /* Danger pulse */
        .stat-card.danger .stat-value {
            animation: pulseValue 1s infinite;
        }
        @keyframes pulseValue {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* =============================================
           IMAGE
        ============================================= */
        #image-container {
            width: 100%;
            border-radius: var(--radius-md);
            overflow: hidden;
            margin-bottom: 18px;
            display: none;
            border: 1px solid var(--border);
            position: relative;
        }
        #image-container::after {
            content: '';
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 60px;
            background: linear-gradient(transparent, var(--bg-card));
            pointer-events: none;
        }
        #scene-image {
            width: 100%;
            max-height: 280px;
            object-fit: cover;
            display: block;
        }

        /* =============================================
           STORY TEXT
        ============================================= */
        #story-text {
            font-size: clamp(1rem, 2.2vw, 1.2rem);
            line-height: 1.85;
            margin-bottom: 22px;
            padding: clamp(16px, 3vw, 24px);
            background: var(--bg-surface);
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            color: var(--text-main);
            position: relative;
        }
        #story-text::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 3px; height: 100%;
            background: linear-gradient(180deg, var(--gold), transparent);
            border-radius: 3px 0 0 3px;
        }
        #story-text b {
            font-family: 'Playfair Display', serif;
            font-size: 1.05em;
            color: var(--gold);
            display: block;
            margin-bottom: 10px;
            letter-spacing: 0.5px;
        }

        /* =============================================
           CHOICE BUTTONS
        ============================================= */
        .btn-container { display: flex; flex-direction: column; gap: 10px; }

        .choice-btn {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 0;
            cursor: pointer;
            text-align: left;
            transition: var(--transition);
            display: flex;
            align-items: stretch;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .choice-btn:hover {
            background: var(--bg-hover);
            border-color: var(--gold-dim);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.35), 0 0 0 1px var(--gold-dim);
        }
        .choice-btn:active { transform: translateY(0px); box-shadow: none; }

        .choice-badge {
            width: 42px;
            min-width: 42px;
            background: var(--gold-glow);
            border-right: 1px solid var(--gold-dim);
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 900;
            color: var(--gold);
            transition: background 0.2s;
            flex-shrink: 0;
        }
        .choice-btn:hover .choice-badge {
            background: rgba(212,175,55,0.2);
        }

        .choice-body {
            flex: 1;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .choice-text {
            font-size: clamp(0.92rem, 2vw, 1.05rem);
            font-weight: 500;
            line-height: 1.5;
            color: var(--text-main);
        }
        .choice-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        .pill {
            font-size: 0.75rem;
            font-weight: 700;
            padding: 3px 10px;
            border-radius: 50px;
            white-space: nowrap;
        }
        .pill-money-neg { background: rgba(248,113,113,0.15); color: #FCA5A5; border: 1px solid rgba(248,113,113,0.25); }
        .pill-money-pos { background: rgba(74,222,128,0.15); color: #86EFAC; border: 1px solid rgba(74,222,128,0.25); }
        .pill-time      { background: rgba(251,191,36,0.15); color: #FDE68A; border: 1px solid rgba(251,191,36,0.25); }
        .pill-free      { background: rgba(255,255,255,0.06); color: var(--text-sub); border: 1px solid var(--border); }

        /* Replay button */
        .replay-btn-inline {
            width: 100%;
            padding: 16px;
            text-align: center;
            background: var(--gold-glow);
            border: 2px solid var(--gold-dim);
            border-radius: var(--radius-md);
            color: var(--gold);
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            letter-spacing: 1px;
        }
        .replay-btn-inline:hover {
            background: var(--gold);
            color: #000;
            box-shadow: 0 0 30px rgba(212,175,55,0.4);
        }

        /* =============================================
           OVERLAYS SHARED BASE
        ============================================= */
        .overlay-base {
            position: absolute;
            inset: 0;
            border-radius: var(--radius-xl);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            padding: clamp(20px, 4vw, 36px);
            text-align: center;
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            overflow-y: auto;
        }

        /* =============================================
           LOADING OVERLAY
        ============================================= */
        #loading-overlay {
            position: absolute; inset: 0;
            border-radius: var(--radius-xl);
            background: rgba(13, 27, 42, 0.96);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30;
            padding: 24px;
            text-align: center;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .spinner {
            width: 48px; height: 48px;
            border: 3px solid rgba(212,175,55,0.15);
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin-bottom: 18px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        #loading-text {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: clamp(1rem, 3vw, 1.4rem);
            margin-bottom: 8px;
            letter-spacing: 1px;
        }
        .loading-sub {
            color: var(--text-sub);
            font-style: italic;
            font-size: 0.9rem;
        }

        /* =============================================
           EVENT OVERLAY
        ============================================= */
        #event-overlay {
            position: absolute; inset: 0;
            border-radius: var(--radius-xl);
            background: rgba(13,27,42,0.97);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 20;
            padding: clamp(20px,4vw,36px);
            text-align: center;
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
            transition: background 0.3s;
            overflow-y: auto;
        }
        /* Tint classes */
        #event-overlay.tint-bad  { background: rgba(40,8,8,0.97); }
        #event-overlay.tint-good { background: rgba(5,28,18,0.97); }
        #event-overlay.tint-gamble { background: rgba(20,15,5,0.97); }

        .event-icon-big { font-size: clamp(2.5rem,8vw,4rem); margin-bottom: 10px; line-height: 1; }

        #event-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.3rem,4vw,1.9rem);
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }
        #event-desc {
            font-size: clamp(0.95rem,2.2vw,1.15rem);
            line-height: 1.75;
            color: #E2E8F0;
            margin-bottom: 8px;
            max-width: 480px;
        }
        .win-rate-badge {
            display: inline-block;
            background: rgba(251,191,36,0.15);
            border: 1px solid rgba(251,191,36,0.4);
            color: var(--warning);
            font-weight: 700;
            font-size: 0.9rem;
            padding: 6px 16px;
            border-radius: 50px;
            margin-bottom: 22px;
        }

        /* Gamble result panel */
        #gamble-result {
            display: none;
            padding: 18px 24px;
            border-radius: var(--radius-md);
            margin-bottom: 20px;
            width: 100%;
            max-width: 380px;
            animation: fadeIn 0.4s ease;
        }
        #gamble-result.win  { background: var(--success-bg); border: 1px solid rgba(74,222,128,0.3); color: var(--success); }
        #gamble-result.lose { background: var(--danger-bg);  border: 1px solid rgba(248,113,113,0.3); color: var(--danger); }
        #gamble-result .gr-icon { font-size: 2rem; display: block; margin-bottom: 6px; }
        #gamble-result .gr-text { font-size: 1.1rem; font-weight: 700; }

        .gamble-btns { display: flex; gap: 12px; width: 100%; justify-content: center; flex-wrap: wrap; max-width: 480px; }

        /* Event buttons re-use .choice-btn styling but centered */
        .event-btn {
            flex: 1;
            min-width: 140px;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 18px;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
            font-size: clamp(0.9rem,2vw,1rem);
            font-weight: 600;
            color: var(--text-main);
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            line-height: 1.5;
        }
        .event-btn:hover { background: var(--bg-hover); border-color: var(--gold-dim); transform: translateY(-2px); }
        .event-btn:active { transform: translateY(0); }
        .event-btn.gamble-fire { border-color: rgba(251,191,36,0.4); color: var(--warning); }
        .event-btn.gamble-safe { border-color: rgba(148,163,184,0.3); color: var(--text-sub); }
        .event-btn-full { width: 100%; max-width: 340px; }

        /* =============================================
           HALFTIME OVERLAY
        ============================================= */
        #halftime-overlay {
            position: absolute; inset: 0;
            border-radius: var(--radius-xl);
            background: rgba(13,27,42,0.98);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 25;
            padding: clamp(20px,4vw,36px);
            text-align: center;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            overflow-y: auto;
        }
        .halftime-label {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: var(--gold);
            background: var(--gold-glow);
            border: 1px solid var(--gold-dim);
            border-radius: 50px;
            padding: 5px 16px;
            margin-bottom: 14px;
            display: inline-block;
        }
        #halftime-overlay h2 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.6rem,5vw,2.2rem);
            color: var(--gold);
            margin-bottom: 6px;
            letter-spacing: 1px;
        }
        .halftime-subtitle {
            font-size: 0.95rem;
            color: var(--text-sub);
            font-style: italic;
            margin-bottom: 28px;
            max-width: 420px;
            line-height: 1.6;
        }
        .halftime-stats {
            display: flex; gap: 10px;
            justify-content: center; flex-wrap: wrap;
            margin-bottom: 24px; width: 100%;
        }
        .ht-stat-box {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 18px;
            min-width: 110px; flex: 1;
            max-width: 160px;
        }
        .ht-stat-box .hs-icon { font-size: 1.3rem; margin-bottom: 4px; }
        .ht-stat-box .hs-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 4px; }
        .ht-stat-box .hs-value { font-size: 1.2rem; font-weight: 700; color: var(--gold); }
        .halftime-quote {
            font-size: 0.95rem;
            color: var(--text-sub);
            font-style: italic;
            margin-bottom: 28px;
            max-width: 440px;
            line-height: 1.75;
            border-left: 3px solid var(--gold);
            padding-left: 16px;
            text-align: left;
        }
        #halftime-continue {
            width: 100%; max-width: 320px;
            padding: 15px;
            text-align: center;
            background: var(--gold-glow);
            border: 1.5px solid var(--gold-dim);
            border-radius: var(--radius-md);
            color: var(--gold);
            font-family: 'Inter', sans-serif;
            font-size: 1.05rem;
            font-weight: 700;
            cursor: pointer;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            letter-spacing: 1px;
        }
        #halftime-continue:hover { background: var(--gold); color: #000; }

        /* =============================================
           ADMIN OVERLAYS
        ============================================= */
        #admin-login-overlay, #admin-panel-overlay {
            position: absolute; inset: 0;
            border-radius: var(--radius-xl);
            background: rgba(8,16,28,0.98);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 24px;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
        .admin-box {
            background: rgba(20,32,50,0.95);
            padding: 24px;
            border-radius: var(--radius-lg);
            border: 1px solid var(--gold-dim);
            width: 100%; max-width: 380px;
            text-align: left;
        }
        .admin-box h3 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            text-align: center;
            margin-bottom: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.1rem;
        }
        .admin-group {
            margin-bottom: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .admin-group label { color: var(--text-sub); font-weight: 600; font-size: 0.9rem; }
        .admin-group input, .admin-group select {
            background: rgba(255,255,255,0.06);
            color: #fff;
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            width: 58%;
            text-align: right;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
        }
        .admin-group input:focus, .admin-group select:focus { outline: 1px solid var(--gold-dim); }
        .admin-btn-row { display: flex; gap: 10px; margin-top: 16px; }
        .admin-btn {
            flex: 1; padding: 10px 14px;
            text-align: center;
            background: #22c55e; color: #fff;
            border: none; border-radius: var(--radius-sm);
            font-family: 'Inter', sans-serif;
            font-weight: 700; font-size: 0.9rem;
            cursor: pointer; transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
        }
        .admin-btn:hover { opacity: 0.85; }
        .admin-btn.danger { background: var(--danger); color: #fff; }
        .admin-btn.action { background: #7c3aed; width: 100%; margin-top: 10px; display: block; }

        /* Admin password input */
        #admin-key-input {
            width: 100%; padding: 12px;
            margin-bottom: 16px;
            background: rgba(255,255,255,0.06);
            color: #fff; border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            text-align: center;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }
        #admin-key-input:focus { outline: 1px solid var(--gold-dim); }

        /* =============================================
           END SCREEN
        ============================================= */
        #end-screen {
            position: fixed; inset: 0;
            background: var(--bg-deep);
            background-image:
                radial-gradient(ellipse 80% 60% at 20% 10%, rgba(30,60,100,0.5) 0%, transparent 60%),
                radial-gradient(ellipse 60% 80% at 80% 90%, rgba(10,40,80,0.4) 0%, transparent 60%);
            z-index: 9999;
            display: none; flex-direction: column;
            justify-content: center; align-items: center;
            text-align: center; padding: 24px;
            overflow-y: auto;
        }
        .end-badge-wrap { font-size: clamp(3rem,10vw,5rem); margin-bottom: 10px; animation: badgePop 0.5s cubic-bezier(0.34,1.56,0.64,1) both; }
        @keyframes badgePop { from { transform: scale(0.3); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #end-screen h2 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.4rem,5vw,2.2rem);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 8px;
            animation: fadeIn 0.5s 0.2s ease both;
        }
        .end-subtitle {
            font-size: clamp(0.9rem,2.2vw,1.05rem);
            color: var(--text-sub);
            font-style: italic;
            margin-bottom: 24px;
            max-width: 500px;
            line-height: 1.7;
            animation: fadeIn 0.5s 0.35s ease both;
        }

        /* --- CSS M·ªöI CHO ·∫¢NH END SCREEN V√Ä HINT --- */
        #end-image-container {
            width: 100%; max-width: 560px;
            border-radius: var(--radius-md);
            overflow: hidden; margin-bottom: 24px;
            display: none; border: 1px solid var(--border);
            animation: fadeIn 0.5s 0.4s ease both;
        }
        #end-image-container img {
            width: 100%; max-height: 280px;
            object-fit: cover; display: block;
        }
        .secret-hint {
            font-size: clamp(0.85rem, 2vw, 1rem);
            color: var(--warning);
            margin-bottom: 24px;
            font-style: italic;
            text-shadow: 0 0 10px rgba(251,191,36,0.4);
            animation: fadeIn 0.5s 0.6s ease both;
            max-width: 560px;
            line-height: 1.5;
            display: none; /* ·∫®n m·∫∑c ƒë·ªãnh, ch·ªâ hi·ªán ·ªü true ending */
        }
        /* ------------------------------------------ */

        .end-stats-grid {
            display: flex; gap: 10px;
            justify-content: center; flex-wrap: wrap;
            margin-bottom: 32px; max-width: 560px; width: 100%;
            animation: fadeIn 0.5s 0.5s ease both;
        }
        .end-stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 18px;
            flex: 1; min-width: 100px;
        }
        .esk-label { font-size: 0.72rem; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .esk-value { font-size: 1.3rem; font-weight: 700; }

        #end-screen .replay-btn {
            font-family: 'Inter', sans-serif;
            padding: 17px 52px;
            font-size: clamp(1rem,3vw,1.2rem);
            font-weight: 700;
            background: transparent;
            color: var(--gold);
            border: 2px solid var(--gold);
            border-radius: 50px;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: 0 0 20px rgba(212,175,55,0.2);
            text-transform: uppercase;
            letter-spacing: 2px;
            -webkit-tap-highlight-color: transparent;
            animation: fadeIn 0.5s 0.65s ease both;
        }
        #end-screen .replay-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 50px rgba(212,175,55,0.5); }

        /* =============================================
           ANIMATIONS
        ============================================= */
        .fade-in { animation: fadeIn 0.45s ease forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to   { opacity: 1; transform: translateY(0); }
        }
        .shake { animation: shake 0.45s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-2px,0,0); }
            20%, 80% { transform: translate3d(4px,0,0); }
            30%, 50%, 70% { transform: translate3d(-5px,0,0); }
            40%, 60% { transform: translate3d(5px,0,0); }
        }

        /* =============================================
           MOBILE RESPONSIVE
        ============================================= */
        @media screen and (max-width: 480px) {
            body { padding: 10px; align-items: flex-start; }
            #game-container { border-radius: var(--radius-lg); max-height: none; overflow-y: visible; }

            /* 2-row status bar on tiny screens */
            .status-bar { flex-wrap: wrap; }
            .stat-card:nth-child(1) { min-width: calc(50% - 5px); }
            .stat-card:nth-child(2) { min-width: calc(50% - 5px); }
            .stat-card:nth-child(3) { min-width: 100%; }
            .stat-value { font-size: 1.1rem; }

            .gamble-btns { flex-direction: column; }
            .event-btn { min-width: unset; width: 100%; }
            #halftime-overlay, #event-overlay, #loading-overlay,
            #admin-login-overlay, #admin-panel-overlay { border-radius: var(--radius-lg); }

            .start-brief { gap: 8px; }
            .brief-chip { font-size: 0.82rem; padding: 8px 14px; }

            .ht-stat-box { max-width: none; }
        }

        @media screen and (min-width: 481px) and (max-width: 680px) {
            .ht-stat-box { min-width: 100px; }
        }

        /* =============================================
           DIFFICULTY SCREEN
        ============================================= */
        #difficulty-screen {
            position: fixed; inset: 0;
            background: var(--bg-deep);
            background-image:
                radial-gradient(ellipse 80% 60% at 20% 10%, rgba(30,60,100,0.6) 0%, transparent 60%),
                radial-gradient(ellipse 60% 80% at 80% 90%, rgba(10,40,80,0.5) 0%, transparent 60%);
            z-index: 9998;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 24px;
            animation: fadeIn 0.35s ease;
        }
        .diff-heading {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.1rem, 3vw, 1.4rem);
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 3px;
            margin-bottom: 8px;
        }
        .diff-title {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.6rem, 5vw, 2.2rem);
            font-weight: 900;
            color: var(--gold);
            margin-bottom: 32px;
            letter-spacing: 1px;
        }
        .diff-cards {
            display: flex;
            gap: 16px;
            justify-content: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 860px;
            margin-bottom: 28px;
        }
        .diff-card {
            flex: 1;
            min-width: 220px;
            max-width: 270px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 24px 20px;
            cursor: pointer;
            transition: var(--transition);
            text-align: left;
            -webkit-tap-highlight-color: transparent;
            position: relative;
            overflow: hidden;
        }
        .diff-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            transition: var(--transition);
        }
        .diff-card.normal::before  { background: var(--success); }
        .diff-card.expert::before  { background: var(--warning); }
        .diff-card.asian::before   { background: var(--danger); }

        .diff-card:hover {
            transform: translateY(-4px);
            background: rgba(255,255,255,0.06);
        }
        .diff-card.normal:hover  { border-color: rgba(74,222,128,0.4);  box-shadow: 0 12px 32px rgba(74,222,128,0.1); }
        .diff-card.expert:hover  { border-color: rgba(251,191,36,0.4);  box-shadow: 0 12px 32px rgba(251,191,36,0.1); }
        .diff-card.asian:hover   { border-color: rgba(248,113,113,0.4); box-shadow: 0 12px 32px rgba(248,113,113,0.15); }
        .diff-card:active { transform: translateY(0); }

        .diff-card-icon { font-size: 2rem; margin-bottom: 10px; display: block; }
        .diff-card-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .diff-card.normal  .diff-card-name { color: var(--success); }
        .diff-card.expert  .diff-card-name { color: var(--warning); }
        .diff-card.asian   .diff-card-name { color: var(--danger); }

        .diff-card-desc {
            font-size: 0.82rem;
            color: var(--text-sub);
            font-style: italic;
            margin-bottom: 18px;
            line-height: 1.5;
        }
        .diff-stats {
            display: flex;
            flex-direction: column;
            gap: 7px;
        }
        .diff-stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
        }
        .diff-stat-row .ds-label { color: var(--text-dim); }
        .diff-stat-row .ds-val   { color: var(--text-main); font-weight: 600; }

        .diff-back-btn {
            font-family: 'Inter', sans-serif;
            background: none;
            border: 1px solid var(--border);
            color: var(--text-sub);
            border-radius: 50px;
            padding: 10px 28px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
        }
        .diff-back-btn:hover { border-color: var(--gold-dim); color: var(--gold); }

        @media screen and (max-width: 480px) {
            .diff-cards { gap: 12px; }
            .diff-card { min-width: 100%; max-width: 100%; padding: 18px 16px; }
            .diff-title { margin-bottom: 20px; }
        }
        /* =============================================
           THEME: VOLUNTEER (Xanh bi·ªÉn & Tr·∫Øng)
        ============================================= */
        body.theme-volunteer {
            --gold:       #1565C0;
            --gold-light: #42A5F5;
            --gold-dim:   rgba(21,101,192,0.25);
            --gold-glow:  rgba(21,101,192,0.12);
            --bg-deep:    #EFF6FF;
            --bg-card:    rgba(255,255,255,0.95);
            --bg-surface: rgba(21,101,192,0.05);
            --bg-hover:   rgba(21,101,192,0.09);
            --text-main:  #1E3A5F;
            --text-sub:   #4A7FA5;
            --text-dim:   #7EB3D4;
            --border:     rgba(21,101,192,0.15);
            --shadow-card: 0 24px 60px rgba(21,101,192,0.12);
        }
        body.theme-volunteer {
            background: #EFF6FF;
            background-image:
                radial-gradient(ellipse 80% 60% at 20% 10%, rgba(144,202,249,0.45) 0%, transparent 60%),
                radial-gradient(ellipse 60% 80% at 80% 90%, rgba(21,101,192,0.12) 0%, transparent 60%);
        }
        body.theme-volunteer #start-screen,
        body.theme-volunteer #difficulty-screen,
        body.theme-volunteer #end-screen {
            background: #EFF6FF;
            background-image:
                radial-gradient(ellipse 80% 60% at 20% 10%, rgba(144,202,249,0.5) 0%, transparent 60%),
                radial-gradient(ellipse 60% 80% at 80% 90%, rgba(21,101,192,0.15) 0%, transparent 60%);
        }
        body.theme-volunteer #money-fill  { background: linear-gradient(90deg, #1565C0, #0288D1); }
        body.theme-volunteer #time-fill   { background: linear-gradient(90deg, #0288D1, #0097A7); }
        body.theme-volunteer #morale-fill { background: linear-gradient(90deg, #E53935, #AD1457); }
        body.theme-volunteer .choice-badge { background: rgba(21,101,192,0.08); border-right-color: rgba(21,101,192,0.2); }
        body.theme-volunteer #story-text::before { background: linear-gradient(180deg, #1565C0, transparent); }
        body.theme-volunteer .spinner { border-color: rgba(21,101,192,0.15); border-top-color: #1565C0; }
        body.theme-volunteer .pill-money-neg { background: rgba(229,57,53,0.1);  color: #C62828; border-color: rgba(229,57,53,0.25); }
        body.theme-volunteer .pill-money-pos { background: rgba(46,125,50,0.1);  color: #2E7D32; border-color: rgba(46,125,50,0.25); }
        body.theme-volunteer .pill-time      { background: rgba(2,136,209,0.12); color: #01579B; border-color: rgba(2,136,209,0.3); }
        body.theme-volunteer .pill-free      { background: rgba(21,101,192,0.06); color: #4A7FA5; border-color: rgba(21,101,192,0.15); }
        body.theme-volunteer .s-dot          { background: rgba(21,101,192,0.15); border-color: rgba(21,101,192,0.2); }
        body.theme-volunteer .s-dot.done     { background: #1565C0; border-color: #1565C0; box-shadow: 0 0 6px rgba(21,101,192,0.4); }
        body.theme-volunteer .s-dot.active   { background: #42A5F5; border-color: #42A5F5; box-shadow: 0 0 10px rgba(66,165,245,0.6); }
        body.theme-volunteer .admin-box      { background: rgba(255,255,255,0.97); }
        body.theme-volunteer .admin-group input,
        body.theme-volunteer .admin-group select { background: rgba(21,101,192,0.06); color: #1E3A5F; border-color: rgba(21,101,192,0.2); }

        /* N√∫t chuy·ªÉn theme */
        #theme-toggle {
            position: absolute;
            top: 0; right: 0;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 6px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-sub);
            cursor: pointer;
            transition: var(--transition);
            -webkit-tap-highlight-color: transparent;
            display: flex; align-items: center; gap: 5px;
            white-space: nowrap;
        }
        #theme-toggle:hover { border-color: var(--gold-dim); color: var(--gold); background: var(--bg-hover); }

        /* =============================================
           PRESENTATION MODE ‚Äî hover zoom (thu·∫ßn CSS)
           Ch·ªâ √°p d·ª•ng thi·∫øt b·ªã c√≥ chu·ªôt th·∫≠t.
           Kh√¥ng JS, kh√¥ng ·∫£nh h∆∞·ªüng onclick/logic AI.
        ============================================= */
        @media (hover: hover) and (pointer: fine) {
            /* story-text: scale 5%, n·ªïi l√™n z-index 10 */
            #story-text {
                transition: transform 0.28s cubic-bezier(0.4,0,0.2,1),
                            box-shadow 0.28s cubic-bezier(0.4,0,0.2,1);
                will-change: transform;
            }
            #story-text:hover {
                transform: scale(1.05);
                transform-origin: top center;
                z-index: 10;
                box-shadow: 0 20px 56px rgba(0,0,0,0.5);
            }
            /* choice-btn: k·∫øt h·ª£p translateY(-2px) s·∫µn c√≥ + scale(1.03) */
            .choice-btn:hover {
                transform: translateY(-2px) scale(1.03);
                z-index: 5;
            }
        }
    </style>
</head>
<body>

<div id="start-screen">
    <div class="start-logo"><span class="white">D·ª∞ √ÅN</span> M√ôA H√à XANH</div>
    <p class="start-tagline">"Qu·∫£n l√Ω d·ª± √°n kh√¥ng ch·ªâ l√† nh·ªØng con s·ªë,<br>m√† l√† ngh·ªá thu·∫≠t c√¢n b·∫±ng gi·ªØa Tr√°i Tim v√† L√Ω Tr√≠."</p>
    <div class="start-brief">
        <div class="brief-chip"><span class="chip-icon">üí∞</span> Ng√¢n s√°ch: 6.000.000ƒë</div>
        <div class="brief-chip"><span class="chip-icon">‚è±Ô∏è</span> Th·ªùi h·∫°n: 25 ng√†y</div>
        <div class="brief-chip"><span class="chip-icon">üéØ</span> 10 Giai ƒëo·∫°n</div>
    </div>
    <button class="start-btn" id="start-btn">B·∫Øt ƒê·∫ßu Tr·∫£i Nghi·ªám</button>
</div>

<div id="difficulty-screen">
    <p class="diff-heading">Ch·ªçn ƒê·ªô Kh√≥</p>
    <div class="diff-title">B·∫°n L√† Ai Trong H√†nh Tr√¨nh N√†y?</div>
    <div class="diff-cards">

        <div class="diff-card normal" id="diff-normal">
            <span class="diff-card-icon">üå±</span>
            <div class="diff-card-name">B√¨nh Th∆∞·ªùng</div>
            <p class="diff-card-desc">H·ªçc c√°ch qu·∫£n l√Ω. Cho ph√©p sai l·∫ßm v√† th·ª≠ nghi·ªám.</p>
            <div class="diff-stats">
                <div class="diff-stat-row"><span class="ds-label">üí∞ Ng√¢n s√°ch</span><span class="ds-val">6.000.000ƒë</span></div>
                <div class="diff-stat-row"><span class="ds-label">‚è±Ô∏è Th·ªùi h·∫°n</span><span class="ds-val">25 ng√†y</span></div>
                <div class="diff-stat-row"><span class="ds-label">‚ù§Ô∏è Tinh th·∫ßn</span><span class="ds-val">100%</span></div>
                <div class="diff-stat-row"><span class="ds-label">üéØ Ho√†n h·∫£o</span><span class="ds-val">‚â• 110 ƒëi·ªÉm</span></div>
            </div>
        </div>

        <div class="diff-card expert" id="diff-expert">
            <span class="diff-card-icon">‚öîÔ∏è</span>
            <div class="diff-card-name">Chuy√™n Gia</div>
            <p class="diff-card-desc">M·ªói quy·∫øt ƒë·ªãnh ph·∫£i c√≥ l√Ω do. Kh√¥ng th·ªÉ an to√†n m√£i.</p>
            <div class="diff-stats">
                <div class="diff-stat-row"><span class="ds-label">üí∞ Ng√¢n s√°ch</span><span class="ds-val">4.500.000ƒë</span></div>
                <div class="diff-stat-row"><span class="ds-label">‚è±Ô∏è Th·ªùi h·∫°n</span><span class="ds-val">22 ng√†y</span></div>
                <div class="diff-stat-row"><span class="ds-label">‚ù§Ô∏è Tinh th·∫ßn</span><span class="ds-val">80%</span></div>
                <div class="diff-stat-row"><span class="ds-label">üéØ Ho√†n h·∫£o</span><span class="ds-val">‚â• 120 ƒëi·ªÉm</span></div>
            </div>
        </div>

        <div class="diff-card asian" id="diff-asian">
            <span class="diff-card-icon">üî•</span>
            <div class="diff-card-name">Asian Mode</div>
            <p class="diff-card-desc">B·∫°n kh√¥ng th·ª≠, b·∫°n non.</p>
            <div class="diff-stats">
                <div class="diff-stat-row"><span class="ds-label">üí∞ Ng√¢n s√°ch</span><span class="ds-val">3.000.000ƒë</span></div>
                <div class="diff-stat-row"><span class="ds-label">‚è±Ô∏è Th·ªùi h·∫°n</span><span class="ds-val">19 ng√†y</span></div>
                <div class="diff-stat-row"><span class="ds-label">‚ù§Ô∏è Tinh th·∫ßn</span><span class="ds-val">65%</span></div>
                <div class="diff-stat-row"><span class="ds-label">üéØ Ho√†n h·∫£o</span><span class="ds-val">‚â• 140 ƒëi·ªÉm</span></div>
            </div>
        </div>

    </div>
    <button class="diff-back-btn" id="diff-back-btn">‚Üê Quay l·∫°i</button>
</div>

<div id="game-container">

    <div class="game-header" style="position:relative;">
        <div class="game-title" id="admin-trigger">
            <span class="white">D·ª∞ √ÅN:</span> M√ôA H√à XANH
        </div>
        <button id="theme-toggle">üé® T√¨nh Nguy·ªán</button>
        <div id="stage-dots">
            <div class="s-dot" id="dot-1"></div>
            <div class="s-dot" id="dot-2"></div>
            <div class="s-dot" id="dot-3"></div>
            <div class="s-dot" id="dot-4"></div>
            <div class="s-dot" id="dot-5"></div>
            <div class="s-dot" id="dot-6"></div>
            <div class="s-dot" id="dot-7"></div>
            <div class="s-dot" id="dot-8"></div>
            <div class="s-dot" id="dot-9"></div>
            <div class="s-dot" id="dot-10"></div>
        </div>
    </div>

    <div class="status-bar">
        <div class="stat-card" id="money-container">
            <div class="stat-label">T√†i Ch√≠nh</div>
            <div class="stat-row">
                <span class="stat-icon">üí∞</span>
                <span class="stat-value" id="money">6.000.000</span>
                <span class="stat-unit">ƒë</span>
            </div>
            <div class="stat-bar"><div class="stat-bar-fill" id="money-fill" style="width:100%"></div></div>
        </div>
        <div class="stat-card" id="time-container">
            <div class="stat-label">Th·ªùi Gian</div>
            <div class="stat-row">
                <span class="stat-icon">‚è±Ô∏è</span>
                <span class="stat-value" id="time">25</span>
                <span class="stat-unit">ng√†y</span>
            </div>
            <div class="stat-bar"><div class="stat-bar-fill" id="time-fill" style="width:100%"></div></div>
        </div>
        <div class="stat-card" id="morale-container">
            <div class="stat-label">Tinh Th·∫ßn</div>
            <div class="stat-row">
                <span class="stat-icon">‚ù§Ô∏è</span>
                <span class="stat-value" id="morale">100</span>
                <span class="stat-unit">%</span>
            </div>
            <div class="stat-bar"><div class="stat-bar-fill" id="morale-fill" style="width:100%"></div></div>
        </div>
    </div>

    <div id="image-container"><img id="scene-image" src="" alt="Scene"></div>
    <div id="story-text"></div>
    <div class="btn-container" id="choices"></div>

    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">H·ªÜ TH·ªêNG ƒêANG PH√ÇN T√çCH...</div>
        <p class="loading-sub">"S√≥ng gi√≥ c√≥ th·ªÉ ·∫≠p ƒë·∫øn ·ªü b·∫•t c·ª© giai ƒëo·∫°n n√†o."</p>
    </div>

    <div id="event-overlay">
        <div class="event-icon-big" id="event-icon">üö®</div>
        <h2 id="event-title">BI·∫æN C·ªê!</h2>
        <p id="event-desc"></p>
        <div class="win-rate-badge" id="win-rate-label" style="display:none"></div>
        <div id="gamble-result">
            <span class="gr-icon" id="gr-icon"></span>
            <span class="gr-text" id="gr-text"></span>
        </div>
        <div class="gamble-btns" id="event-buttons"></div>
    </div>

    <div id="admin-login-overlay">
        <div class="admin-box">
            <h3>üîê Quy·ªÅn Truy C·∫≠p Gi√°m ƒê·ªëc</h3>
            <input type="password" id="admin-key-input" placeholder="Nh·∫≠p m√£ b√≠ m·∫≠t...">
            <div class="admin-btn-row">
                <button class="admin-btn danger" id="admin-cancel-btn">H·ªßy</button>
                <button class="admin-btn" id="admin-confirm-btn">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>

    <div id="admin-panel-overlay">
        <div class="admin-box">
            <h3>‚öôÔ∏è God Mode Panel</h3>
            <div class="admin-group">
                <label>üí∞ T√†i ch√≠nh:</label>
                <input type="number" id="admin-money">
            </div>
            <div class="admin-group">
                <label>‚è±Ô∏è Th·ªùi gian:</label>
                <input type="number" id="admin-time">
            </div>
            <div class="admin-group">
                <label>‚ù§Ô∏è Tinh th·∫ßn:</label>
                <input type="number" id="admin-morale">
            </div>
            <div class="admin-group">
                <label>‚≠ê Ch·∫•t l∆∞·ª£ng:</label>
                <input type="number" id="admin-quality">
            </div>
            <div class="admin-group">
                <label>ü§ñ B·∫≠t/T·∫Øt AI:</label>
                <input type="checkbox" id="admin-ai-toggle" style="width:20px;height:20px;">
            </div>
            <div class="admin-group">
                <label>üé≤ S·ª± C∆∞·ª£c AI:</label>
                <div style="display:flex;align-items:center;gap:4px;width:58%;">
                    <input type="number" id="admin-rate-ai" min="0" max="100" step="5" style="width:100%;text-align:right;">
                    <span style="color:var(--text-dim);font-size:0.8rem;flex-shrink:0;">%</span>
                </div>
            </div>
            <div class="admin-group">
                <label>‚ö° S·ª± C·ªë/May:</label>
                <div style="display:flex;align-items:center;gap:4px;width:58%;">
                    <input type="number" id="admin-rate-static" min="0" max="100" step="5" style="width:100%;text-align:right;">
                    <span style="color:var(--text-dim);font-size:0.8rem;flex-shrink:0;">%</span>
                </div>
            </div>
            <p style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;font-style:italic;">üé∞ T·ªâ l·ªá th·∫Øng c∆∞·ª£c: t·ª± ƒë·ªông 40‚Äì60% ng·∫´u nhi√™n m·ªói l·∫ßn</p>
            <button class="admin-btn action" id="admin-force-event-btn">‚ö° √âp S·ª± Ki·ªán (100%)</button>
            <div class="admin-group" style="margin-top:14px;flex-direction:column;align-items:flex-start;">
                <label style="margin-bottom:8px;">üöÄ Nh·∫£y C√≥c:</label>
                <div style="display:flex;width:100%;gap:10px;">
                    <select id="admin-stage-select" style="flex:1;text-align:left;">
                        <option value="stage_2">Gƒê 2</option>
                        <option value="stage_4">Gƒê 4</option>
                        <option value="stage_7">Gƒê 7</option>
                        <option value="stage_10">Gƒê 10</option>
                        <option value="calc_ending">T·ªïng k·∫øt</option>
                    </select>
                    <button class="admin-btn danger" style="padding:8px 16px;width:auto;" id="admin-jump-btn">GO</button>
                </div>
            </div>
            <div class="admin-btn-row" style="margin-top:16px;">
                <button class="admin-btn danger" id="admin-close-btn">ƒê√≥ng</button>
                <button class="admin-btn" id="admin-save-btn">L∆∞u</button>
            </div>
        </div>
    </div>

    <div id="halftime-overlay">
        <div class="halftime-label">‚ú¶ CHECKPOINT ‚ú¶</div>
        <h2>N·ª≠a Ch·∫∑ng ƒê∆∞·ªùng</h2>
        <p class="halftime-subtitle">"Kh√≥ khƒÉn th·∫≠t s·ª± b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢y. Ki·ªÉm tra l·∫°i l·ª±c l∆∞·ª£ng tr∆∞·ªõc khi ti·∫øp t·ª•c."</p>
        <div class="halftime-stats">
            <div class="ht-stat-box"><div class="hs-icon">üí∞</div><div class="hs-label">T√†i ch√≠nh c√≤n</div><div class="hs-value" id="ht-money"></div></div>
            <div class="ht-stat-box"><div class="hs-icon">‚è±Ô∏è</div><div class="hs-label">Th·ªùi gian c√≤n</div><div class="hs-value" id="ht-time"></div></div>
            <div class="ht-stat-box"><div class="hs-icon">‚ù§Ô∏è</div><div class="hs-label">Tinh th·∫ßn</div><div class="hs-value" id="ht-morale"></div></div>
            <div class="ht-stat-box"><div class="hs-icon">‚≠ê</div><div class="hs-label">Ch·∫•t l∆∞·ª£ng</div><div class="hs-value" id="ht-quality"></div></div>
        </div>
        <p class="halftime-quote" id="ht-quote"></p>
        <button id="halftime-continue">‚öîÔ∏è Ti·∫øp T·ª•c H√†nh Tr√¨nh</button>
    </div>

</div><div id="end-screen">
    <div class="end-badge-wrap" id="end-badge"></div>
    <h2 id="end-title"></h2>
    <p class="end-subtitle" id="end-subtitle"></p>
    
    <div id="end-image-container">
        <img id="end-image" src="" alt="Ending Scene">
    </div>

    <div class="end-stats-grid">
        <div class="end-stat-card"><div class="esk-label">üí∞ T√†i ch√≠nh c√≤n</div><div class="esk-value" id="end-money"></div></div>
        <div class="end-stat-card"><div class="esk-label">‚è±Ô∏è Ng√†y d∆∞</div><div class="esk-value" id="end-time"></div></div>
        <div class="end-stat-card"><div class="esk-label">‚ù§Ô∏è Tinh th·∫ßn</div><div class="esk-value" id="end-morale"></div></div>
        <div class="end-stat-card"><div class="esk-label">‚≠ê Ch·∫•t l∆∞·ª£ng</div><div class="esk-value" id="end-quality"></div></div>
        <div class="end-stat-card"><div class="esk-label">üé≤ Bi·∫øn c·ªë g·∫∑p</div><div class="esk-value" id="end-events"></div></div>
    </div>
    
    <p class="secret-hint" id="secret-hint">"ƒê√¢y l√† true ending, li·ªáu b·∫°n c√≥ th·ªÉ th√†nh c√¥ng l·∫•y ƒë∆∞·ª£c Secret Ending - m·ªôt ·∫£nh ending kh√¥ng n√™n t·ªìn t·∫°i"</p>

    <button class="replay-btn" id="replay-btn">üîÑ Ch∆°i L·∫°i</button>
</div>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // 1. KHO API KEY
    const apiBunker = [
        "AIzaSy" + "BvqhsQ7v6" + "7xwAwiNxS3klNwmcKhP6DT8o",
        "AIzaSy" + "CkCH6xCK_WsnuXyy" + "64EIIIDKJJdNF0z5g",
        "AIzaSy" + "C4Nz1G1zFNA2z8MG" + "pDLedbwGAZn_Zuy2U",
        "AIzaSy" + "CME3gv9x_JjpcUDe" + "rxw-_YfOVqu6Fxblo",
        "AIzaSy" + "BYi9Rpdpld2pfbKx" + "CvFhKWMYvf1m91rKY",
        "AIzaSy" + "BVPHAJysryTusPA3" + "fx4y6-H8B_jwp2ab4",
        "AIzaSy" + "BENpIYLfoUQaNEl2" + "Tl_T9kQq5Z9ubVLT8",
        "AIzaSy" + "BY1wIY1S_oHE_XpD" + "tQsh4cv32ux3OSxk0",
        "AIzaSy" + "DoWZJaVeaQsyZbkj" + "aAS9X5UUPU1YwJf1g",
        "AIzaSy" + "A87JwrpGdumJkHJp" + "u13G0AN6BRGq6RIKk",
        "AIzaSy" + "AT0pz0eO2JKEQdS3" + "R9P4qoyl__cG71zXk",
        "AIzaSy" + "A02QkWlyP0ym-W-G" + "y8GRkMXenRUwR5rJw",
        "AIzaSy" + "AGITriYKn2mEgDYl" + "bMigSu-lFkPzTJBwU",
        "AIzaSy" + "B7VDjPrtIWV6RBzS" + "HWrqWmh9PgoU3Y0Fg",
        "AIzaSy" + "CMUz-AZXXPHNJ51h" + "9JDVF065HT_D2PNzg",
        "AIzaSy" + "DsmRPTWH89WW_vGb" + "VOnrGJx4398JvkQX8",
        "AIzaSy" + "D2pHt3kYaZ9oXlOV" + "1ysoJH2OMcvlBWH6E",
        "AIzaSy" + "CqmUB2qwYL-yRt3b" + "6SwioqI6lRIYItYbk",
        "AIzaSy" + "DeD59rq1PyHccy_w" + "g6UkgeUvkcQiaGcKA",
        "AIzaSy" + "AKZLcQkV_iG5qo4n" + "7w0G6RbGmbfRmn0yM",
        "AIzaSy" + "DtuqR0XvVUM15W7x" + "MpY381b6X7uRMojnU",
        "AIzaSy" + "Chv-SNFYgtvAA-dq" + "0Lw5ncRSBH52jXIgU",
        "AIzaSy" + "DffoYIf1V2uTbBra" + "XWlCLbRe8GYI7joVk",
        "AIzaSy" + "BG-VpzIEZ" + "dY_9L-aTAi2S6jLLRhoRfzbk",
        "AIzaSy" + "ClbEJ9z45" + "jBw4RwA0k8Z-uDtSWpNBByxc",
        "AIzaSy" + "CufjIA8oY" + "vSR5ugxt9iHMSl_nwIZIYqzs",
        "AIzaSy" + "CeUtH22q4" + "N-ntma7m-kAW1Ctie5ViOzgw"
    ];
    let currentKeyIndex = 0;

    let USE_AI = true;
    let forceNextEvent = false;
    let RATE_AI_EVENT     = 0.15;
    let RATE_STATIC_EVENT = 0.20;
    let GUARANTEE_AT      = 6; // guarantee static event m·ªói N giai ƒëo·∫°n

    // ===== C·∫§U H√åNH ƒê·ªò KH√ì =====
    const DIFFICULTIES = {
        normal: {
            money: 6000000, time: 25, morale: 100,
            moraleFloor: 20,
            qualityBad: 60, qualityGood: 110,
            rateAI: 0.15, rateStatic: 0.20, guaranteeAt: 6,
            penaltyMult: 1.0,
            winMin: 40, winMax: 60
        },
        expert: {
            money: 4500000, time: 22, morale: 80,
            moraleFloor: 25,
            qualityBad: 70, qualityGood: 120,
            rateAI: 0.22, rateStatic: 0.30, guaranteeAt: 4,
            penaltyMult: 1.3,
            winMin: 37, winMax: 55
        },
        asian: {
            money: 3000000, time: 19, morale: 65,
            moraleFloor: 30,
            qualityBad: 80, qualityGood: 140,
            rateAI: 0.22, rateStatic: 0.35, guaranteeAt: 3,
            penaltyMult: 1.6,
            winMin: 30, winMax: 50
        }
    };
    let currentDiff = DIFFICULTIES.normal; // m·∫∑c ƒë·ªãnh, s·∫Ω ghi ƒë√® khi player ch·ªçn

    // BI·∫æN M·ªöI CHO 3 T√çNH NƒÇNG
    let stagesSinceStaticEvent = 0;
    let pendingStaticEvent = null;
    let halftimeSeen = false;
    let eventsEncountered = 0;

    // Stage order map ƒë·ªÉ t√≠nh progress dot
    const stageOrder = ['start','stage_2','stage_3','stage_4','stage_5','stage_6','stage_7','stage_8','stage_9','stage_10'];

    // 2. ADMIN & START LOGIC
    // D√πng addEventListener trong module - KH√îNG d√πng window.xxx hay onclick inline
    // ƒë·ªÉ tr√°nh l·ªói "is not defined" khi module ch∆∞a load xong
    let adminClickCount = 0;
    let adminClickTimer = null;

    document.getElementById('start-btn').addEventListener('click', () => {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('difficulty-screen').style.display = 'flex';
    });

    document.getElementById('diff-back-btn').addEventListener('click', () => {
        document.getElementById('difficulty-screen').style.display = 'none';
        document.getElementById('start-screen').style.display = 'flex';
    });

    function pickDifficulty(diffKey) {
        currentDiff = DIFFICULTIES[diffKey];
        document.getElementById('difficulty-screen').style.display = 'none';
        document.getElementById('game-container').style.display = 'block';
        initGame();
    }

    document.getElementById('diff-normal').addEventListener('click', () => pickDifficulty('normal'));
    document.getElementById('diff-expert').addEventListener('click', () => pickDifficulty('expert'));
    document.getElementById('diff-asian').addEventListener('click',  () => pickDifficulty('asian'));

    document.getElementById('replay-btn').addEventListener('click', () => location.reload());

    // Theme toggle: Dark (m·∫∑c ƒë·ªãnh) ‚Üî Volunteer (xanh bi·ªÉn/tr·∫Øng)
    let isVolunteerTheme = false;
    document.getElementById('theme-toggle').addEventListener('click', () => {
        isVolunteerTheme = !isVolunteerTheme;
        document.body.classList.toggle('theme-volunteer', isVolunteerTheme);
        document.getElementById('theme-toggle').textContent = isVolunteerTheme ? 'üåô T·ªëi' : 'üé® T√¨nh Nguy·ªán';
    });

    document.getElementById('admin-trigger').addEventListener('click', () => {
        adminClickCount++;
        clearTimeout(adminClickTimer);
        adminClickTimer = setTimeout(() => { adminClickCount = 0; }, 1000);
        if (adminClickCount >= 3) {
            document.getElementById('admin-login-overlay').style.display = 'flex';
            adminClickCount = 0;
        }
    });

    document.getElementById('admin-cancel-btn').addEventListener('click', () => {
        document.getElementById('admin-login-overlay').style.display = 'none';
    });

    document.getElementById('admin-confirm-btn').addEventListener('click', () => {
        const key = document.getElementById('admin-key-input').value;
        document.getElementById('admin-key-input').value = "";
        if (key === "181008") {
            document.getElementById('admin-login-overlay').style.display = 'none';
            document.getElementById('admin-money').value   = state.money;
            document.getElementById('admin-time').value    = state.time;
            document.getElementById('admin-morale').value  = state.morale;
            document.getElementById('admin-quality').value = state.quality;
            document.getElementById('admin-ai-toggle').checked = USE_AI;
            document.getElementById('admin-rate-ai').value     = Math.round(RATE_AI_EVENT * 100);
            document.getElementById('admin-rate-static').value = Math.round(RATE_STATIC_EVENT * 100);
            document.getElementById('admin-panel-overlay').style.display = 'flex';
        } else {
            alert("Sai m√£!");
            document.getElementById('admin-login-overlay').style.display = 'none';
        }
    });

    document.getElementById('admin-close-btn').addEventListener('click', () => {
        document.getElementById('admin-panel-overlay').style.display = 'none';
    });

    document.getElementById('admin-save-btn').addEventListener('click', () => {
        state.money   = parseInt(document.getElementById('admin-money').value)   || 0;
        state.time    = parseInt(document.getElementById('admin-time').value)    || 0;
        state.morale  = parseInt(document.getElementById('admin-morale').value)  || 0;
        state.quality = parseInt(document.getElementById('admin-quality').value) || 0;
        USE_AI = document.getElementById('admin-ai-toggle').checked;
        const rAI     = parseInt(document.getElementById('admin-rate-ai').value);
        const rStatic = parseInt(document.getElementById('admin-rate-static').value);
        if (!isNaN(rAI))     RATE_AI_EVENT     = Math.min(100, Math.max(0, rAI))     / 100;
        if (!isNaN(rStatic)) RATE_STATIC_EVENT = Math.min(100, Math.max(0, rStatic)) / 100;
        updateUI();
        document.getElementById('admin-panel-overlay').style.display = 'none';
    });

    document.getElementById('admin-force-event-btn').addEventListener('click', () => {
        forceNextEvent = true;
        alert("ƒê√£ k√≠ch ho·∫°t s·ª± ki·ªán cho v√≤ng k·∫ø!");
    });

    document.getElementById('admin-jump-btn').addEventListener('click', () => {
        const targetStage = document.getElementById('admin-stage-select').value;
        document.getElementById('admin-panel-overlay').style.display = 'none';
        renderScene(targetStage); // Fix: prepareAndRenderNextStage kh√¥ng t·ªìn t·∫°i ‚Üí renderScene
    });

    // 3. STATE & DATA
    let state = { money: 6000000, time: 25, morale: 100, quality: 0 };
    let dynamicStory = {};
    let usedThemes = [];

    const story = {
        start: {
            theme: "L·∫≠p k·∫ø ho·∫°ch v√† chu·∫©n b·ªã c∆° s·ªü v·∫≠t ch·∫•t (k·ªá s√°ch, s∆°n t∆∞·ªùng, d·ªçn d·∫πp ph√≤ng tr·ªëng).",
            text: "<b>GIAI ƒêO·∫†N 1: K·∫æ HO·∫†CH C∆† S·ªû V·∫¨T CH·∫§T</b><br>D·ª± √°n Th∆∞ vi·ªán ∆Ø·ªõc m∆° kh·ªüi ƒë·ªông! CƒÉn ph√≤ng ƒëang tr·ªëng r·ªóng. Quy·∫øt ƒë·ªãnh c·ªßa Tr∆∞·ªüng d·ª± √°n v·ªÅ h·∫°ng m·ª•c K·ªá s√°ch?",
            image: "https://image2url.com/r2/default/images/1772112309351-aa0d854c-c899-409f-81c4-1ee44033ac9c.jpg",
            choices: [
                { text: "A. Mua k·ªá nh√¥m k√≠nh l·∫Øp r√°p (Nhanh nh∆∞ng t·ªën).", impact: "üí∞ -3.000k | ‚è±Ô∏è -2 ng√†y", next: "stage_2", effect: { money: -3000000, time: -2, quality: 25 } },
                { text: "B. T·ª± mua g·ªó pallet v·ªÅ c∆∞a x·∫ª ƒë√≥ng tay (C·ª±c k·ª≥ t·ªën s·ª©c).", impact: "üí∞ -500k | ‚è±Ô∏è -5 ng√†y", next: "stage_2", effect: { money: -500000, time: -5, morale: -15, quality: 10 } },
                { text: "C. Xin l·∫°i k·ªá c≈© c·ªßa c√°c l·ªõp 12 ra tr∆∞·ªùng.", impact: "üí∞ -200k | ‚è±Ô∏è -4 ng√†y", next: "stage_2", effect: { money: -200000, time: -4, morale: -5, quality: 15 } }
            ]
        },
        stage_2: {
            theme: "T√¨m ki·∫øm ngu·ªìn s√°ch, ph√¢n lo·∫°i t√†i li·ªáu cho th∆∞ vi·ªán.",
            text: "<b>GIAI ƒêO·∫†N 2: T√åM KI·∫æM NGU·ªíN S√ÅCH</b><br>ƒê√£ c√≥ k·ªá. Gi·ªù c·∫ßn s√°ch ƒë·ªÉ l·∫•p ƒë·∫ßy. B·∫°n s·∫Ω x√¢y d·ª±ng kho tri th·ª©c n√†y nh∆∞ th·∫ø n√†o?",
            image: "https://image2url.com/r2/default/images/1772112368557-2f824ca9-d62c-4b7b-b6d5-cf75107ed5db.jpg",
            choices: [
                { text: "A. Tr√≠ch qu·ªπ ra ti·ªám s√°ch c≈© mua s·ªâ theo l√¥.", impact: "üí∞ -1.500k | ‚è±Ô∏è -1 ng√†y", next: "stage_3", effect: { money: -1500000, time: -1, quality: 15 } },
                { text: "B. Ph√°t ƒë·ªông quy√™n g√≥p t·ª´ng l·ªõp h·ªçc.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -4 ng√†y", next: "stage_3", effect: { time: -4, morale: -10, quality: 10 } },
                { text: "C. K√™u g·ªçi t√†i tr·ª£ t·ª´ c√°c nh√† xu·∫•t b·∫£n tr√™n Facebook.", impact: "üí∞ -100k | ‚è±Ô∏è -3 ng√†y", next: "stage_3", effect: { money: -100000, time: -3, morale: -5, quality: 20 } }
            ]
        },
        stage_3: {
            theme: "Logistics, v·∫≠n chuy·ªÉn ƒë·ªì ƒë·∫°c v·∫≠t li·ªáu n·∫∑ng n·ªÅ v·ªÅ ƒëi·ªÉm t·∫≠p k·∫øt.",
            text: "<b>GIAI ƒêO·∫†N 3: V·∫¨N CHUY·ªÇN</b><br>V·∫≠t li·ªáu ƒëang ·ªü kh·∫Øp n∆°i. B·∫°n c·∫ßn gom t·∫•t c·∫£ v·ªÅ ƒëi·ªÉm tr∆∞·ªùng d∆∞·ªõi tr·ªùi n·∫Øng g·∫Øt.",
            image: "https://image2url.com/r2/default/images/1772112478729-87df9703-9ad9-4841-b28d-d5aa14deb860.jpg",
            choices: [
                { text: "A. Thu√™ lu√¥n xe ba g√°c m√°y ch·ªü 1 chuy·∫øn l√† xong.", impact: "üí∞ -600k | ‚è±Ô∏è -1 ng√†y", next: "stage_4", effect: { money: -600000, time: -1 } },
                { text: "B. Chia c·∫£ nh√≥m th√†nh xe m√°y, ch·ªü th√†nh 5-6 chuy·∫øn.", impact: "üí∞ -100k | ‚è±Ô∏è -2 ng√†y", next: "stage_4", effect: { money: -100000, time: -2, morale: -15 } },
                { text: "C. M∆∞·ª£n xe ƒë·∫°p l√¥i c·ªßa b√°c b·∫£o v·ªá, t·ª± ƒë·∫°p t·ª± ch·ªü.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -3 ng√†y", next: "stage_4", effect: { time: -3, morale: -20 } }
            ]
        },
        stage_4: {
            theme: "Kh·ªßng ho·∫£ng nh√¢n s·ª±, th√†nh vi√™n ·ªëm ƒëau, thi·∫øu h·ª•t ng∆∞·ªùi l√†m vi·ªác n·∫∑ng.",
            text: "<b>GIAI ƒêO·∫†N 4: KH·ª¶NG HO·∫¢NG NH√ÇN S·ª∞</b><br>L√†m vi·ªác qu√° m·ªát. 2 b·∫°n nam g√°nh v√°c vi·ªác n·∫∑ng nh·∫•t xin ph√©p ngh·ªâ ·ªëm 3 ng√†y.",
            image: "https://image2url.com/r2/default/images/1772112521057-70e3b489-cfb6-4272-8ae6-faea8e282d01.jpg",
            choices: [
                { text: "A. Tr√≠ch qu·ªπ thu√™ th·ª£ ngo√†i l√†m ti·∫øp ph·∫ßn vi·ªác n·∫∑ng.", impact: "üí∞ -1.500k | ‚è±Ô∏è -1 ng√†y", next: "stage_5", effect: { money: -1500000, time: -1, morale: 10, quality: 10 } },
                { text: "B. B·∫Øt √©p c√°c b·∫°n n·ªØ OT (L√†m th√™m gi·ªù) ƒë·ªÉ g√°nh team.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -2 ng√†y", next: "stage_5", effect: { time: -2, morale: -30 } },
                { text: "C. B·ªè b·ªõt c√°c h·∫°ng m·ª•c treo t∆∞·ªùng ph·ª©c t·∫°p ƒë·ªÉ d·ªÖ l√†m h∆°n.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_5", effect: { time: -1, morale: 5, quality: -15 } }
            ]
        },
        stage_5: {
            theme: "Gi·∫£i quy·∫øt m√¢u thu·∫´n n·ªôi b·ªô, ƒë·ªëi ph√≥ v·ªõi th√†nh vi√™n l∆∞·ªùi bi·∫øng ho·∫∑c v√¥ k·ª∑ lu·∫≠t.",
            text: "<b>GIAI ƒêO·∫†N 5: ƒêI·ªÄU PH·ªêI TH√ÄNH VI√äN</b><br>B·∫°n ph√°t hi·ªán b·∫°n T√πng ƒëang chui v√†o g√≥c b·∫•m ƒëi·ªán tho·∫°i ch∆°i game khi m·ªçi ng∆∞·ªùi ƒëang ƒë·ªï m·ªì h√¥i.",
            image: "https://image2url.com/r2/default/images/1772112558986-3662e854-5f1e-465c-a343-7ffae1569ffb.jpg",
            choices: [
                { text: "A. Qu√°t th·∫≥ng m·∫∑t T√πng tr∆∞·ªõc c·∫£ nh√≥m ƒë·ªÉ l·∫≠p l·∫°i k·ª∑ lu·∫≠t.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_6", effect: { morale: -20, quality: -5 } },
                { text: "B. K√©o T√πng ra ri√™ng h·ªèi thƒÉm, ƒë·ªïi cho T√πng l√†m vi·ªác nh·∫π.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_6", effect: { time: -1, morale: 15, quality: 10 } },
                { text: "C. L·∫≥ng l·∫∑ng l√†m b√π ph·∫ßn vi·ªác c·ªßa T√πng ƒë·ªÉ tr√°nh c√£i v√£.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_6", effect: { time: -1, morale: -15, quality: 5 } }
            ]
        },
        stage_6: {
            theme: "Ki·ªÉm tra ch·∫•t l∆∞·ª£ng ƒë·∫ßu v√†o, l·ªçc ƒë·ªì c≈©/h·ªèng c√≥ nguy c∆° g√¢y h·∫°i.",
            text: "<b>GIAI ƒêO·∫†N 6: KI·ªÇM SO√ÅT CH·∫§T L∆Ø·ª¢NG</b><br>T√° h·ªèa ph√°t hi·ªán s√°ch quy√™n g√≥p c√≥ l·∫´n l·ªôn truy·ªán b·∫°o l·ª±c, ng√¥n t√¨nh 18+ kh√¥ng h·ª£p v·ªõi tr·∫ª em.",
            image: "https://image2url.com/r2/default/images/1772112657879-d997f6ed-2c44-42a0-8468-2565dab08eac.jpg",
            choices: [
                { text: "A. ƒê√¨nh ch·ªâ vi·ªác trang tr√≠, huy ƒë·ªông to√†n b·ªô th·ª©c ƒë√™m l·ªçc s√°ch.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -3 ng√†y", next: "stage_7", effect: { time: -3, morale: -25, quality: 25 } },
                { text: "B. Mua b√°nh k·∫πo d·ª• d·ªó h·ªçc sinh l·ªõp b√™n c·∫°nh sang ng·ªìi l·ªçc ph·ª•.", impact: "üí∞ -300k | ‚è±Ô∏è -1 ng√†y", next: "stage_7", effect: { money: -300000, time: -1, morale: 5, quality: 15 } },
                { text: "C. Nh·∫Øm m·∫Øt l√†m ng∆°. S·∫Øp x·∫øp h·∫øt l√™n k·ªá cao.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_7", effect: { quality: -35 } }
            ]
        },
        stage_7: {
            theme: "X·ª≠ l√Ω s·ª± c·ªë b·∫•t kh·∫£ kh√°ng t·ª´ m√¥i tr∆∞·ªùng (M∆∞a, b√£o, c√∫p ƒëi·ªán, d·ªôt n∆∞·ªõc).",
            text: "<b>GIAI ƒêO·∫†N 7: S·ª∞ C·ªê TH·ª∞C ƒê·ªäA</b><br>B√£o v·ªÅ! M√°i t√¥n c≈© b·ªã d·ªôt m·ªôt l·ªó l·ªõn, n∆∞·ªõc ch·∫£y l√™nh l√°ng ngay gi·ªØa ph√≤ng th∆∞ vi·ªán.",
            image: "https://image2url.com/r2/default/images/1772112692249-dd7fa80a-fcb4-4a09-aae7-17d6ef35048d.jpg",
            choices: [
                { text: "A. G·ªçi ngay th·ª£ ch·ªëng th·∫•m ƒë·∫øn tr√°m m√°i nh√† tri·ªát ƒë·ªÉ.", impact: "üí∞ -1.200k | ‚è±Ô∏è -1 ng√†y", next: "stage_8", effect: { money: -1200000, time: -1 } },
                { text: "B. T·ª± mua keo silicon v√† b·∫°t ni-l√¥ng leo thang d√°n t·∫°m.", impact: "üí∞ -200k | ‚è±Ô∏è -2 ng√†y", next: "stage_8", effect: { money: -200000, time: -2, quality: -15 } },
                { text: "C. D·ªùi k·ªá ƒëi ch·ªó kh√°c, ƒë·∫∑t ch·∫≠u c√¢y ƒë·ªÉ 'H·ª©ng n∆∞·ªõc t·ª± nhi√™n'.", impact: "üí∞ -400k | ‚è±Ô∏è -2 ng√†y", next: "stage_8", effect: { money: -400000, time: -2, morale: -10, quality: 20 } }
            ]
        },
        stage_8: {
            theme: "Ki·ªÉm so√°t r√°c th·∫£i, d·ªçn d·∫πp m·∫∑t b·∫±ng ph√°t sinh chi ph√≠ d·ªçn d·∫πp.",
            text: "<b>GIAI ƒêO·∫†N 8: KI·ªÇM SO√ÅT M√îI TR∆Ø·ªúNG</b><br>ƒê·ªëng r√°c th·∫£i c√¥ng tr√¨nh ch·∫•t cao nh∆∞ n√∫i. B√°c lao c√¥ng tr∆∞·ªùng t·ª´ ch·ªëi d·ªçn.",
            image: "https://image2url.com/r2/default/images/1772112738404-3fe56192-30bd-4eb0-85ec-c737c8ec7c31.jpg",
            choices: [
                { text: "A. Tr·∫£ ti·ªÅn cho ƒë·ªôi xe r√°c chuy√™n nghi·ªáp d·ªçn s·∫°ch s·∫Ω.", impact: "üí∞ -600k | ‚è±Ô∏è 0 ng√†y", next: "stage_9", effect: { money: -600000, quality: 10 } },
                { text: "B. M∆∞·ª£n xe c√≤ng, t·ª± √® c·ªï ƒë·∫©y r√°c ra b√£i t·∫≠p k·∫øt xa 2km.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -2 ng√†y", next: "stage_9", effect: { time: -2, morale: -20 } },
                { text: "C. L√©n l√∫t d·ªìn r√°c v√†o g√≥c kho tr·ªëng v√† l·∫•y b·∫°t ph·ªß l√™n.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_9", effect: { morale: -5, quality: -25 } }
            ]
        },
        stage_9: {
            theme: "ƒê·ªëi ph√≥ v·ªõi s·ª± ki·ªÉm tra b·∫•t ng·ªù c·ªßa Ban gi√°m hi·ªáu/Thanh tra.",
            text: "<b>GIAI ƒêO·∫†N 9: ƒê·ªêI NGO·∫†I</b><br>BGH nh√† tr∆∞·ªùng b·∫•t ng·ªù c·ª≠ ƒêo√†n Thanh Tra xu·ªëng xem ti·∫øn ƒë·ªô. Ph√≤ng ·ªëc v·∫´n c√≤n l·ªôn x·ªôn.",
            image: "https://image2url.com/r2/default/images/1772112781121-03b3048b-3263-49cd-a8b2-12f647a1de9e.jpg",
            choices: [
                { text: "A. Mua tr√°i c√¢y, n∆∞·ªõc ng·ªçt m·ªùi ƒêo√†n ra ph√≤ng kh√°ch, h·ª©a h·∫πn mai xong.", impact: "üí∞ -300k | ‚è±Ô∏è -1 ng√†y", next: "stage_10", effect: { money: -300000, time: -1, morale: 5, quality: 10 } },
                { text: "B. M·∫∑c k·ªá ƒêo√†n thanh tra, c·∫£ nh√≥m v·∫´n c·∫Øm ƒë·∫ßu l√†m.", impact: "üí∞ 0ƒë | ‚è±Ô∏è 0 ng√†y", next: "stage_10", effect: { morale: -10, quality: -15 } },
                { text: "C. M·∫∑c √°o ƒêo√†n, d√µng d·∫°c thuy·∫øt tr√¨nh v·ªÅ 'Kh√¥ng gian s√°ng t·∫°o' ƒë·ªÉ ƒë√°nh l·∫°c h∆∞·ªõng.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "stage_10", effect: { time: -1, quality: 15 } }
            ]
        },
        stage_10: {
            theme: "Ch·∫°y n∆∞·ªõc r√∫t, li√™n hoan v√† chu·∫©n b·ªã l·ªÖ kh√°nh th√†nh b√†n giao.",
            text: "<b>GIAI ƒêO·∫†N 10: B√ÄN GIAO</b><br>Ng√†y mai l√† L·ªÖ Khai Gi·∫£ng! B·∫°n ch·ªâ c√≤n ƒë√∫ng m·ªôt ng√†y v√† nh·ªØng ngu·ªìn l·ª±c cu·ªëi c√πng.",
            image: "https://image2url.com/r2/default/images/1772113158873-ce999844-b304-476d-93ed-72c1a7d420db.jpg",
            choices: [
                { text: "A. Khao c·∫£ nh√≥m m·ªôt b·ªØa l·∫©u ho√†nh tr√°ng v√¨ nh·ªØng c·ª±c kh·ªï ƒë√£ qua.", impact: "üí∞ -800k | ‚è±Ô∏è 0 ng√†y", next: "calc_ending", effect: { money: -800000, morale: 60 } },
                { text: "B. √âp m·ªçi ng∆∞·ªùi ·ªü l·∫°i ƒë·∫øn 11h ƒë√™m lau ch√πi t·ª´ng h·∫°t b·ª•i.", impact: "üí∞ 0ƒë | ‚è±Ô∏è -1 ng√†y", next: "calc_ending", effect: { time: -1, morale: -20, quality: 30 } },
                { text: "C. Mua nh·ªØng ph·∫ßn qu√† nh·ªè (k·∫πo, ruy bƒÉng) ƒë·ªÉ ph√°t cho h·ªçc sinh.", impact: "üí∞ -300k | ‚è±Ô∏è 0 ng√†y", next: "calc_ending", effect: { money: -300000, morale: 10, quality: 20 } }
            ]
        },

        gameover_money:  { text: "GAME OVER: V·ª† N·ª¢ T√ÄI CH√çNH üí∏", isEnd: true, color: "var(--danger)" },
        gameover_time:   { text: "GAME OVER: TR·ªÑ DEADLINE ‚è±Ô∏è",    isEnd: true, color: "var(--danger)" },
        gameover_morale: { text: "GAME OVER: NH√ìM TAN R√É üò°",      isEnd: true, color: "var(--danger)" },
        end_bad:    { text: "K·∫æT TH√öC: D·ª∞ √ÅN T·ªíI T·ªÜ üèöÔ∏è<br>ƒê√∫ng h·∫°n, ƒë√∫ng ti·ªÅn nh∆∞ng th∆∞ vi·ªán r√°ch n√°t.", isEnd: true, color: "var(--danger)" },
        end_normal: { text: "K·∫æT TH√öC: ƒê·∫†T Y√äU C·∫¶U üëç<br>Ho√†n th√†nh an to√†n. ƒê·ªß ƒë·ªÉ ghi nh·∫≠n n·ªó l·ª±c.", isEnd: true, color: "var(--warning)" },
        end_perfect:{ text: "K·∫æT TH√öC: HUY·ªÄN THO·∫†I M√ôA H√à XANH üèÜ<br>T√†i ch√≠nh minh b·∫°ch, ƒë√∫ng ti·∫øn ƒë·ªô, th∆∞ vi·ªán tuy·ªát ƒë·∫πp!", isEnd: true, color: "var(--gold)" }
    };

    const staticEvents = [
        { title: "‚õàÔ∏è M∆ØA B√ÉO!", desc: "M∆∞a l·ªõn l√†m gi√°n ƒëo·∫°n v·∫≠t li·ªáu. Nh√≥m ngh·ªâ 1 ng√†y.", type: "bad",  effect: { time: -1, morale: -5 } },
        { title: "üí∏ M·∫§T V√ç TI·ªÄN!", desc: "M·ªôt th√†nh vi√™n ƒë√°nh r∆°i v√≠. Tr√≠ch qu·ªπ ƒë·ªÅn b√π.", type: "bad",  effect: { money: -300000, morale: -10 } },
        { title: "üßã T√ÄI TR·ª¢!",    desc: "Ph·ª• huynh mang tr√† s·ªØa ƒë·∫øn b·ªìi d∆∞·ª°ng. Anh em sung s·ª©c!", type: "good", effect: { morale: 25, quality: 5 } },
        { title: "üçÄ NH·∫∂T ƒê∆Ø·ª¢C ƒê·ªí", desc: "T√¨nh c·ªù t√¨m th·∫•y kho s√°ch c≈© c√≤n r·∫•t m·ªõi ·ªü kho nh√† tr∆∞·ªùng cho kh√¥ng nh√≥m.", type: "good", effect: { quality: 20, money: 200000 } }
    ];

    // 4. API ENGINE
    async function callGemini(promptText, retryCount = 0) {
        if (!USE_AI || apiBunker.length === 0) return null;
        if (retryCount >= apiBunker.length) { console.error("‚ùå API Error."); return null; }
        const activeKey = apiBunker[currentKeyIndex];
        try {
            const genAI = new GoogleGenerativeAI(activeKey);
            const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash", generationConfig: { responseMimeType: "application/json" } });
            const result = await model.generateContent(promptText);
            return JSON.parse(result.response.text());
        } catch (error) {
            currentKeyIndex = (currentKeyIndex + 1) % apiBunker.length;
            return callGemini(promptText, retryCount + 1);
        }
    }

    // 5. AI GENERATORS
    async function fetchAIEvent() {
        // Sinh win_rate theo range c·ªßa ƒë·ªô kh√≥ hi·ªán t·∫°i
        const range = currentDiff.winMax - currentDiff.winMin;
        const winRate = Math.floor(Math.random() * (range + 1)) + currentDiff.winMin;
        const prompt = `T·∫°o 1 s·ª± ki·ªán ƒê√ÅNH C∆Ø·ª¢C k·ªãch t√≠nh cho nh√≥m h·ªçc sinh th·ª±c hi·ªán d·ª± √°n t√¨nh nguy·ªán. KH√îNG nh·∫Øc s·ªë ti·ªÅn hay ng√†y c·ª• th·ªÉ trong m√¥ t·∫£. TR·∫¢ V·ªÄ JSON: { "event_title": "...", "event_description": "...", "gamble_choice": { "text": "...", "win_rate": ${winRate}, "win_effect": {"money": 800000, "time": 0, "morale": 20}, "lose_effect": {"money": -400000, "time": -1, "morale": -20} }, "safe_choice": { "text": "...", "effect": {"morale": -5} } }`;
        return await callGemini(prompt);
    }

    async function fetchDynamicStage(stageId) {
        const base = story[stageId];
        if (!base || !base.theme) return null;
        const stageTitle = (base.text.match(/<b>(.*?)<\/b>/) || [])[1] || "T√åNH HU·ªêNG M·ªöI";
        const historyText = usedThemes.length > 0 ? usedThemes.join(", ") : "Ch∆∞a c√≥";
        const prompt = `Vi·∫øt k·ªãch b·∫£n game: "${stageTitle}". Ch·ªß ƒë·ªÅ: ${base.theme}. LU·∫¨T: KH√îNG l·∫∑p l·∫°i: ${historyText}. L·ª±a ch·ªçn A t·ªën ti·ªÅn nhi·ªÅu nh·∫•t, B t·ªën s·ª©c/th·ªùi gian, C c√¢n b·∫±ng. QUY T·∫ÆC B·∫ÆT BU·ªòC: (1) effect.time ph·∫£i l√† s·ªë nguy√™n √¢m ƒë∆°n v·ªã NG√ÄY (v√≠ d·ª• -1, -2, -3), TUY·ªÜT ƒê·ªêI kh√¥ng d√πng tu·∫ßn hay th√°ng. (2) Trong ph·∫ßn "text" m√¥ t·∫£ t√¨nh hu·ªëng KH√îNG ƒë∆∞·ª£c nh·∫Øc ƒë·∫øn b·∫•t k·ª≥ con s·ªë tr·∫°ng th√°i n√†o (ti·ªÅn c√≤n, ng√†y c√≤n, v.v.) - ch·ªâ m√¥ t·∫£ t√¨nh hu·ªëng x·∫£y ra. (3) KH√îNG ƒë∆∞a tr∆∞·ªùng "impact" v√†o JSON. TR·∫¢ V·ªÄ JSON: { "text": "<b>${stageTitle}</b><br>[M√¥ t·∫£ t√¨nh hu·ªëng ng·∫Øn g·ªçn, kh√¥ng nh·∫Øc s·ªë li·ªáu tr·∫°ng th√°i]", "choices": [ { "text": "A. [L·ª±a ch·ªçn t·ªën ti·ªÅn]", "next": "${base.choices[0].next}", "effect": {"money": -2000000, "time": -1, "morale": 10, "quality": 15} }, { "text": "B. [L·ª±a ch·ªçn r·∫ª t·ªën s·ª©c]", "next": "${base.choices[0].next}", "effect": {"money": 0, "time": -3, "morale": -20, "quality": 5} }, { "text": "C. [L·ª±a ch·ªçn c√¢n b·∫±ng]", "next": "${base.choices[0].next}", "effect": {"money": -100000, "time": -2, "morale": -5, "quality": 20} } ] }`;
        const aiResponse = await callGemini(prompt);
        if (aiResponse) {
            aiResponse.image = base.image;
            usedThemes.push(aiResponse.text.substring(0, 50).replace(/<[^>]*>?/gm, ''));
        }
        return aiResponse;
    }

    // 6. CORE LOGIC
    function updateUI() {
        document.getElementById("money").innerText = state.money.toLocaleString('vi-VN');
        document.getElementById("time").innerText = state.time;
        document.getElementById("morale").innerText = state.morale;

        document.getElementById("money-container").className = state.money < 1000000 ? "stat-card danger" : "stat-card";
        document.getElementById("time-container").className  = state.time <= 3       ? "stat-card danger" : "stat-card";
        document.getElementById("morale-container").className = state.morale <= 30   ? "stat-card danger" : "stat-card";

        // Progress bars
        const moneyPct  = Math.max(0, Math.min(100, (state.money / 6000000) * 100));
        const timePct   = Math.max(0, Math.min(100, (state.time  / 25) * 100));
        const moralePct = Math.max(0, Math.min(100, state.morale));
        document.getElementById("money-fill").style.width  = moneyPct  + "%";
        document.getElementById("time-fill").style.width   = timePct   + "%";
        document.getElementById("morale-fill").style.width = moralePct + "%";
    }

    function updateStageDots(currentStageId) {
        const idx = stageOrder.indexOf(currentStageId);
        for (let i = 1; i <= 10; i++) {
            const dot = document.getElementById("dot-" + i);
            if (!dot) continue;
            const dotIdx = i - 1;
            dot.className = "s-dot";
            if (idx < 0) return;
            if (dotIdx < idx)  dot.classList.add("done");
            else if (dotIdx === idx) dot.classList.add("active");
        }
    }

    function checkGameOver() {
        if (state.money < 0)  return "gameover_money";
        if (state.time  < 0)  return "gameover_time";
        if (state.morale < currentDiff.moraleFloor) return "gameover_morale";
        return null;
    }

    async function handleTransition(choice, nextStageId) {
        state.money  += choice.effect.money  || 0;
        state.time   += choice.effect.time   || 0;
        state.morale += choice.effect.morale || 0;
        state.quality+= choice.effect.quality|| 0;
        updateUI();

        // Rescale money preloaded stage cho kh·ªõp state.money v·ª´a c·∫≠p nh·∫≠t
        if (dynamicStory[nextStageId]) rescalePreloadedMoney(nextStageId);

        const failScene = checkGameOver();
        if (failScene) { renderScene(failScene); return; }
        if (nextStageId === "calc_ending" || nextStageId.includes("gameover") || nextStageId.includes("end_")) { renderScene(nextStageId); return; }

        document.getElementById("loading-overlay").style.display = "flex";

        // AI EVENT: d√πng RATE_AI_EVENT (admin c√≥ th·ªÉ ch·ªânh) ho·∫∑c √©p bu·ªôc t·ª´ admin
        const triggerAiEvent = forceNextEvent || (USE_AI && Math.random() <= RATE_AI_EVENT);
        if (forceNextEvent) forceNextEvent = false;

        // STATIC EVENT: ƒë·ªôc l·∫≠p, d√πng RATE_STATIC_EVENT v√† GUARANTEE_AT t·ª´ ƒë·ªô kh√≥ hi·ªán t·∫°i
        const triggerStaticEvent = (stagesSinceStaticEvent >= GUARANTEE_AT) || (Math.random() < RATE_STATIC_EVENT);
        if (triggerStaticEvent) {
            stagesSinceStaticEvent = 0;
            pendingStaticEvent = staticEvents[Math.floor(Math.random() * staticEvents.length)];
        } else {
            stagesSinceStaticEvent++;
            pendingStaticEvent = null;
        }

        const eventPromise = triggerAiEvent ? fetchAIEvent() : Promise.resolve(null);
        // N·∫øu stage ƒë√£ ƒë∆∞·ª£c preload n·ªÅn t·ª´ renderScene ‚Üí d√πng lu√¥n, kh√¥ng fetch l·∫°i
        const stagePromise = dynamicStory[nextStageId]
            ? Promise.resolve(null)
            : fetchDynamicStage(nextStageId);
        const [aiEventData, dynamicStageData] = await Promise.all([eventPromise, stagePromise]);

        // Ch·ªâ ghi n·∫øu c√≥ data m·ªõi (preload ƒë√£ ghi r·ªìi th√¨ null)
        if (dynamicStageData) dynamicStory[nextStageId] = dynamicStageData;
        document.getElementById("loading-overlay").style.display = "none";

        if (triggerAiEvent && aiEventData) {
            showEventPopup(aiEventData, nextStageId, true);
        } else if (pendingStaticEvent) {
            const ev = pendingStaticEvent;
            pendingStaticEvent = null;
            showEventPopup(ev, nextStageId, false);
        } else {
            maybeShowHalftime(nextStageId);
        }
    }

    // Build impact pills tr·ª±c ti·∫øp t·ª´ effect object - lu√¥n kh·ªõp 100% v·ªõi s·ªë th·ª±c
    function buildPillsFromEffect(effect) {
        if (!effect) return '';
        const pills = [];
        const money = effect.money || 0;
        const time  = effect.time  || 0;

        if (money !== 0) {
            const label = money < 0
                ? `üí∞ -${Math.abs(money / 1000).toLocaleString('vi-VN')}k`
                : `üí∞ +${(money / 1000).toLocaleString('vi-VN')}k`;
            const cls = money < 0 ? 'pill pill-money-neg' : 'pill pill-money-pos';
            pills.push(`<span class="${cls}">${label}</span>`);
        } else {
            pills.push(`<span class="pill pill-free">üí∞ Mi·ªÖn ph√≠</span>`);
        }

        if (time !== 0) {
            pills.push(`<span class="pill pill-time">‚è±Ô∏è ${time} ng√†y</span>`);
        } else {
            pills.push(`<span class="pill pill-free">‚è±Ô∏è 0 ng√†y</span>`);
        }

        return pills.join('');
    }

    // Rescale money effects c·ªßa preloaded stage cho ph√π h·ª£p state.money hi·ªán t·∫°i.
    // G·ªçi SAU khi state.money ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t b·ªüi l·ª±a ch·ªçn c·ªßa ng∆∞·ªùi ch∆°i.
    // Gi·ªØ nguy√™n th·ª© b·∫≠c A > C > B v√¨ scale t·ªâ l·ªá ƒë·ªÅu. Ch·ªâ ƒë·ªông t·ªõi money √¢m.
    function rescalePreloadedMoney(stageId) {
        const scene = dynamicStory[stageId];
        if (!scene || !scene.choices) return;
        const maxCost = Math.min(...scene.choices.map(c => c.effect.money || 0));
        if (maxCost >= 0) return;                        // kh√¥ng choice n√†o t·ªën ti·ªÅn
        const budget = state.money * 0.75;               // t·ªëi ƒëa 75% ti·ªÅn hi·ªán c√≥
        if (Math.abs(maxCost) <= budget) return;         // v·∫´n trong ng∆∞·ª°ng, b·ªè qua
        const ratio = budget / Math.abs(maxCost);
        scene.choices.forEach(c => {
            if ((c.effect.money || 0) < 0)
                c.effect.money = Math.round(c.effect.money * ratio);
        });
    }

    // Scale effect √¢m theo penaltyMult c·ªßa ƒë·ªô kh√≥ hi·ªán t·∫°i (ch·ªâ cho bad events)
    function scaleBadEffect(effect) {
        const m = currentDiff.penaltyMult;
        if (m === 1.0) return effect; // B√¨nh th∆∞·ªùng: kh√¥ng thay ƒë·ªïi
        const scaled = {};
        for (const key in effect) {
            const val = effect[key];
            // Ch·ªâ scale c√°c gi√° tr·ªã √¢m (penalty), kh√¥ng ch·∫°m gi√° tr·ªã d∆∞∆°ng
            scaled[key] = (val < 0) ? Math.round(val * m) : val;
        }
        return scaled;
    }

    function showEventPopup(data, nextStageId, isAi) {
        eventsEncountered++;
        const overlay  = document.getElementById("event-overlay");
        const titleTag = document.getElementById("event-title");
        const descTag  = document.getElementById("event-desc");
        const btnBox   = document.getElementById("event-buttons");
        const winRateEl= document.getElementById("win-rate-label");
        const iconEl   = document.getElementById("event-icon");
        const resultEl = document.getElementById("gamble-result");

        btnBox.innerHTML = "";
        resultEl.style.display = "none";
        resultEl.className = "";
        winRateEl.style.display = "none";

        // Reset tint
        overlay.className = "";

        if (isAi) {
            overlay.classList.add("tint-gamble");
            iconEl.innerText = "üé≤";
            titleTag.innerText = data.event_title;
            titleTag.style.color = "var(--warning)";
            descTag.innerHTML = `<i>${data.event_description}</i>`;
            winRateEl.style.display = "inline-block";
            winRateEl.innerText = `üéØ T·ªâ l·ªá th·∫Øng: ${data.gamble_choice.win_rate}%`;

            const btnLieu = document.createElement("button");
            btnLieu.className = "event-btn gamble-fire";
            btnLieu.innerHTML = `üî• ${data.gamble_choice.text}`;
            btnLieu.onclick = () => {
                btnLieu.disabled = true;
                btnLieu.parentElement.querySelectorAll('button').forEach(b => b.disabled = true);
                const roll = Math.floor(Math.random() * 100) + 1;
                const win  = roll <= data.gamble_choice.win_rate;
                resultEl.style.display = "block";
                resultEl.className = win ? "win" : "lose";
                document.getElementById("gr-icon").innerText = win ? "üéâ" : "üíÄ";
                document.getElementById("gr-text").innerText  = win ? "ƒê·∫†I TH·∫ÆNG! V·∫≠n may ƒë·ª©ng v·ªÅ ph√≠a b·∫°n!" : "THUA S·∫†CH! V·∫≠n r·ªßi ƒë√£ ·∫≠p ƒë·∫øn...";
                // T·ª± ƒë·ªông ƒë√≥ng v√† ti·∫øp t·ª•c sau 1.8s
                setTimeout(() => {
                    applyEffectAndNext(win ? data.gamble_choice.win_effect : data.gamble_choice.lose_effect, nextStageId);
                }, 1800);
            };

            const btnSafe = document.createElement("button");
            btnSafe.className = "event-btn gamble-safe";
            btnSafe.innerHTML = `üõ°Ô∏è ${data.safe_choice.text}`;
            btnSafe.onclick = () => applyEffectAndNext(data.safe_choice.effect, nextStageId);

            btnBox.appendChild(btnLieu);
            btnBox.appendChild(btnSafe);

        } else {
            const isBad = data.type === "bad";
            overlay.classList.add(isBad ? "tint-bad" : "tint-good");
            iconEl.innerText = isBad ? "‚ö†Ô∏è" : "‚ú®";
            titleTag.innerText = data.title;
            titleTag.style.color = isBad ? "var(--danger)" : "var(--success)";
            descTag.innerText = data.desc;

            if (isBad) {
                document.getElementById("game-container").classList.add("shake");
                setTimeout(() => document.getElementById("game-container").classList.remove("shake"), 500);
            }

            // √Åp d·ª•ng penalty multiplier cho s·ª± c·ªë x·∫•u theo ƒë·ªô kh√≥
            const scaledEffect = isBad ? scaleBadEffect(data.effect) : data.effect;

            const btnOk = document.createElement("button");
            btnOk.className = "event-btn event-btn-full";
            btnOk.style.borderColor = isBad ? "rgba(248,113,113,0.4)" : "rgba(74,222,128,0.4)";
            btnOk.style.color = isBad ? "var(--danger)" : "var(--success)";
            btnOk.innerHTML = isBad ? "üò§ Ch·∫•p nh·∫≠n v√† ti·∫øp t·ª•c" : "üôå Tuy·ªát v·ªùi! Ti·∫øp t·ª•c th√¥i";
            btnOk.onclick = () => applyEffectAndNext(scaledEffect, nextStageId);
            btnBox.appendChild(btnOk);
        }

        overlay.style.display = "flex";
    }

    function applyEffectAndNext(effect, nextStageId) {
        state.money  += effect.money  || 0;
        state.time   += effect.time   || 0;
        state.morale += effect.morale || 0;
        state.quality+= effect.quality|| 0;
        updateUI();
        document.getElementById("event-overlay").style.display = "none";

        const fail = checkGameOver();
        if (fail) { renderScene(fail); return; }

        if (pendingStaticEvent) {
            const ev = pendingStaticEvent;
            pendingStaticEvent = null;
            showEventPopup(ev, nextStageId, false);
        } else {
            maybeShowHalftime(nextStageId);
        }
    }

    function maybeShowHalftime(nextStageId) {
        if (nextStageId === "stage_6" && !halftimeSeen) {
            halftimeSeen = true;
            showHalftime(nextStageId);
        } else {
            renderScene(nextStageId);
        }
    }

    function showHalftime(nextStageId) {
        const quotes = [
            "\"Ng∆∞·ªùi qu·∫£n l√Ω gi·ªèi kh√¥ng ph·∫£i ng∆∞·ªùi kh√¥ng bao gi·ªù sai, m√† l√† ng∆∞·ªùi h·ªçc ƒë∆∞·ª£c t·ª´ sai l·∫ßm.\"",
            "\"Ngu·ªìn l·ª±c h·ªØu h·∫°n, nh∆∞ng s·ª± s√°ng t·∫°o th√¨ v√¥ h·∫°n.\"",
            "\"M·ªôt t·∫≠p th·ªÉ ƒëo√†n k·∫øt c√≥ th·ªÉ v∆∞·ª£t qua b·∫•t k·ª≥ kh√≥ khƒÉn n√†o.\"",
            "\"Khi √°p l·ª±c tƒÉng, b·∫£n lƒ©nh c·ªßa ng∆∞·ªùi l√£nh ƒë·∫°o m·ªõi th·ª±c s·ª± ƒë∆∞·ª£c th·ªÉ hi·ªán.\""
        ];
        document.getElementById("ht-money").innerText  = state.money.toLocaleString('vi-VN') + "ƒë";
        document.getElementById("ht-time").innerText   = state.time + " ng√†y";
        document.getElementById("ht-morale").innerText = state.morale + "%";
        document.getElementById("ht-quality").innerText= state.quality + " ƒëi·ªÉm";
        document.getElementById("ht-quote").innerText  = quotes[Math.floor(Math.random() * quotes.length)];
        document.getElementById("halftime-overlay").style.display = "flex";
        document.getElementById("halftime-continue").onclick = () => {
            document.getElementById("halftime-overlay").style.display = "none";
            renderScene(nextStageId);
        };
    }

    function renderScene(sceneId) {
        if (sceneId === "calc_ending") {
            const fail = checkGameOver();
            if (fail) sceneId = fail;
            else {
                if      (state.quality < currentDiff.qualityBad)  sceneId = "end_bad";
                else if (state.quality < currentDiff.qualityGood) sceneId = "end_normal";
                else                                               sceneId = "end_perfect";
            }
        }

        // Update stage dots
        updateStageDots(sceneId);

        const scene = dynamicStory[sceneId] || story[sceneId];
        const storyEl = document.getElementById("story-text");
        storyEl.innerHTML = scene.text;
        storyEl.classList.remove("fade-in");
        void storyEl.offsetWidth;
        storyEl.classList.add("fade-in");

        const choicesDiv = document.getElementById("choices");
        choicesDiv.innerHTML = "";

        const imgContainer = document.getElementById("image-container");
        if (scene.image) {
            document.getElementById("scene-image").src = scene.image;
            imgContainer.style.display = "block";
        } else {
            imgContainer.style.display = "none";
        }

        if (scene.isEnd || (story[sceneId] && story[sceneId].isEnd)) {
            showEndScreen(sceneId);
        } else {
            const labels = ['A', 'B', 'C', 'D'];
            scene.choices.forEach((choice, i) => {
                const btn = document.createElement("button");
                btn.className = "choice-btn fade-in";
                btn.style.animationDelay = (i * 0.07) + "s";

                // Build pills t·ª´ effect th·ª±c - lu√¥n ƒë√∫ng, kh√¥ng ph·ª• thu·ªôc chu·ªói AI
                const pillsHtml = buildPillsFromEffect(choice.effect);

                btn.innerHTML = `
                    <div class="choice-badge">${labels[i] || (i+1)}</div>
                    <div class="choice-body">
                        <div class="choice-text">${choice.text}</div>
                        <div class="choice-pills">${pillsHtml}</div>
                    </div>`;
                btn.onclick = () => handleTransition(choice, choice.next);
                choicesDiv.appendChild(btn);
            });

            // Scroll to top of game container smoothly
            document.getElementById("game-container").scrollTo({ top: 0, behavior: 'smooth' });

            // Preload n·ªÅn: stage ti·∫øp theo lu√¥n gi·ªëng nhau cho c·∫£ 3 l·ª±a ch·ªçn
            // B·∫Øt ƒë·∫ßu fetch NGAY sau khi render xong ƒë·ªÉ ng∆∞·ªùi ch∆°i ƒëang ƒë·ªçc = th·ªùi gian ch·ªù ·∫©n
            const nextId = scene.choices[0].next;
            if (nextId && story[nextId] && story[nextId].theme && !dynamicStory[nextId]) {
                fetchDynamicStage(nextId).then(data => {
                    // Ch·ªâ l∆∞u n·∫øu ch∆∞a c√≥ (tr√°nh ghi ƒë√® n·∫øu handleTransition fetch song song)
                    if (data && !dynamicStory[nextId]) dynamicStory[nextId] = data;
                });
            }
        }
    }

    function showEndScreen(sceneId) {
        const configs = {
            gameover_money:  { badge: "üí∏", title: "V·ª† N·ª¢ T√ÄI CH√çNH",         subtitle: "Qu·ªπ d·ª± √°n v·ªÅ 0. T·∫•t c·∫£ m·ªçi th·ª© d·ª´ng l·∫°i.", color: "var(--danger)", image: "" },
            gameover_time:   { badge: "‚è±Ô∏è", title: "TR·ªÑ DEADLINE",             subtitle: "Kh√¥ng k·ªãp L·ªÖ Khai Gi·∫£ng. D·ª± √°n b·ªã h·ªßy b·ªè.", color: "var(--danger)", image: "" },
            gameover_morale: { badge: "üò°", title: "NH√ìM TAN R√É",               subtitle: "Tinh th·∫ßn ki·ªát s·ª©c. C√°c th√†nh vi√™n t·ª± r·ªùi ƒëi.", color: "var(--danger)", image: "" },
            end_bad:         { badge: "üèöÔ∏è", title: "D·ª∞ √ÅN T·ªíI T·ªÜ",            subtitle: "ƒê√∫ng h·∫°n, ƒë√∫ng ti·ªÅn, nh∆∞ng th∆∞ vi·ªán r√°ch n√°t. C√°c l·ªëi t·∫Øt ƒë·ªÅu ph·∫£i tr·∫£ gi√°.", color: "var(--danger)", image: "" },
            end_normal:      { badge: "üëç", title: "HO√ÄN TH√ÄNH ƒê·∫†T Y√äU C·∫¶U",   subtitle: "An to√†n. ƒê·ªß ƒë·ªÉ ghi nh·∫≠n n·ªó l·ª±c ch√¢n th√†nh c·ªßa t·∫≠p th·ªÉ.", color: "var(--warning)", image: "" },
            end_perfect:     { badge: "üèÜ", title: "HUY·ªÄN THO·∫†I M√ôA H√à XANH", subtitle: "T√†i ch√≠nh minh b·∫°ch, ƒë√∫ng ti·∫øn ƒë·ªô, th∆∞ vi·ªán tuy·ªát ƒë·∫πp. T√™n b·∫°n s·∫Ω ƒë∆∞·ª£c nh·ªõ m√£i!", color: "var(--gold)", image: "https://image2url.com/r2/default/images/1772112817266-5f9fc691-f09e-4873-abc7-9442385c9f6b.jpg" }
        };
        const cfg = configs[sceneId] || { badge: "üéØ", title: "K·∫æT TH√öC", subtitle: "", color: "var(--gold)", image: "" };

        document.getElementById("end-badge").innerText = cfg.badge;
        const titleEl = document.getElementById("end-title");
        titleEl.innerText = cfg.title;
        titleEl.style.color = cfg.color;
        document.getElementById("end-subtitle").innerText = cfg.subtitle;
        
        // H√åNH ·∫¢NH M√ÄN H√åNH ENDING
        const endImgContainer = document.getElementById("end-image-container");
        const endImg = document.getElementById("end-image");
        const finalImage = cfg.image || (story[sceneId] && story[sceneId].image) || "";
        
        if (finalImage) {
            endImg.src = finalImage;
            endImgContainer.style.display = "block";
        } else {
            endImgContainer.style.display = "none";
        }

        document.getElementById("end-money").innerText   = Math.max(0, state.money).toLocaleString('vi-VN') + "ƒë";
        document.getElementById("end-time").innerText    = Math.max(0, state.time) + " ng√†y";
        document.getElementById("end-morale").innerText  = state.morale + "%";
        document.getElementById("end-quality").innerText = state.quality + " ƒëi·ªÉm";
        document.getElementById("end-events").innerText  = eventsEncountered + " l·∫ßn";

        // Color morale based on value
        const moraleEl = document.getElementById("end-morale");
        moraleEl.style.color = state.morale <= 30 ? "var(--danger)" : state.morale >= 80 ? "var(--success)" : "var(--warning)";
        
        // KI·ªÇM TRA ƒêI·ªÄU KI·ªÜN HI·ªÜN D√íNG CH·ªÆ SECRET ENDING
        const secretHint = document.getElementById("secret-hint");
        if (sceneId === "end_perfect") {
            secretHint.style.display = "block";
        } else {
            secretHint.style.display = "none";
        }

        document.getElementById("end-screen").style.display = "flex";
    }

    async function initGame() {
        // √Åp d·ª•ng c·∫•u h√¨nh ƒë·ªô kh√≥ v√†o state v√† rate variables
        state.money   = currentDiff.money;
        state.time    = currentDiff.time;
        state.morale  = currentDiff.morale;
        state.quality = 0;
        RATE_AI_EVENT     = currentDiff.rateAI;
        RATE_STATIC_EVENT = currentDiff.rateStatic;
        GUARANTEE_AT      = currentDiff.guaranteeAt;

        updateUI();
        updateStageDots('start');
        const loading = document.getElementById("loading-overlay");
        document.getElementById("loading-text").innerText = "KH·ªûI T·∫†O V≈® TR·ª§...";
        loading.style.display = "flex";

        const dynamicData = await fetchDynamicStage("start");
        if (dynamicData) dynamicStory["start"] = dynamicData;

        loading.style.display = "none";
        renderScene("start");
    }

</script>
</body>
</html>
